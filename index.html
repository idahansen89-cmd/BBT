<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BBT & LH</title>
<link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
<style>
:root{
  --pink:#f4b6c2; --pink-hover:#e599ab; --text:#333; --line:#eee;
  --mens-bg:#ffe6ec; --luteal-bg:#f2e6ff;
}
*{box-sizing:border-box;}
body{font-family:"Helvetica Neue",Arial,sans-serif;background:#fff;color:var(--text);margin:0;padding:0;}
h1{text-align:center;margin:1rem 0;}
.tabs{display:flex;justify-content:center;gap:.4rem;border-bottom:2px solid #ddd;padding-bottom:.4rem;}
.tab{padding:.7rem 1.2rem;border:none;border-radius:8px 8px 0 0;background:#f4f4f4;font-weight:600;cursor:pointer;}
.tab.active{background:#fff;border-bottom:2px solid #fff;color:#e06b8f;}
.tab-content{display:none;max-width:820px;margin:1rem auto;padding:1rem;border:1px solid var(--line);border-radius:12px;background:#fff;}
.tab-content.active{display:block;}
.form-row{display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem;}
.form-row label{width:160px;font-weight:600;}
.form-row input,.form-row select,.form-row textarea{flex:1;padding:.45rem .6rem;border:1px solid #ccc;border-radius:8px;font-size:.95rem;}
textarea{resize:vertical;min-height:56px;}
.inline-symbols{display:flex;align-items:center;gap:1rem;margin:.4rem 0 .6rem;}
.inline-symbols .symbol{display:inline-flex;align-items:center;gap:.4rem;font-size:1.15rem;}
.button{background:var(--pink);color:#222;border:none;border-radius:8px;padding:.55rem 1.1rem;font-weight:700;cursor:pointer;}
.button:hover{background:var(--pink-hover);}
.table-wrap{overflow-x:auto;margin-top:1rem;}
table{width:100%;border-collapse:collapse;}
th,td{padding:.55rem;border:1px solid #ddd;text-align:center;}
tr.mens-row{background:#ffe5ec;}
.top-buttons{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.3rem;margin-bottom:.4rem;}
.chart-toolbar{display:flex;justify-content:center;margin-top:.75rem;}
.lh-toolbar{display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap;}
.lh-symbols-row{display:flex;align-items:center;flex-wrap:wrap;gap:.8rem;margin:.6rem 0;}
.lh-spacer{flex:1 1 auto;}
.lh-timepair{display:flex;align-items:center;gap:.8rem;margin-left:auto;}
.lh-symbol-checkbox{display:inline-block;text-align:center;font-size:1.3rem;line-height:1.2;}
.lh-symbol-checkbox small{display:block;color:#777;font-size:.75rem;margin-top:.15rem;}
.lh-row{display:flex;align-items:flex-start;justify-content:space-between;gap:.6rem;padding:.5rem 0;border-bottom:1px solid #eee;}
.lh-img{width:100%;max-height:120px;object-fit:contain;border-radius:8px;background:#fff;}
.lh-info{flex:1;}
#chartContainer{display:block;border:none;}
canvas#bbtChart{display:block;width:100%!important;height:100%!important;}
</style>
</head>
<body>
<h1>BBT & LH</h1>

<div class="tabs">
  <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
  <button class="tab" data-tab="graf">ğŸ“ˆ Graf</button>
  <button class="tab" data-tab="lh">ğŸ§ª LH-test</button>
</div>

<!-- === Inmatning & Tabell === -->
<div id="inmatning" class="tab-content active">
  <div class="form-row"><label for="date">Datum:</label><input type="date" id="date"></div>
  <div class="form-row"><label for="time">Tid (BBT):</label><input type="time" id="time"></div>
  <div class="form-row"><label for="actual">Faktisk temp (Â°C):</label><input type="number" step="0.01" id="actual"></div>
  <div class="form-row"><label for="corrected">Korrigerad temp (Â°C):</label><input type="number" step="0.01" id="corrected" placeholder="BerÃ¤knas auto"></div>
  <div class="form-row"><label for="mens">Mensstatus:</label><select id="mens"><option>â€“</option><option>Mens</option></select></div>
  <div class="form-row"><label for="mucus">Sekret:</label><select id="mucus"><option>â€“</option><option>Klart</option><option>Ã„ggviteliknande</option><option>KrÃ¤mig</option></select></div>
  <div class="form-row"><label for="lhSel">LH-test:</label><select id="lhSel"><option>â€“</option><option>Positivt</option><option>Negativt</option></select></div>

  <div class="inline-symbols">
    <span class="symbol" title="Samlag">ğŸ’ <input type="checkbox" id="sex"></span>
    <span class="symbol" title="BekrÃ¤ftad Ã¤gglossning">ğŸŒ¼ <input type="checkbox" id="ovulation"></span>
  </div>

  <div class="form-row" style="align-items:flex-start"><label for="note">Anteckning:</label><textarea id="note"></textarea></div>

  <div class="top-buttons">
    <button class="button" id="saveBtn">Spara</button>
    <button class="button" id="exportBtn">Exportera data</button>
    <button class="button" id="importBtn">Importera data</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
  </div>

  <div class="table-wrap">
    <table id="dataTable">
      <thead><tr><th>Datum</th><th>Tid</th><th>Faktisk</th><th>Korr</th><th>Mens</th><th>Sekret</th><th>LH</th><th>ğŸ’</th><th>ğŸŒ¼</th><th>Anteckning</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="text-align:center;margin-top:1rem;">
    <button class="button danger" id="clearBtn">Rensa all data</button>
  </div>
</div>

<!-- === Graf === -->
<div id="graf" class="tab-content">
  <div id="chartContainer" style="width:100%;max-width:1200px;height:520px;margin:auto;overflow:hidden;position:relative;">
    <canvas id="bbtChart" width="1200" height="520"></canvas>
  </div>
  <div class="chart-toolbar"><button class="button" id="exportChartBtn">Exportera graf</button></div>
</div>

<!-- === LH-test === -->
<div id="lh" class="tab-content">
  <div class="lh-toolbar">
    <div style="display:flex;gap:.5rem;align-items:center">
      <button class="button" id="lhPickBtn">VÃ¤lj bild</button>
      <input type="file" id="lhFile" accept="image/*" style="display:none">
    </div>
    <input type="date" id="lhDate">
  </div>

  <div class="lh-symbols-row">
    <label class="lh-symbol-checkbox">ğŸ©·<small>N</small><br><input type="checkbox" class="lhSym" value="ğŸ©·"></label>
    <label class="lh-symbol-checkbox">â¤ï¸<small>T</small><br><input type="checkbox" class="lhSym" value="â¤ï¸"></label>
    <label class="lh-symbol-checkbox">ğŸ’œ<small>H</small><br><input type="checkbox" class="lhSym" value="ğŸ’œ"></label>
    <label class="lh-symbol-checkbox">ğŸ’™<small>L</small><br><input type="checkbox" class="lhSym" value="ğŸ’™"></label>
    <label class="lh-symbol-checkbox">ğŸ’š<small>â€“</small><br><input type="checkbox" class="lhSym" value="ğŸ’š"></label>
    <label class="lh-symbol-checkbox">ğŸ’›<small>?</small><br><input type="checkbox" class="lhSym" value="ğŸ’›"></label>
    <span class="lh-spacer"></span>
    <div class="lh-timepair">
      <label class="lh-symbol-checkbox">â˜€ï¸<small>FM</small><br><input type="checkbox" id="lhAM"></label>
      <label class="lh-symbol-checkbox">ğŸŒ™<small>EM</small><br><input type="checkbox" id="lhPM"></label>
    </div>
  </div>

  <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem">
    <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
    <button class="button" id="lhSaveBtn">Spara</button>
  </div>
  <div id="lhList"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
/* === Tabbar === */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id=btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(id).classList.add('active');
    if(id==='graf')renderChart();
    if(id==='lh')renderLHList();
  });
});

/* === Element === */
const el={
  date:date,time:time,actual:actual,corrected:corrected,mens:mens,mucus:mucus,lhSel:lhSel,
  sex:sex,ovulation:ovulation,note:note,
  saveBtn:saveBtn,exportBtn:exportBtn,importBtn:importBtn,importFile:importFile,clearBtn:clearBtn,
  dataTableBody:document.querySelector('#dataTable tbody'),chartCanvas:document.getElementById('bbtChart'),
  exportChartBtn:exportChartBtn,
  lhPickBtn:lhPickBtn,lhFile:lhFile,lhDate:lhDate,lhNote:lhNote,lhSaveBtn:lhSaveBtn,lhList:lhList,
  lhSymChecks:()=>Array.from(document.querySelectorAll('.lhSym:checked')),lhAM:lhAM,lhPM:lhPM
};
let dataEntries=JSON.parse(localStorage.getItem('bbtData')||'[]');
let lhEntries=JSON.parse(localStorage.getItem('lhData')||'[]');
let chart;

/* === HjÃ¤lpare fÃ¶r temp-korrigering === */
function minutesFrom0400(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return(h*60+m)-240;}
function computeCorrectedFrom(a,timeStr){if(Number.isNaN(a))return null;const mins=minutesFrom0400(timeStr||'04:00');const corr=a-0.05*(mins/30);return Number(corr.toFixed(2));}
function computeCorrectedFormInputs(){const a=parseFloat(el.actual.value);if(Number.isNaN(a))return;const corr=computeCorrectedFrom(a,el.time.value);if(corr!==null)el.corrected.value=corr.toFixed(2);}

/* === Spara BBT-post === */
function saveEntry(){
  const e={date:el.date.value,time:el.time.value,actual:el.actual.value?Number(el.actual.value):null,
  corrected:el.corrected.value?Number(el.corrected.value):null,mens:el.mens.value,mucus:el.mucus.value,
  lh:el.lhSel.value,sex:el.sex.checked,ovulation:el.ovulation.checked,note:el.note.value};
  if(!e.date)return alert('VÃ¤lj datum.');
  const i=dataEntries.findIndex(x=>x.date===e.date);if(i>=0)dataEntries[i]=e;else dataEntries.push(e);
  localStorage.setItem('bbtData',JSON.stringify(dataEntries));renderTable();
}
el.saveBtn.addEventListener('click',saveEntry);
el.actual.addEventListener('blur',computeCorrectedFormInputs);
el.time.addEventListener('change',()=>{if(el.actual.value)computeCorrectedFormInputs();});

/* === Tabell === */
function renderTable(){
  el.dataTableBody.innerHTML='';
  dataEntries.sort((a,b)=>a.date.localeCompare(b.date));
  dataEntries.forEach((e,idx)=>{
    const tr=document.createElement('tr');
    if(e.mens==='Mens')tr.classList.add('mens-row');
    tr.innerHTML=`<td>${e.date||''}</td><td contenteditable="true">${e.time||''}</td><td contenteditable="true">${e.actual??''}</td>
    <td>${e.corrected??''}</td><td contenteditable="true">${e.mens||'â€“'}</td><td contenteditable="true">${e.mucus||'â€“'}</td>
    <td contenteditable="true">${e.lh||'â€“'}</td><td>${e.sex?'ğŸ’':''}</td><td>${e.ovulation?'ğŸŒ¼':''}</td><td contenteditable="true">${e.note||''}</td>`;
    tr.querySelectorAll('[contenteditable="true"]').forEach(td=>{
      td.addEventListener('keydown',ev=>{if(ev.key==='Enter'){ev.preventDefault();td.blur();}});
      td.addEventListener('blur',()=>{const field=td.cellIndex;const val=td.textContent.trim();const row=dataEntries[idx];
        if(field===1){row.time=val;if(row.actual)row.corrected=computeCorrectedFrom(row.actual,row.time);}
        if(field===2){const n=parseFloat(val.replace(',','.'));row.actual=isNaN(n)?null:n;if(row.actual)row.corrected=computeCorrectedFrom(row.actual,row.time);}
        if(field===4)row.mens=val||'â€“';if(field===5)row.mucus=val||'â€“';if(field===6)row.lh=val||'â€“';if(field===9)row.note=val;
        localStorage.setItem('bbtData',JSON.stringify(dataEntries));});
    });
    el.dataTableBody.appendChild(tr);
  });
}
renderTable();

/* === Graf === */
function renderChart(){
  if(chart)chart.destroy();
  dataEntries.sort((a,b)=>a.date.localeCompare(b.date));
  const labels=dataEntries.map(e=>{if(!e.date)return"";const[y,m,d]=e.date.split('-');return`${d}-${m}`;});
  const actual=dataEntries.map(e=>e.actual);
  const corrected=dataEntries.map(e=>e.corrected);
  chart=new Chart(el.chartCanvas,{type:'line',
    data:{labels,datasets:[
      {label:'Faktisk temperatur',data:actual,borderColor:'#3b82f6',backgroundColor:'#3b82f6',pointRadius:3,tension:0.25,spanGaps:true},
      {label:'Korrigerad temperatur',data:corrected,borderColor:'#ef4444',backgroundColor:'#ef4444',borderDash:[4,4],pointRadius:2,tension:0.25,spanGaps:true}
    ]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:34.9,max:38.6,ticks:{stepSize:0.1,color:'#000'}},x:{ticks:{color:'#000'}}},
      plugins:{legend:{position:'bottom',labels:{color:'#000'}}},animation:false}});
}

/* === LH-hantering === */
el.lhPickBtn.addEventListener('click',()=>el.lhFile.dispatchEvent(new MouseEvent('click',{bubbles:true})));
function updateLHPreview(){
  let wrap=document.getElementById('lhPreviewWrap');if(wrap)wrap.remove();
  const file=el.lhFile.files&&el.lhFile.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    wrap=document.createElement('div');wrap.id='lhPreviewWrap';wrap.style='display:flex;align-items:center;gap:.5rem;margin:.4rem 0;';
    const img=document.createElement('img');img.src=ev.target.result;img.style='width:70px;height:50px;object-fit:cover;border-radius:6px;';
    const info=document.createElement('div');info.id='lhPreviewInfo';info.style='font-size:.8rem;color:#444;';
    wrap.appendChild(img);wrap.appendChild(info);
    document.querySelector('.lh-toolbar').after(wrap);
    refreshPreviewInfo();
  };
  r.readAsDataURL(file);
}
function refreshPreviewInfo(){
  const info=document.getElementById('lhPreviewInfo');if(!info)return;
  const date=el.lhDate.value||'(Datum ej valt)';
  const syms=el.lhSymChecks().map(x=>x.value).join(' ')||'â€“';
  const note=el.lhNote.value?`"${el.lhNote.value}"`:'';
  info.innerHTML=`<div><strong>${date}</strong></div><div style="font-size:1rem;margin:.1rem 0;">${syms}</div><div>${note}</div>`;
}
el.lhFile.addEventListener('change',updateLHPreview);
['change','input'].forEach(e=>{el.lhDate.addEventListener(e,refreshPreviewInfo);el.lhNote.addEventListener(e,refreshPreviewInfo);});
document.querySelectorAll('.lhSym').forEach(cb=>cb.addEventListener('change',refreshPreviewInfo));

/* === Spara LH === */
el.lhSaveBtn.addEventListener('click',()=>{
  const file=el.lhFile.files&&el.lhFile.files[0];
  if(!file){alert('ğŸ“¸ VÃ¤lj en bild fÃ¶rst.');return;}
  if(!el.lhDate.value){alert('ğŸ“… VÃ¤lj datum.');return;}
  try{
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const dataUrl=e.target.result;
        const symbols=el.lhSymChecks().map(x=>x.value);
        const note=el.lhNote.value||'';
        const am=el.lhAM.checked,pm=el.lhPM.checked;
        const newEntry={date:el.lhDate.value,symbols,note,am,pm,dataUrl};
        lhEntries.push(newEntry);
        localStorage.setItem('lhData',JSON.stringify(lhEntries));
        renderLHList();
        el.lhNote.value='';el.lhFile.value='';el.lhAM.checked=false;el.lhPM.checked=false;
        document.querySelectorAll('.lhSym').forEach(cb=>cb.checked=false);
        const prev=document.getElementById('lhPreviewWrap');if(prev)prev.remove();
        alert('âœ… Bilden har sparats!');
      }catch(err){console.error('Fel i reader.onload',err);alert('ğŸš« Ett ovÃ¤ntat fel uppstod vid sparning.');}
    };
    reader.onerror=err=>{console.error('FileReader-fel',err);alert('ğŸš« Kunde inte lÃ¤sa in bilden.');};
    reader.readAsDataURL(file);
  }catch(err){console.error('Yttre fel',err);alert('ğŸš« NÃ¥got gick fel vid bilduppladdningen.');}
});

/* === Lista === */
function renderLHList(){
  el.lhList.innerHTML='';
  lhEntries.sort((a,b)=>a.date.localeCompare(b.date));
  lhEntries.forEach((e,i)=>{
    const row=document.createElement('div');row.className='lh-row';
    row.innerHTML=`<div style="flex:0 0 38%"><img class="lh-img" src="${e.dataUrl}" alt="LH-bild"></div>
      <div class="lh-info"><div style="font-weight:700">${e.date||''} ${e.am?'â˜€ï¸':''} ${e.pm?'ğŸŒ™':''}</div>
      <div style="font-size:1.15rem;margin:.15rem 0;">${(e.symbols||[]).join(' ')}</div>
      <div style="font-size:.9rem;color:#555">${e.note||''}</div></div>
      <div><button class="button danger" data-del="${i}">Ta bort</button></div>`;
    row.querySelector('[data-del]').addEventListener('click',()=>{lhEntries.splice(i,1);localStorage.setItem('lhData',JSON.stringify(lhEntries));renderLHList();});
    el.lhList.appendChild(row);
  });
}
renderLHList();
});
</script>
</body>
</html>