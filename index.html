<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBT & LH</title>
  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
 <style>
  :root {
    --pink: #f4b6c2;
    --pink-hover: #e599ab;
    --text: #333;
    --line: #eee;
  }

  * { box-sizing: border-box; }
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    color: var(--text);
    background: #fff;
  }
  h1 { text-align: center; margin: 1rem 0; }

  /* ===== Tabs ===== */
  .tabs {
    display: flex;
    justify-content: center;
    gap: 0.4rem;
    border-bottom: 2px solid #ddd;
    padding-bottom: 0.4rem;
  }
  .tab {
    padding: 0.7rem 1.2rem;
    border: none;
    border-radius: 8px 8px 0 0;
    background: #f4f4f4;
    font-weight: 600;
    cursor: pointer;
  }
  .tab.active {
    background: #fff;
    border-bottom: 2px solid #fff;
    color: #e06b8f;
  }

  .tab-content {
    display: none;
    max-width: 820px;
    margin: 1rem auto;
    padding: 1rem;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: #fff;
  }
  .tab-content.active { display: block; }

  /* ===== Form ===== */
  .form-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 0.6rem;
  }
  .form-row label {
    width: 160px;
    font-weight: 600;
  }
  .form-row input,
  .form-row select,
  .form-row textarea {
    flex: 1;
    padding: 0.45rem 0.6rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 0.95rem;
  }
  textarea { resize: vertical; min-height: 56px; }

  .inline-symbols {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 0.4rem 0 0.6rem;
    flex-wrap: wrap;
  }
  .inline-symbols .symbol {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 1.1rem;
  }

  /* ===== Buttons ===== */
  .button {
    background: var(--pink);
    color: #222;
    border: none;
    border-radius: 8px;
    padding: 0.55rem 1.1rem;
    font-weight: 700;
    cursor: pointer;
  }
  .button:hover { background: var(--pink-hover); }
  .button.danger:hover { background: var(--pink-hover); }

  /* ===== Kompakt och snygg tabell ===== */
  .table-wrap {
    overflow-x: auto;
    margin-top: 1rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 0.9rem;
  }
  th, td {
    padding: 0.5rem 0.4rem;
    border: 1px solid #ddd;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
    vertical-align: middle;
  }
  thead th {
    background: #fdf5f7;
    color: #444;
    font-weight: 700;
  }
  tbody tr:nth-child(even) { background-color: #f9f9f9; }

  /* Rosa bakgrund fÃ¶r mens */
  tbody tr.mens-row {
    background-color: #ffeaf0 !important;
  }

  /* Datum och tid */
  th:nth-child(1), td:nth-child(1) { width: 85px; }
  th:nth-child(2), td:nth-child(2) { width: 70px; }

  /* Temperaturkolumner */
  th:nth-child(3), td:nth-child(3),
  th:nth-child(4), td:nth-child(4) { width: 70px; }

  /* Sekret */
  th:nth-child(5), td:nth-child(5) { width: 85px; }

  /* HÃ¤ndelser (ğŸ’ğŸŒ¼ğŸ©¸) */
  th:nth-child(6), td:nth-child(6) {
    width: 90px;
    font-size: 1.1rem;
    letter-spacing: 2px;
  }

  /* Anteckning */
  th:nth-child(7), td:nth-child(7) {
    width: 150px;
    text-align: left;
  }

  /* Knappar */
  th:nth-child(8), td:nth-child(8) {
    width: 70px;
    text-align: center;
  }
  .table-btn {
    border: none;
    background: var(--pink);
    border-radius: 6px;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
  }
  .table-btn:hover { background: var(--pink-hover); }

  /* ===== Chart ===== */
  #chartContainer {
    width: 100%;
    max-width: 1200px;
    height: 520px;
    margin: auto;
    overflow: hidden;
    position: relative;
  }
  #bbtChart {
    display: block;
    width: 100% !important;
    height: 100% !important;
  }
  .chart-toolbar { display: flex; justify-content: center; margin-top: 0.75rem; }

  /* ===== LH-flik ===== */
  .lh-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.6rem;
    flex-wrap: wrap;
  }
  .lh-symbols-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    align-items: center;
  }
  .lh-symbol-checkbox {
    display: inline-block;
    text-align: center;
    font-size: 1.25rem;
    line-height: 1.15;
  }
  .lh-symbol-checkbox small {
    display: block;
    color: #777;
    font-size: 0.75rem;
    margin-top: 0.1rem;
  }
  .lh-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.6rem;
    padding: 0.45rem 0;
    border-bottom: 1px solid #eee;
  }
  .lh-img {
    width: 100%;
    max-height: 110px;
    object-fit: contain;
    border-radius: 8px;
    background: #fff;
  }
  .lh-info { flex: 1; font-size: 0.92rem; }
  .lh-fm-em {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-left: 1.4rem;
  }
  .lh-preview {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin: 0.4rem 0;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0.4rem;
  }
  .lh-preview img {
    width: 74px;
    height: 56px;
    object-fit: cover;
    border-radius: 6px;
  }
  .lh-preview small {
    color: #444;
    line-height: 1.2;
    font-size: 0.82rem;
  }

  /* ===== Small helpers ===== */
  .muted { color: #666; font-size: 0.9rem; }

  /* ===== Mobilanpassning ===== */
  @media (max-width: 600px) {
    th, td {
      font-size: 0.8rem;
      padding: 0.35rem 0.25rem;
    }
    td:nth-child(7) {
      max-width: 90px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
  [data-field="events"], [data-field="lh"] {
  font-size: 1.2rem;
  letter-spacing: 2px;
}

tbody tr.mens-row {
  background-color: #ffe8ee !important;
}
</style>
</head>
<body>
  <h1>BBT & LH</h1>

  <div class="tabs">
    <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
    <button class="tab" data-tab="graf">ğŸ“ˆ Graf</button>
    <button class="tab" data-tab="lh">ğŸ§ª LH-test</button>
  </div>

  <!-- Inmatning & Tabell -->
  <div id="inmatning" class="tab-content active">
    <div class="form-row">
      <label for="date">Datum:</label>
      <input type="date" id="date">
    </div>
    <div class="form-row">
      <label for="time">Tid (BBT):</label>
      <input type="time" id="time">
    </div>
    <div class="form-row">
      <label for="actual">Faktisk temp (Â°C):</label>
      <input type="number" step="0.01" id="actual" placeholder="t.ex. 36.42">
    </div>
    <div class="form-row">
      <label for="corrected">Korrigerad temp (Â°C):</label>
      <input type="number" step="0.01" id="corrected" placeholder="BerÃ¤knas automatiskt">
    </div>
 <!-- === HÃ¤ndelsesymboler === -->
<div class="inline-symbols">
  <label>HÃ¤ndelser:</label>
  <div class="symbol">ğŸ©¸ <input type="checkbox" id="mens" /></div>
  <div class="symbol">ğŸ’ <input type="checkbox" id="sex" /></div>
  <div class="symbol">ğŸŒ¼ <input type="checkbox" id="ovulation" /></div>
  <div class="symbol">â• <input type="checkbox" id="lhPos" /></div>
  <div class="symbol">â– <input type="checkbox" id="lhNeg" /></div>
</div>

    <div class="form-row" style="align-items:flex-start">
      <label for="note" style="margin-top:.2rem">Anteckning:</label>
      <textarea id="note" rows="2" placeholder="Valfritt"></textarea>
    </div>

    <div class="top-buttons">
      <button class="button" id="saveBtn">Spara</button>
      <button class="button" id="exportBtn">Exportera data</button>
      <button class="button" id="importBtn">Importera data</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>

    <div class="table-wrap">
   <table id="dataTable">
  <thead>
    <tr>
      <th>Datum</th>
      <th>Tid</th>
      <th>F Â°C</th>
      <th>K Â°C</th>
      <th>Sekret</th>
      <th>HÃ¤ndelser</th>
      <th>Anteckning</th>
      <th></th> <!-- kolumn fÃ¶r âœï¸ och ğŸ—‘ï¸ -->
    </tr>
  </thead>
  <tbody></tbody>
</table>
    </div>

    <div style="text-align:center; margin-top:1rem;">
      <button class="button danger" id="clearBtn">Rensa all data</button>
    </div>
  </div>

  <!-- Graf -->
  <div id="graf" class="tab-content">
    <div id="chartContainer">
      <canvas id="bbtChart"></canvas>
    </div>
    <div class="chart-toolbar">
      <button class="button" id="exportChartBtn">Exportera graf</button>
    </div>
  </div>

  <!-- LH-test -->
  <div id="lh" class="tab-content">
    <div class="lh-toolbar">
      <div style="display:flex; gap:.5rem; align-items:center">
        <button class="button" id="lhPickBtn">VÃ¤lj bild</button>
        <input type="file" id="lhFile" accept="image/*" style="display:none">
      </div>
      <input type="date" id="lhDate">
    </div>

    <div class="lh-symbols-row" style="margin:.4rem 0 .3rem">
      <label class="lh-symbol-checkbox" title="NÃ¤stan positiv">ğŸ©·<small>N</small><br><input type="checkbox" class="lhSym" value="ğŸ©·"></label>
      <label class="lh-symbol-checkbox" title="LH-topp">â¤ï¸<small>T</small><br><input type="checkbox" class="lhSym" value="â¤ï¸"></label>
      <label class="lh-symbol-checkbox" title="HÃ¶g">ğŸ’œ<small>H</small><br><input type="checkbox" class="lhSym" value="ğŸ’œ"></label>
      <label class="lh-symbol-checkbox" title="LÃ¥g">ğŸ’™<small>L</small><br><input type="checkbox" class="lhSym" value="ğŸ’™"></label>
      <label class="lh-symbol-checkbox" title="Negativ">ğŸ’š<small>â€“</small><br><input type="checkbox" class="lhSym" value="ğŸ’š"></label>
      <label class="lh-symbol-checkbox" title="Oklart">ğŸ’›<small>?</small><br><input type="checkbox" class="lhSym" value="ğŸ’›"></label>

      <!-- FM/EM, indraget sÃ¥ de hamnar under datumfÃ¤ltet men i samma radhÃ¶jd -->
      <span class="lh-fm-em">
        <label class="lh-symbol-checkbox" title="FM (fÃ¶rmiddag)">â˜€ï¸<small>FM</small><br><input type="checkbox" id="lhFm"></label>
        <label class="lh-symbol-checkbox" title="EM (eftermiddag/kvÃ¤ll)">ğŸŒ™<small>EM</small><br><input type="checkbox" id="lhEm"></label>
      </span>
    </div>

    <!-- Liten, icke-stÃ¶rande fÃ¶rhandsvisning -->
    <div id="lhPreview" class="lh-preview" style="display:none;">
      <img id="lhPreviewImg" alt="FÃ¶rhandsvisning">
      <small id="lhPreviewInfo" class="muted"></small>
    </div>

    <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
      <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
      <button class="button" id="lhSaveBtn">Spara</button>
    </div>

    <div id="lhList"></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ===== Tabs ===== */
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.tab;
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(id).classList.add('active');
        if(id==='graf') renderChart();
        if(id==='lh') renderLHList();
      });
    });

    /* ===== Elements ===== */
    const el = {
      date: document.getElementById('date'),
      time: document.getElementById('time'),
      actual: document.getElementById('actual'),
      corrected: document.getElementById('corrected'),
      mens: document.getElementById('mens'),
      mucus: document.getElementById('mucus'),
      lhSel: document.getElementById('lhSel'),
      sex: document.getElementById('sex'),
      ovulation: document.getElementById('ovulation'),
      note: document.getElementById('note'),

      saveBtn: document.getElementById('saveBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      clearBtn: document.getElementById('clearBtn'),

      dataTableBody: document.querySelector('#dataTable tbody'),
      chartCanvas: document.getElementById('bbtChart'),
      exportChartBtn: document.getElementById('exportChartBtn'),

      lhPickBtn: document.getElementById('lhPickBtn'),
      lhFile: document.getElementById('lhFile'),
      lhDate: document.getElementById('lhDate'),
      lhNote: document.getElementById('lhNote'),
      lhSaveBtn: document.getElementById('lhSaveBtn'),
      lhList: document.getElementById('lhList'),
      lhFm: document.getElementById('lhFm'),
      lhEm: document.getElementById('lhEm'),
      lhPreview: document.getElementById('lhPreview'),
      lhPreviewImg: document.getElementById('lhPreviewImg'),
      lhPreviewInfo: document.getElementById('lhPreviewInfo'),
      lhSymChecks: () => Array.from(document.querySelectorAll('.lhSym:checked'))
    };

    /* ===== State ===== */
    let dataEntries = JSON.parse(localStorage.getItem('bbtData') || '[]');

    // Ny LH-datastruktur: objekt med datum -> lista av poster
    // Migrera ev. gammal 'lhData' (array) -> ny 'lhDataByDate' (objekt)
    (function migrateLH(){
      const newKey = 'lhDataByDate';
      const oldArr = JSON.parse(localStorage.getItem('lhData') || 'null');
      let obj = JSON.parse(localStorage.getItem(newKey) || 'null');

      if(!obj){
        obj = {};
      }
      if(Array.isArray(oldArr)){
        oldArr.forEach(e=>{
          const d = e.date || 'okÃ¤nt-datum';
          if(!obj[d]) obj[d] = [];
          obj[d].push({ dataUrl: e.dataUrl, symbols: e.symbols||[], note: e.note||'', tod: null, ts: Date.now() });
        });
        localStorage.removeItem('lhData');
      }
      localStorage.setItem(newKey, JSON.stringify(obj));
    })();

    let lhByDate = JSON.parse(localStorage.getItem('lhDataByDate') || '{}');
    let chart;

    /* ===== Helpers ===== */
    const minutesFrom0400 = (t) => {
      if (!t) return 0;
      const [h, m] = t.split(':').map(Number);
      return (h * 60 + m) - 240;
    };
    function computeCorrectedFrom(a, timeStr) {
      if (Number.isNaN(a)) return null;
      const mins = minutesFrom0400(timeStr || '04:00');
      const corr = a - 0.05 * (mins / 30); // minus efter 04:00, plus fÃ¶re
      return Number(corr.toFixed(2));
    }
    function computeCorrectedFormInputs() {
      const a = parseFloat(el.actual.value);
      if (Number.isNaN(a)) return;
      const corr = computeCorrectedFrom(a, el.time.value);
      if (corr !== null) el.corrected.value = corr.toFixed(2);
    }

  /* ===== Spara & tabell med radradering ===== */
function saveEntry() {
  const e = {
    date: el.date.value,
    time: el.time.value,
    actual: el.actual.value ? Number(el.actual.value) : null,
    corrected: el.corrected.value ? Number(el.corrected.value) : null,
    mucus: el.mucus.value,
    note: el.note.value,
    // symboler
    mens: el.mens.checked || false,
    sex: el.sex.checked || false,
    ovulation: el.ovulation.checked || false,
    lhPos: el.lhPos.checked || false,
    lhNeg: el.lhNeg.checked || false
  };

  if (!e.date) return alert("VÃ¤lj datum.");

  const i = dataEntries.findIndex(x => x.date === e.date);
  if (i >= 0) dataEntries[i] = e;
  else dataEntries.push(e);

  localStorage.setItem("bbtData", JSON.stringify(dataEntries));
  renderTable();

  // nollstÃ¤ll formulÃ¤ret
  el.note.value = "";
  ["mens", "sex", "ovulation", "lhPos", "lhNeg"].forEach(id => el[id].checked = false);
  alert("âœ… Sparat!");
}

function renderTable() {
  el.dataTableBody.innerHTML = "";
  dataEntries.sort((a, b) => a.date.localeCompare(b.date));

  dataEntries.forEach((e, idx) => {
    const tr = document.createElement("tr");
    if (e.mens) tr.classList.add("mens-row");

    tr.innerHTML = `
      <td data-field="date">${e.date || ''}</td>
      <td data-field="time" contenteditable="true">${e.time || ''}</td>
      <td data-field="actual" contenteditable="true">${e.actual ?? ''}</td>
      <td data-field="corrected">${e.corrected ?? ''}</td>
      <td data-field="mucus" contenteditable="true">${e.mucus || 'â€“'}</td>
      <td data-field="events">${e.mens ? "ğŸ©¸" : ""}${e.sex ? "ğŸ’" : ""}${e.ovulation ? "ğŸŒ¼" : ""}</td>
      <td data-field="lh">${e.lhPos ? "â•" : e.lhNeg ? "â–" : ""}</td>
      <td data-field="note" contenteditable="true">${e.note || ''}</td>
      <td>
        <button class="button" style="padding:0.3rem 0.5rem;font-size:0.8rem;" data-edit="${idx}">âœï¸</button>
        <button class="button danger" style="padding:0.3rem 0.5rem;font-size:0.8rem;" data-del="${idx}">ğŸ—‘ï¸</button>
      </td>
    `;

    // cellredigering
    tr.querySelectorAll("[contenteditable=true]").forEach(td => {
      td.addEventListener("blur", () => {
        const field = td.dataset.field;
        const val = td.textContent.trim();
        if (field === "actual") {
          e.actual = Number(val) || null;
          e.corrected = computeCorrectedFrom(e.actual, e.time);
          td.parentElement.querySelector("[data-field='corrected']").textContent = e.corrected?.toFixed(2) || '';
        } else if (field === "time") {
          e.time = val;
          e.corrected = computeCorrectedFrom(e.actual, e.time);
          td.parentElement.querySelector("[data-field='corrected']").textContent = e.corrected?.toFixed(2) || '';
        } else if (field === "mucus") e.mucus = val;
        else if (field === "note") e.note = val;

        localStorage.setItem("bbtData", JSON.stringify(dataEntries));
      });
    });

    // radera rad
    tr.querySelector("[data-del]").addEventListener("click", () => {
      if (confirm(`Ta bort posten ${e.date}?`)) {
        dataEntries.splice(idx, 1);
        localStorage.setItem("bbtData", JSON.stringify(dataEntries));
        renderTable();
      }
    });

    // redigera rad
    tr.querySelector("[data-edit]").addEventListener("click", () => {
      el.date.value = e.date;
      el.time.value = e.time;
      el.actual.value = e.actual ?? "";
      el.corrected.value = e.corrected ?? "";
      el.mucus.value = e.mucus;
      el.note.value = e.note;
      el.mens.checked = !!e.mens;
      el.sex.checked = !!e.sex;
      el.ovulation.checked = !!e.ovulation;
      el.lhPos.checked = !!e.lhPos;
      el.lhNeg.checked = !!e.lhNeg;
      alert("Posten har laddats in i formulÃ¤ret. GÃ¶r Ã¤ndringar och tryck Spara.");
    });

    el.dataTableBody.appendChild(tr);
  });
}

/* HjÃ¤lpfunktioner fÃ¶r snyggare datum/tid */
function formatDate(d) {
  if (!d) return "";
  const dateObj = new Date(d);
  const day = dateObj.getDate();
  const monthNames = ["jan", "feb", "mar", "apr", "maj", "jun", "jul", "aug", "sep", "okt", "nov", "dec"];
  return `${day} ${monthNames[dateObj.getMonth()]}`;
}

function formatTime(t) {
  if (!t) return "";
  const [h, m] = t.split(":");
  return `${h.padStart(2, "0")}:${m.padStart(2, "0")}`;
}

    function clearData(){
      if(!confirm('Vill du verkligen rensa all data?')) return;
      dataEntries = [];
      lhByDate = {};
      localStorage.removeItem('bbtData');
      localStorage.removeItem('lhData');
      localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));
      if(chart) chart.destroy();
      renderTable();
      renderLHList();
    }

    /* ===== Graf ===== */
    function renderChart(){
      if(chart) chart.destroy();

      dataEntries.sort((a,b)=>a.date.localeCompare(b.date));

      const labels = dataEntries.map(e=>{
        if(!e.date) return "";
        const [y,m,d] = e.date.split("-");
        return `${d}-${m}`;
      });

      const actual    = dataEntries.map(e=>e.actual);
      const corrected = dataEntries.map(e=>e.corrected);

      const ovIndex = dataEntries.findIndex(e=>e.ovulation);
      const preVals = (ovIndex>0 ? actual.slice(0, ovIndex) : actual).filter(v=>typeof v==='number');
      const avg = preVals.length ? preVals.reduce((a,b)=>a+b,0)/preVals.length : null;

      const anns = [];
      const firstNonMens = dataEntries.findIndex(e=>e.mens!=='Mens');
      const mensEndX = (firstNonMens===-1) ? labels.length-0.5 : firstNonMens-0.5;
      if(firstNonMens!==0) anns.push({type:'box', xMin:0, xMax:mensEndX, backgroundColor:'rgba(255,230,236,.5)', borderWidth:0});
      if(ovIndex>-1) anns.push({type:'box', xMin:ovIndex+0.5, xMax:labels.length-0.5, backgroundColor:'rgba(242,230,255,.5)', borderWidth:0});

      const symbols = dataEntries.map(e=>{
        const s=[];
        if(e.sex) s.push('ğŸ’');
        if(e.ovulation) s.push('ğŸŒ¼');
        if(e.mucus==='Ã„ggviteliknande') s.push('ğŸ’§');
        return s;
      });

      chart = new Chart(el.chartCanvas, {
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'Faktisk temperatur', data:actual, borderColor:'#3b82f6', backgroundColor:'#3b82f6', pointRadius:3, tension:0.28, spanGaps:true },
            { label:'Korrigerad temperatur', data:corrected, borderColor:'#ef4444', backgroundColor:'#ef4444', borderDash:[4,4], pointRadius:2, tension:0.28, spanGaps:true },
            ...(avg ? [{ label:'Medel fÃ¶re Ã¤gglossning', data:Array(labels.length).fill(avg), borderColor:'#888', borderDash:[6,4], pointRadius:0 }] : [])
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{ min:34.9, max:38.6, ticks:{ stepSize:0.1, color:'#000' }, title:{ display:true, text:'Temperatur (Â°C)' } },
            x:{ ticks:{ color:'#000', autoSkip:true, maxTicksLimit:10, maxRotation:0 } }
          },
          plugins:{ legend:{ position:'bottom', labels:{ color:'#000' } }, annotation:{ annotations:anns } },
          animation:false
        },
        plugins:[{
          id:'symbols',
          afterDatasetsDraw(c){
            const ctx=c.ctx; ctx.font='10px sans-serif'; ctx.textAlign='center';
            const meta=c.getDatasetMeta(0);
            c.data.labels.forEach((_,i)=>{
              const p=meta.data[i]; if(!p) return;
              const x=p.x, y=c.scales.y.bottom-18;
              if(symbols[i]?.length) symbols[i].forEach((sm,j)=>ctx.fillText(sm,x,y-j*13));
            });
          }
        }]
      });
    }

    /* ===== Export / Import ===== */
    el.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({ bbtData:dataEntries, lhDataByDate:lhByDate }, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'BBT_Ida_data.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    el.importBtn.addEventListener('click', ()=>el.importFile.click());
    el.importFile.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const o = JSON.parse(r.result);
          if(o.bbtData) dataEntries = o.bbtData;
          if(o.lhDataByDate) lhByDate  = o.lhDataByDate;
          else if(o.lhData) { // extra nÃ¶dfall, om nÃ¥gon gammal export
            lhByDate = {};
            if(Array.isArray(o.lhData)) {
              o.lhData.forEach(e=>{
                const d=e.date||'okÃ¤nt-datum';
                if(!lhByDate[d]) lhByDate[d]=[];
                lhByDate[d].push({dataUrl:e.dataUrl, symbols:e.symbols||[], note:e.note||'', tod:null, ts:Date.now()});
              });
            }
          }
          localStorage.setItem('bbtData', JSON.stringify(dataEntries));
          localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));
          renderTable(); renderLHList();
          if(document.querySelector('.tab.active')?.dataset.tab==='graf') renderChart();
          alert('Data importerad!');
        }catch{
          alert('Ogiltig fil.');
        }
      };
      r.readAsText(file);
      e.target.value='';
    });

    el.clearBtn.addEventListener('click', clearData);
    el.exportChartBtn?.addEventListener('click', ()=>{
      const link = document.createElement('a');
      link.download = 'BBT_graf.png';
      link.href = el.chartCanvas.toDataURL('image/png');
      link.click();
    });

    /* ===== LH: fÃ¶rhandsvisning + sparning ===== */
    function updateLHPreview(){
      const file = el.lhFile.files && el.lhFile.files[0];
      if(!file){ el.lhPreview.style.display='none'; return; }
      const rd = new FileReader();
      rd.onload = (ev)=>{
        el.lhPreviewImg.src = ev.target.result;
        const syms = el.lhSymChecks().map(x=>x.value).join(' ') || 'â€“';
        const tod = el.lhFm.checked ? 'â˜€ï¸ FM' : (el.lhEm.checked ? 'ğŸŒ™ EM' : 'â€”');
        const d = el.lhDate.value || '(Datum ej valt)';
        const n = el.lhNote.value ? `"${el.lhNote.value}"` : '';
        el.lhPreviewInfo.textContent = `${d}  â€¢  ${syms}  â€¢  ${tod}  ${n?('â€¢ '+n):''}`;
        el.lhPreview.style.display = 'flex';
      };
      rd.readAsDataURL(file);
    }
    el.lhPickBtn.addEventListener('click', ()=> el.lhFile.click());
    el.lhFile.addEventListener('change', updateLHPreview);
    [el.lhDate, el.lhNote].forEach(x=>['input','change'].forEach(evt=>x.addEventListener(evt, updateLHPreview)));
    document.querySelectorAll('.lhSym').forEach(cb=>cb.addEventListener('change', updateLHPreview));
    el.lhFm.addEventListener('change', ()=>{ if(el.lhFm.checked) el.lhEm.checked=false; updateLHPreview(); });
    el.lhEm.addEventListener('change', ()=>{ if(el.lhEm.checked) el.lhFm.checked=false; updateLHPreview(); });

    function renderLHList(){
      el.lhList.innerHTML='';
      const dates = Object.keys(lhByDate).sort(); // kronologiskt
      dates.forEach(date=>{
        (lhByDate[date]||[]).forEach((item, idx)=>{
          const row = document.createElement('div');
          row.className = 'lh-row';
          row.innerHTML = `
            <div style="flex:0 0 38%"><img class="lh-img" src="${item.dataUrl}" alt="LH-bild" data-date="${date}" data-idx="${idx}"></div>
            <div class="lh-info">
              <div style="font-weight:700">${date}</div>
              <div style="font-size:1.15rem; margin:.15rem 0;">${(item.symbols||[]).join(' ')}</div>
              <div class="muted">${item.tod ? item.tod : 'â€”'}</div>
              <div style="font-size:.9rem; color:#555">${item.note||''}</div>
            </div>
            <div><button class="button danger" data-del="${date}::${idx}">Ta bort</button></div>
          `;
          // fullskÃ¤rm med blÃ¤ddring
          row.querySelector('img').addEventListener('click', (ev)=>openGallery(date, parseInt(ev.target.dataset.idx,10)));
          // radera
          row.querySelector('[data-del]').addEventListener('click', (ev)=>{
            const [d,iStr] = ev.target.getAttribute('data-del').split('::');
            const i = parseInt(iStr,10);
            if(Array.isArray(lhByDate[d])) {
              lhByDate[d].splice(i,1);
              if(lhByDate[d].length===0) delete lhByDate[d];
              localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));
              renderLHList();
            }
          });
          el.lhList.appendChild(row);
        });
      });
    }

    // FullskÃ¤rm + blÃ¤ddring (genom alla poster i kronologisk ordning)
    function allLHFlat(){
      const out=[];
      Object.keys(lhByDate).sort().forEach(date=>{
        (lhByDate[date]||[]).forEach(item=>out.push({date, ...item}));
      });
      return out;
    }
    function openGallery(date, idxInDate){
      const flat = allLHFlat();
      if(!flat.length) return;

      // hitta motsvarande index i flat
      let flatIndex = 0, count=0;
      Object.keys(lhByDate).sort().some(d=>{
        const arr = lhByDate[d]||[];
        if(d===date){ flatIndex = count + idxInDate; return true; }
        count += arr.length; return false;
      });

      const o = document.createElement('div');
      o.style = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999';
      const img = document.createElement('img');
      img.style = 'max-width:92%;max-height:92%;border-radius:10px;background:#fff';
      const left = document.createElement('div');
      const right = document.createElement('div');
      left.style = right.style = 'position:absolute;top:0;width:50%;height:100%;';
      left.style.left='0'; right.style.right='0';

      function show(i){
        if(i<0) i = flat.length-1;
        if(i>=flat.length) i = 0;
        flatIndex = i;
        img.src = flat[flatIndex].dataUrl;
      }
      show(flatIndex);

      left.addEventListener('click', (e)=>{ e.stopPropagation(); show(flatIndex-1); });
      right.addEventListener('click', (e)=>{ e.stopPropagation(); show(flatIndex+1); });
      o.addEventListener('click', ()=>document.body.removeChild(o));
      o.appendChild(img); o.appendChild(left); o.appendChild(right);
      document.body.appendChild(o);

      function onKey(ev){
        if(ev.key==='ArrowLeft'){ show(flatIndex-1); }
        if(ev.key==='ArrowRight'){ show(flatIndex+1); }
        if(ev.key==='Escape'){ cleanup(); }
      }
      function cleanup(){ document.removeEventListener('keydown', onKey); if(o.parentNode) document.body.removeChild(o); }
      document.addEventListener('keydown', onKey);

      let sx=null, sy=null;
      o.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
      o.addEventListener('touchend', (e)=>{
        const t=e.changedTouches[0]; if(sx===null) return;
        const dx = t.clientX - sx, dy = t.clientY - sy;
        if(Math.abs(dx)>40 && Math.abs(dy)<60){ if(dx<0) show(flatIndex+1); else show(flatIndex-1); }
        else { cleanup(); }
        sx=sy=null;
      }, {passive:true});
    }

    // Spara LH-post
    el.lhSaveBtn.addEventListener('click', ()=>{
      const file = el.lhFile.files && el.lhFile.files[0];
      if(!file) return alert('VÃ¤lj bild fÃ¶rst.');
      if(!el.lhDate.value) return alert('VÃ¤lj datum.');
      const reader = new FileReader();
      reader.onload = (e)=>{
        const dataUrl = e.target.result;
        const symbols = el.lhSymChecks().map(x=>x.value);
        const note = el.lhNote.value || '';
        const tod = el.lhFm.checked ? 'â˜€ï¸ FM' : (el.lhEm.checked ? 'ğŸŒ™ EM' : null);
        const d = el.lhDate.value;

        if(!lhByDate[d]) lhByDate[d] = [];
        lhByDate[d].push({ dataUrl, symbols, note, tod, ts: Date.now() });

        localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));

        // nollstÃ¤ll UI
        el.lhNote.value = '';
        el.lhFile.value = '';
        el.lhFm.checked = false; el.lhEm.checked = false;
        document.querySelectorAll('.lhSym').forEach(cb=>cb.checked=false);
        el.lhPreview.style.display='none';
        renderLHList();
        alert('âœ… Bild sparad!');
      };
      reader.onerror = ()=> alert('Kunde inte lÃ¤sa in bilden.');
      reader.readAsDataURL(file);
    });
/* ===== Events ===== */
// NÃ¤r du lÃ¤mnar fÃ¤ltet fÃ¶r faktisk temperatur â€“ rÃ¤kna ut korrigerad automatiskt
el.actual.addEventListener('blur', computeCorrectedFormInputs);

// NÃ¤r du Ã¤ndrar tiden â€“ uppdatera korrigeringen om faktisk temperatur finns
el.time.addEventListener('change', ()=>{ 
  if (el.actual.value) computeCorrectedFormInputs(); 
});

// NÃ¤r du klickar pÃ¥ "Spara" â€“ spara posten
el.saveBtn.addEventListener('click', saveEntry);
    /* ===== Init ===== */
    renderTable();
    renderLHList();
  });
  </script>
</body>
</html>