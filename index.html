<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BBT</title>
  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <style>
    body {font-family: Helvetica Neue, sans-serif; background:#fff; color:#000; margin:0;}
    h1{text-align:center;margin-top:1rem;}
    .tabs{display:flex;justify-content:center;margin:1rem 0;border-bottom:2px solid #eee;}
    .tab{padding:.7rem 1.2rem;cursor:pointer;border:none;background:#f5f5f5;border-radius:8px 8px 0 0;margin:0 .3rem;font-weight:600;}
    .tab.active{background:#fff;border-bottom:2px solid #fff;color:#e06b8f;}
    .tab-content{display:none;max-width:750px;margin:auto;padding:1rem;border:1px solid #eee;border-radius:10px;}
    .tab-content.active{display:block;}
    label{display:inline-block;width:130px;}
    input,select,textarea{width:calc(100% - 140px);margin-bottom:.6rem;padding:.4rem;border:1px solid #ccc;border-radius:6px;}
    .button{background:#f4b6c2;border:none;border-radius:6px;padding:.5rem 1rem;margin:.2rem;font-weight:600;}
    .button:hover{background:#e89bae;}
    .danger{background:#f4b6c2;}
    table{width:100%;border-collapse:collapse;margin-top:1rem;}
    th,td{border:1px solid #ddd;padding:.5rem;text-align:center;white-space:nowrap;}
    tr.mens-row{background:#ffe5ec;}
    #bbtChart{width:100%;height:420px;}
    .lh-entry{display:flex;align-items:flex-start;justify-content:space-between;border-bottom:1px solid #eee;padding:.5rem 0;}
    .lh-image{width:35%;border-radius:6px;}
    .lh-info{flex:1;margin-left:10px;}
    .lh-symbols{font-size:1.2rem;}
    .lh-symbol-checkbox{text-align:center;margin-right:.4rem;font-size:1.4rem;}
  </style>
</head>
<body>
  <h1>BBT â€“ Ida</h1>
  <div class="tabs">
    <button class="tab active" onclick="openTab('inmatning')">Inmatning & Tabell</button>
    <button class="tab" onclick="openTab('graf')">ğŸ“ˆ Graf</button>
    <button class="tab" onclick="openTab('lh')">ğŸ§ª LH-test</button>
  </div>

  <!-- Inmatning -->
  <div id="inmatning" class="tab-content active">
    <label>Datum:</label><input type="date" id="date"><br>
    <label>Tid (BBT):</label><input type="time" id="time"><br>
    <label>Faktisk temp:</label><input type="number" step="0.01" id="actual"><br>
    <label>Korrigerad temp:</label><input type="number" step="0.01" id="corrected" placeholder="BerÃ¤knas"><br>
    <label>Mens:</label>
    <select id="mens"><option>â€“</option><option>Mens</option></select><br>
    <label>Sekret:</label>
    <select id="mucus"><option>â€“</option><option>Klart</option><option>Ã„ggviteliknande</option><option>KrÃ¤mig</option></select><br>
    <label>LH:</label><select id="lh"><option>â€“</option><option>Positivt</option><option>Negativt</option></select><br>
    <span>ğŸ’ <input type="checkbox" id="sex"></span>
    <span>ğŸŒ¼ <input type="checkbox" id="ovulation"></span><br>
    <label>Anteckning:</label><textarea id="note"></textarea><br>
    <button class="button" id="saveBtn">Spara</button>
    <button class="button" id="exportBtn">Exportera</button>
    <button class="button" id="importBtn">Importera</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
    <div style="overflow-x:auto">
      <table id="dataTable"><thead><tr>
        <th>Datum</th><th>Tid</th><th>Faktisk</th><th>Korr</th><th>Mens</th><th>Sekret</th><th>LH</th><th>ğŸ’</th><th>ğŸŒ¼</th><th>Anteckning</th>
      </tr></thead><tbody></tbody></table>
    </div>
    <div style="text-align:center;margin-top:1rem;">
      <button class="button danger" id="clearBtn">Rensa data</button>
    </div>
  </div>

  <!-- Graf -->
  <div id="graf" class="tab-content"><canvas id="bbtChart"></canvas></div>

  <!-- LH-test -->
  <div id="lh" class="tab-content">
    <div style="display:flex;gap:.5rem;justify-content:space-between;">
      <button class="button" id="lhPickBtn">VÃ¤lj bild</button>
      <input type="file" id="lhFile" accept="image/*" style="display:none">
      <input type="date" id="lhDate">
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:.5rem;">
      <label class="lh-symbol-checkbox">ğŸ©·<br><input type="checkbox" class="lhSym" value="ğŸ©·"></label>
      <label class="lh-symbol-checkbox">â¤ï¸<br><input type="checkbox" class="lhSym" value="â¤ï¸"></label>
      <label class="lh-symbol-checkbox">ğŸ’œ<br><input type="checkbox" class="lhSym" value="ğŸ’œ"></label>
      <label class="lh-symbol-checkbox">ğŸ’™<br><input type="checkbox" class="lhSym" value="ğŸ’™"></label>
      <label class="lh-symbol-checkbox">ğŸ’š<br><input type="checkbox" class="lhSym" value="ğŸ’š"></label>
      <label class="lh-symbol-checkbox">ğŸ’›<br><input type="checkbox" class="lhSym" value="ğŸ’›"></label>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem;">
      <textarea id="lhNote" placeholder="Anteckning" style="flex:1"></textarea>
      <button class="button" id="lhSaveBtn">Spara</button>
    </div>
    <div id="lhList" style="margin-top:10px;"></div>
  </div>

  <script>
    let dataEntries = JSON.parse(localStorage.getItem('bbtData') || '[]');
    let lhEntries = JSON.parse(localStorage.getItem('lhData') || '[]');
    let chart;

    function openTab(id){
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
      document.querySelector(`[onclick="openTab('${id}')"]`).classList.add("active");
      document.getElementById(id).classList.add("active");
      if(id==="graf")renderChart();
      if(id==="lh")renderLHList();
    }

    function minutesFrom0400(t){if(!t)return 0;const [h,m]=t.split(':').map(Number);return (h*60+m)-240;}
    function computeCorrected(){const a=parseFloat(actual.value);if(isNaN(a))return;const c=a+0.05*(minutesFrom0400(time.value||"04:00")/30);corrected.value=c.toFixed(2);}
    actual.onblur=computeCorrected;time.onchange=()=>{if(actual.value)computeCorrected();};

    function saveEntry(){
      const e={date:date.value,time:time.value,actual:+actual.value||null,corrected:+corrected.value||null,mens:mens.value,mucus:mucus.value,lh:lh.value,sex:sex.checked,ovulation:ovulation.checked,note:note.value};
      if(!e.date)return alert("VÃ¤lj datum");
      const i=dataEntries.findIndex(x=>x.date===e.date);
      if(i>=0)dataEntries[i]=e;else dataEntries.push(e);
      localStorage.setItem('bbtData',JSON.stringify(dataEntries));renderTable();
    }

    function renderTable(){
      const tb=document.querySelector("#dataTable tbody");tb.innerHTML="";
      dataEntries.sort((a,b)=>a.date.localeCompare(b.date));
      for(const e of dataEntries){const tr=document.createElement("tr");
        if(e.mens==="Mens")tr.classList.add("mens-row");
        tr.innerHTML=`<td>${e.date}</td><td>${e.time||""}</td><td>${e.actual||""}</td><td>${e.corrected||""}</td>
          <td>${e.mens||"â€“"}</td><td>${e.mucus||"â€“"}</td><td>${e.lh||"â€“"}</td>
          <td>${e.sex?"ğŸ’":""}</td><td>${e.ovulation?"ğŸŒ¼":""}</td><td>${e.note||""}</td>`;
        tb.appendChild(tr);
      }
    }

    function clearData(){if(!confirm("Rensa all data?"))return;dataEntries=[];lhEntries=[];localStorage.clear();renderTable();renderLHList();if(chart)chart.destroy();}

    function renderChart(){
      if(chart)chart.destroy();
      const ctx=document.getElementById('bbtChart');
      dataEntries.sort((a,b)=>a.date.localeCompare(b.date));
      const labels=dataEntries.map(e=>e.date);
      const actual=dataEntries.map(e=>e.actual);
      const corrected=dataEntries.map(e=>e.corrected);
      const ov=dataEntries.findIndex(e=>e.ovulation);
      const pre=(ov>0?actual.slice(0,ov):actual).filter(v=>v);
      const avg=pre.length?pre.reduce((a,b)=>a+b)/pre.length:null;
      const anns=[];
      const firstNon=dataEntries.findIndex(e=>e.mens!=="Mens");
      const end=(firstNon===-1)?dataEntries.length-0.5:firstNon-0.5;
      if(firstNon!==0)anns.push({type:'box',xMin:0,xMax:end,backgroundColor:'rgba(255,230,230,.3)',borderWidth:0});
      if(ov>-1)anns.push({type:'box',xMin:ov+0.5,xMax:labels.length-0.5,backgroundColor:'rgba(230,210,255,.25)',borderWidth:0});
      const symbols=dataEntries.map(e=>{const s=[];if(e.sex)s.push("ğŸ’");if(e.ovulation)s.push("ğŸŒ¼");if(e.mucus==="Ã„ggviteliknande")s.push("ğŸ’§");return s;});
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[
        {label:"Faktisk",data:actual,borderColor:"#3b82f6",backgroundColor:"#3b82f6",tension:0.3},
        {label:"Korrigerad",data:corrected,borderColor:"#ef4444",borderDash:[4,4],tension:0.3},
        ...(avg?[{label:"Medel fÃ¶re Ã„L",data:Array(labels.length).fill(avg),borderColor:"#888",borderDash:[5,5],pointRadius:0}]:[])
      ]},options:{scales:{y:{min:35,max:38.5}},plugins:{legend:{labels:{color:'#000'}},annotation:{annotations:anns}},animation:false},
      plugins:[{id:'symbols',afterDatasetsDraw(c){const ctx=c.ctx;ctx.font="10px sans-serif";ctx.textAlign="center";const m=c.getDatasetMeta(0);
        c.data.labels.forEach((_,i)=>{const p=m.data[i];if(!p)return;const x=p.x,y=c.scales.y.bottom-18;if(symbols[i]?.length){symbols[i].forEach((s,j)=>ctx.fillText(s,x,y-(j*13)));}});}}]});
    }

    function renderLHList(){
      const list=document.getElementById('lhList');list.innerHTML="";
      lhEntries.sort((a,b)=>a.date.localeCompare(b.date));
      lhEntries.forEach((e,i)=>{
        const d=document.createElement('div');d.className="lh-entry";
        d.innerHTML=`<img class="lh-image" src="${e.dataUrl}" alt=""><div class="lh-info"><strong>${e.date}</strong><div class="lh-symbols">${(e.symbols||[]).join(" ")}</div><small>${e.note||""}</small></div><button class="button danger" onclick="delLH(${i})">Ta bort</button>`;
        d.querySelector('img').onclick=()=>full(e.dataUrl);
        list.appendChild(d);
      });
    }

    function full(src){const o=document.createElement('div');o.style="position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:99";
      const i=document.createElement('img');i.src=src;i.style="max-width:90%;max-height:90%;border-radius:8px;background:#fff";o.appendChild(i);
      o.onclick=()=>document.body.removeChild(o);document.body.appendChild(o);}
    function delLH(i){lhEntries.splice(i,1);localStorage.setItem('lhData',JSON.stringify(lhEntries));renderLHList();}

    lhPickBtn.onclick=()=>lhFile.click();
    lhSaveBtn.onclick=async()=>{
      if(!lhFile.files[0])return alert("VÃ¤lj bild");
      if(!lhDate.value)return alert("VÃ¤lj datum");
      const s=[...document.querySelectorAll('.lhSym:checked')].map(x=>x.value);
      const note=lhNote.value;const f=lhFile.files[0];
      const r=new FileReader();r.onload=()=>{lhEntries.push({date:lhDate.value,symbols:s,note,dataUrl:r.result});
        localStorage.setItem('lhData',JSON.stringify(lhEntries));
        document.querySelectorAll('.lhSym').forEach(x=>x.checked=false);lhNote.value="";lhFile.value="";renderLHList();};
      r.readAsDataURL(f);
    };

    exportBtn.onclick=()=>{
      const blob=new Blob([JSON.stringify({bbtData:dataEntries,lhData:lhEntries},null,2)],{type:"application/json"});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="BBT_Ida_data.json";a.click();
    };
    importBtn.onclick=()=>importFile.click();
    importFile.onchange=e=>{
      const f=e.target.files[0];if(!f)return;
      const r=new FileReader();r.onload=()=>{const d=JSON.parse(r.result);
        if(d.bbtData)dataEntries=d.bbtData;if(d.lhData)lhEntries=d.lhData;
        localStorage.setItem('bbtData',JSON.stringify(dataEntries));
        localStorage.setItem('lhData',JSON.stringify(lhEntries));
        renderTable();renderLHList();};
      r.readAsText(f);
    };
    clearBtn.onclick=clearData;
    saveBtn.onclick=saveEntry;
    renderTable();
  </script>
</body>
</html>
