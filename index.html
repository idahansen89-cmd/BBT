<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BBT â€“ Ida</title>
  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin-top: 1rem;
      color: #000;
    }

    /* Flikar */
    .tabs {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
      border-bottom: 2px solid #ddd;
    }

    .tab {
      padding: 0.7rem 1.2rem;
      cursor: pointer;
      border: none;
      background: #f4f4f4;
      border-radius: 8px 8px 0 0;
      margin: 0 0.3rem;
      font-weight: 600;
    }

    .tab.active {
      background: #fff;
      border-bottom: 2px solid #fff;
      color: #e06b8f;
    }

    .tab-content {
      display: none;
      padding: 1rem;
      max-width: 750px;
      margin: auto;
      border: 1px solid #eee;
      border-radius: 10px;
    }

    .tab-content.active {
      display: block;
    }

    label {
      display: inline-block;
      width: 130px;
      font-weight: 500;
      margin-bottom: 0.2rem;
    }

    input, select, textarea {
      width: calc(100% - 140px);
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }

    textarea { resize: vertical; }

    .button {
      background: #f4b6c2;
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      margin: 0.3rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .button:hover { background: #e599ab; }
    .button.danger { background: #f4b6c2; color: #000; }
    .button.danger:hover { background: #e599ab; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      text-align: center;
      white-space: nowrap;
    }

    tr.mens-row { background-color: #ffe5ec; }

    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }

    #bbtChart {
      width: 100%;
      height: 420px;
    }

    .bottom-buttons {
      text-align: center;
      margin-top: 1rem;
    }

    .symbol-checkbox {
      display: inline-block;
      margin-right: 1rem;
      font-size: 1.2rem;
      vertical-align: middle;
    }

    /* LH-flik layout */
    .lh-image {
      width: 100%;
      border-radius: 6px;
      margin-top: 8px;
    }

    .lh-entry {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 8px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }

    .lh-info { flex-grow: 1; margin-left: 10px; }
    .lh-symbols { font-size: 1.1rem; line-height: 1.5rem; }
    .lh-symbol-checkbox {
      display: inline-block;
      text-align: center;
      margin-right: 0.4rem;
      font-size: 1.4rem;
    }
  </style>
</head>
<body>
  <h1>BBT â€“ Ida</h1>

  <div class="tabs">
    <button class="tab active" onclick="openTab('inmatning')">Inmatning & Tabell</button>
    <button class="tab" onclick="openTab('graf')">ğŸ“ˆ Graf</button>
    <button class="tab" onclick="openTab('lh')">ğŸ§ª LH-test</button>
  </div>

  <!-- Inmatning & Tabell -->
  <div id="inmatning" class="tab-content active">
    <div>
      <label>Datum:</label><input type="date" id="date"><br>
      <label>Tid (BBT):</label><input type="time" id="time"><br>
      <label>Faktisk temp (Â°C):</label><input type="number" step="0.01" id="actual"><br>
      <label>Korrigerad temp (Â°C):</label><input type="number" step="0.01" id="corrected" placeholder="BerÃ¤knas automatiskt"><br>
      <label>Mensstatus:</label>
      <select id="mens"><option>â€“</option><option>Mens</option></select><br>
      <label>Sekret:</label>
      <select id="mucus">
        <option>â€“</option><option>Klart</option><option>Ã„ggviteliknande</option><option>KrÃ¤mig</option>
      </select><br>
      <label>LH-test:</label>
      <select id="lh"><option>â€“</option><option>Positivt</option><option>Negativt</option></select><br>
      <div>
        <span class="symbol-checkbox" title="Samlag">ğŸ’ <input type="checkbox" id="sex"></span>
        <span class="symbol-checkbox" title="BekrÃ¤ftad Ã¤gglossning">ğŸŒ¼ <input type="checkbox" id="ovulation"></span>
      </div>
      <label>Anteckning:</label><textarea rows="2" id="note"></textarea><br>

      <button class="button" id="saveBtn">Spara</button>
      <button class="button" id="exportBtn">Exportera data</button>
      <button class="button" id="importBtn">Importera data</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Datum</th><th>Tid</th><th>Faktisk</th><th>Korr</th>
            <th>Mens</th><th>Sekret</th><th>LH</th><th>ğŸ’</th><th>ğŸŒ¼</th><th>Anteckning</th><th>âœï¸</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="bottom-buttons">
      <button class="button danger" id="clearBtn">Rensa all data</button>
    </div>
  </div>

  <!-- Graf -->
  <div id="graf" class="tab-content">
    <canvas id="bbtChart"></canvas>
  </div>

  <!-- LH-test flik -->
  <div id="lh" class="tab-content">
    <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-bottom:.6rem">
      <div>
        <button class="button" id="lhPickBtn">VÃ¤lj bild</button>
        <input type="file" id="lhFile" accept="image/*" style="display:none">
      </div>
      <input type="date" id="lhDate" style="width:auto">
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:10px;margin:.4rem 0 .6rem">
      <label class="lh-symbol-checkbox" title="NÃ¤stan positiv">ğŸ©·<br><input type="checkbox" class="lhSym" value="ğŸ©·"></label>
      <label class="lh-symbol-checkbox" title="LH-topp">â¤ï¸<br><input type="checkbox" class="lhSym" value="â¤ï¸"></label>
      <label class="lh-symbol-checkbox" title="HÃ¶g">ğŸ’œ<br><input type="checkbox" class="lhSym" value="ğŸ’œ"></label>
      <label class="lh-symbol-checkbox" title="LÃ¥g">ğŸ’™<br><input type="checkbox" class="lhSym" value="ğŸ’™"></label>
      <label class="lh-symbol-checkbox" title="Negativ">ğŸ’š<br><input type="checkbox" class="lhSym" value="ğŸ’š"></label>
      <label class="lh-symbol-checkbox" title="Oklart">ğŸ’›<br><input type="checkbox" class="lhSym" value="ğŸ’›"></label>
    </div>

    <div style="display:flex;gap:.5rem;align-items:center">
      <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
      <button class="button" id="lhSaveBtn">Spara</button>
    </div>

    <div id="lhList" style="margin-top:10px"></div>
  </div>

  <script>
    let dataEntries = JSON.parse(localStorage.getItem('bbtData') || '[]');
    let lhEntries   = JSON.parse(localStorage.getItem('lhData')  || '[]');
    let chart;

    function openTab(tabId) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add("active");
      document.getElementById(tabId).classList.add("active");
      if (tabId === 'graf') renderChart();
      if (tabId === 'lh')   renderLHList();
    }

    function minutesFrom0400(timeStr) {
      if (!timeStr) return 0;
      const [hh, mm] = timeStr.split(':').map(Number);
      return (hh * 60 + mm) - 240;
    }

    function computeCorrected() {
      const a = parseFloat(actual.value);
      if (isNaN(a)) return;
      const mins = minutesFrom0400(time.value || "04:00");
      const corr = a + 0.05 * (mins / 30);
      corrected.value = corr.toFixed(2);
    }

    actual.addEventListener('blur', computeCorrected);
    time.addEventListener('change', () => { if (actual.value) computeCorrected(); });

    function saveEntry() {
      const entry = {
        date: date.value,
        time: time.value,
        actual: Number(actual.value) || null,
        corrected: Number(corrected.value) || null,
        mens: mens.value,
        mucus: mucus.value,
        lh: lh.value,
        sex: sex.checked,
        ovulation: ovulation.checked,
        note: note.value
      };
      if (!entry.date) return alert("VÃ¤lj datum.");
      const i = dataEntries.findIndex(e => e.date === entry.date);
      if (i >= 0) dataEntries[i] = entry; else dataEntries.push(entry);
      localStorage.setItem('bbtData', JSON.stringify(dataEntries));
      renderTable();
    }

    function renderTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      dataEntries.sort((a,b)=>a.date.localeCompare(b.date));
      dataEntries.forEach((e,i)=>{
        const tr = document.createElement("tr");
        if (e.mens === "Mens") tr.classList.add("mens-row");
        tr.innerHTML = `
          <td>${e.date||""}</td><td>${e.time||""}</td><td>${e.actual??""}</td>
          <td>${e.corrected??""}</td><td>${e.mens||"â€“"}</td><td>${e.mucus||"â€“"}</td>
          <td>${e.lh||"â€“"}</td><td>${e.sex?"ğŸ’":""}</td><td>${e.ovulation?"ğŸŒ¼":""}</td>
          <td>${e.note||""}</td><td><button class="button" onclick="editEntry(${i})">âœï¸</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function editEntry(i){
      const e=dataEntries[i];
      date.value=e.date||""; time.value=e.time||"";
      actual.value=e.actual??""; corrected.value=e.corrected??"";
      mens.value=e.mens||"â€“"; mucus.value=e.mucus||"â€“"; lh.value=e.lh||"â€“";
      sex.checked=!!e.sex; ovulation.checked=!!e.ovulation; note.value=e.note||"";
    }

    function clearData(){
      if(!confirm("Vill du verkligen rensa all data?"))return;
      dataEntries=[]; lhEntries=[];
      localStorage.clear();
      renderTable(); renderLHList(); if(chart)chart.destroy();
    }

    function renderChart(){
      if(chart)chart.destroy();
      const ctx=document.getElementById('bbtChart');
      dataEntries.sort((a,b)=>a.date.localeCompare(b.date));
      const labels=dataEntries.map(e=>e.date);
      const actualData=dataEntries.map(e=>e.actual);
      const correctedData=dataEntries.map(e=>e.corrected);
      const ovIndex=dataEntries.findIndex(e=>e.ovulation);
      const preOv=(ovIndex>0?actualData.slice(0,ovIndex):actualData).filter(v=>typeof v==="number");
      const avg=preOv.length?preOv.reduce((a,b)=>a+b,0)/preOv.length:null;
      const ann=[];
      const firstNon=dataEntries.findIndex(e=>e.mens!=="Mens");
      const end=(firstNon===-1)?dataEntries.length-0.5:firstNon-0.5;
      if(firstNon!==0){ann.push({type:'box',xMin:0,xMax:end,backgroundColor:'rgba(255,230,230,.3)',borderWidth:0});}
      if(ovIndex>-1){ann.push({type:'box',xMin:ovIndex+0.5,xMax:labels.length-0.5,backgroundColor:'rgba(230,210,255,.25)',borderWidth:0});}
      const sym=dataEntries.map(e=>{const s=[];if(e.sex)s.push("ğŸ’");if(e.ovulation)s.push("ğŸŒ¼");if(e.mucus==="Ã„ggviteliknande")s.push("ğŸ’§");return s;});
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[
        {label:"Faktisk temperatur",data:actualData,borderColor:"#3b82f6",backgroundColor:"#3b82f6",spanGaps:true,tension:0.3},
        {label:"Korrigerad temperatur",data:correctedData,borderColor:"#ef4444",backgroundColor:"#ef4444",borderDash:[4,4],spanGaps:true,tension:0.3},
        ...(avg?[{label:"Medel fÃ¶re Ã¤gglossning",data:Array(labels.length).fill(avg),borderColor:"#888",borderDash:[5,5],pointRadius:0,fill:false}]:[])
      ]},options:{scales:{y:{min:35,max:38.5,title:{display:true,text:"Temperatur (Â°C)"}},x:{ticks:{autoSkip:false,maxRotation:0}}},plugins:{legend:{position:'bottom',labels:{color:'#000'}},annotation:{annotations:ann}},animation:false},
      plugins:[{id:'symbols',afterDatasetsDraw(c){const ctx=c.ctx;ctx.font="10px sans-serif";ctx.textAlign="center";const m=c.getDatasetMeta(0);c.data.labels.forEach((_,i)=>{const p=m.data[i];if(!p)return;const x=p.x,y=c.scales.y.bottom-18;if(sym[i]?.length){sym[i].forEach((sm,j)=>ctx.fillText(sm,x,y-(j*13)));}});}}]});
    }

    function exportAll(){
      const o={version:"1.0",exported_at:new Date().toISOString(),bbtData:dataEntries,lhData:lhEntries};
      const blob=new Blob([JSON.stringify(o,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      const d=new Date();a.href=url;
      a.download=`BBT_Ida_cykel_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.json`;
      a.click();URL.revokeObjectURL(url
