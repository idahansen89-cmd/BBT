<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BBT â€“ Ida</title>
  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background: #fff;
      color: #333;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin-top: 1rem;
      color: #333;
    }

    /* Flikar */
    .tabs {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
      border-bottom: 2px solid #ddd;
    }

    .tab {
      padding: 0.7rem 1.2rem;
      cursor: pointer;
      border: none;
      background: #f4f4f4;
      border-radius: 8px 8px 0 0;
      margin: 0 0.3rem;
      font-weight: 600;
    }

    .tab.active {
      background: #fff;
      border-bottom: 2px solid #fff;
      color: #e06b8f;
    }

    .tab-content {
      display: none;
      padding: 1rem;
      max-width: 750px;
      margin: auto;
      border: 1px solid #eee;
      border-radius: 10px;
    }

    .tab-content.active {
      display: block;
    }

    label {
      display: inline-block;
      width: 130px;
      font-weight: 500;
      margin-bottom: 0.2rem;
    }

    input, select, textarea {
      width: calc(100% - 140px);
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }

    textarea {
      resize: vertical;
    }

    .button {
      background: #f4b6c2;
      color: #333;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      margin: 0.3rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .button:hover {
      background: #e599ab;
    }

    .button.danger {
      background: #f4b6c2;
      color: #333;
    }

    .button.danger:hover {
      background: #e599ab;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      text-align: center;
    }

    tr.mens-row {
      background-color: #ffe5ec;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }

    #bbtChart {
      width: 100%;
      height: 420px;
    }

    .bottom-buttons {
      text-align: center;
      margin-top: 1rem;
    }

    .symbol-checkbox {
      display: inline-block;
      margin-right: 1rem;
      font-size: 1.2rem;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>BBT â€“ Ida</h1>

  <div class="tabs">
    <button class="tab active" onclick="openTab('inmatning')">Inmatning & Tabell</button>
    <button class="tab" onclick="openTab('graf')">ğŸ“ˆ Graf</button>
  </div>

  <div id="inmatning" class="tab-content active">
    <div>
      <label>Datum:</label><input type="date" id="date"><br>
      <label>Tid (BBT):</label><input type="time" id="time"><br>
      <label>Faktisk temp (Â°C):</label><input type="number" step="0.01" id="actual"><br>
      <label>Korrigerad temp (Â°C):</label><input type="number" step="0.01" id="corrected"><br>
      <label>Mensstatus:</label>
      <select id="mens">
        <option>â€“</option>
        <option>Mens</option>
      </select><br>
      <label>Sekret:</label>
      <select id="mucus">
        <option>â€“</option>
        <option>Klart</option>
        <option>Ã„ggviteliknande</option>
        <option>Grumligt</option>
      </select><br>
      <label>LH-test:</label>
      <select id="lh">
        <option>â€“</option>
        <option>Positivt</option>
        <option>Negativt</option>
      </select><br>
      <div>
        <span class="symbol-checkbox">ğŸ’ <input type="checkbox" id="sex"></span>
        <span class="symbol-checkbox">ğŸŒ¼ <input type="checkbox" id="ovulation"></span>
      </div>
      <label>Anteckning:</label><textarea rows="2" id="note"></textarea><br>
      <button class="button" onclick="saveEntry()">Spara</button>
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Datum</th><th>Tid</th><th>Faktisk</th><th>Korr</th>
            <th>Mens</th><th>Sekret</th><th>LH</th><th>ğŸ’</th><th>ğŸŒ¼</th><th>Anteckning</th><th>âœï¸</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="bottom-buttons">
      <button class="button danger" onclick="clearData()">Rensa all data</button>
    </div>
  </div>

  <div id="graf" class="tab-content">
    <canvas id="bbtChart"></canvas>
  </div>

  <script>
    let dataEntries = JSON.parse(localStorage.getItem('bbtData') || '[]');
    let chart;

    function openTab(tabId) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add("active");
      document.getElementById(tabId).classList.add("active");
      if (tabId === 'graf') renderChart();
    }

    function saveEntry() {
      const entry = {
        date: date.value,
        time: time.value,
        actual: parseFloat(actual.value) || null,
        corrected: parseFloat(corrected.value) || null,
        mens: mens.value,
        mucus: mucus.value,
        lh: lh.value,
        sex: sex.checked,
        ovulation: ovulation.checked,
        note: note.value
      };
      const existingIndex = dataEntries.findIndex(e => e.date === entry.date);
      if (existingIndex >= 0) dataEntries[existingIndex] = entry;
      else dataEntries.push(entry);
      localStorage.setItem('bbtData', JSON.stringify(dataEntries));
      renderTable();
    }

    function renderTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      dataEntries.forEach((e, i) => {
        const tr = document.createElement("tr");
        if (e.mens === "Mens") tr.classList.add("mens-row");
        tr.innerHTML = `
          <td>${e.date}</td><td>${e.time || ""}</td><td>${e.actual || ""}</td>
          <td>${e.corrected || ""}</td><td>${e.mens || "â€“"}</td>
          <td>${e.mucus || "â€“"}</td><td>${e.lh || "â€“"}</td>
          <td>${e.sex ? "ğŸ’" : ""}</td><td>${e.ovulation ? "ğŸŒ¼" : ""}</td>
          <td>${e.note || ""}</td>
          <td><button class="button" onclick="editEntry(${i})">âœï¸</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function editEntry(i) {
      const e = dataEntries[i];
      date.value = e.date;
      time.value = e.time;
      actual.value = e.actual;
      corrected.value = e.corrected;
      mens.value = e.mens;
      mucus.value = e.mucus;
      lh.value = e.lh;
      sex.checked = e.sex;
      ovulation.checked = e.ovulation;
      note.value = e.note;
    }

    function clearData() {
      if (confirm("Vill du verkligen rensa all data?")) {
        dataEntries = [];
        localStorage.removeItem('bbtData');
        renderTable();
        if (chart) chart.destroy();
      }
    }

    function renderChart() {
      if (chart) chart.destroy();
      const ctx = document.getElementById('bbtChart');

      const labels = dataEntries.map(e => e.date);
      const actualData = dataEntries.map(e => e.actual);
      const correctedData = dataEntries.map(e => e.corrected);

      const ovulationIndex = dataEntries.findIndex(e => e.ovulation);
      const preOvData = actualData.slice(0, ovulationIndex > 0 ? ovulationIndex : actualData.length);
      const avgPreOv = preOvData.filter(Boolean).reduce((a, b) => a + b, 0) / preOvData.filter(Boolean).length;

      const annotations = [];

      // Rosa bakgrund fÃ¶r mens
      annotations.push({
        type: 'box',
        xMin: 0,
        xMax: dataEntries.findIndex(e => e.mens !== "Mens") - 0.5 || 0,
        backgroundColor: 'rgba(255, 230, 230, 0.3)',
        borderWidth: 0
      });

      // Lila bakgrund fÃ¶r lutealfas
      if (ovulationIndex > 0) {
        annotations.push({
          type: 'box',
          xMin: ovulationIndex + 0.5,
          xMax: actualData.length - 0.5,
          backgroundColor: 'rgba(230, 210, 255, 0.25)',
          borderWidth: 0
        });
      }

      const symbols = dataEntries.map((e) => {
        let s = [];
        if (e.sex) s.push("ğŸ’");
        if (e.ovulation) s.push("ğŸŒ¼");
        if (e.mucus === "Ã„ggviteliknande") s.push("ğŸ’§");
        return s;
      });

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: "Faktisk temperatur",
              data: actualData,
              borderColor: "#3b82f6",
              backgroundColor: "#3b82f6",
              tension: 0.3
            },
            {
              label: "Korrigerad temperatur",
              data: correctedData,
              borderColor: "#ef4444",
              backgroundColor: "#ef4444",
              borderDash: [4, 4],
              tension: 0.3
            },
            {
              label: "Medel fÃ¶re Ã¤gglossning",
              data: Array(actualData.length).fill(avgPreOv),
              borderColor: "#888",
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          scales: {
            y: { min: 35, max: 38.5, title: { display: true, text: "Temperatur (Â°C)" } },
          },
          plugins: {
            legend: { 
              position: 'bottom', 
              labels: { 
                boxWidth: 12, 
                color: '#000' 
              } 
            },
            annotation: { annotations },
            tooltip: { enabled: false },
          },
          animation: false
        },
        plugins: [{
          id: 'symbols',
          afterDatasetsDraw(chart) {
            const ctx = chart.ctx;
            ctx.font = "10px sans-serif";
            ctx.textAlign = "center";
            chart.data.labels.forEach((label, i) => {
              const meta = chart.getDatasetMeta(0);
              const x = meta.data[i]?.x;
              const yAxis = chart.scales.y;
              const y = yAxis.bottom - 18;
              if (symbols[i]?.length) {
                symbols[i].forEach((sym, idx) => {
                  ctx.fillText(sym, x, y - (idx * 13));
                });
              }
            });
          }
        }]
      });
    }

    renderTable();
  </script>
</body>
</html>
