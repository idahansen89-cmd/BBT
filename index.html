<!DOCTYPE html>
<html lang="sv">
<head>
  <link rel="apple-touch-icon" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BBT Tracker – Ida</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family:"Helvetica Neue",Arial,sans-serif;
  margin:20px;
  background:#fff;
  color:#333;
}
h1{text-align:center;margin-bottom:20px;}
.container{max-width:760px;margin:0 auto;}
label{display:block;font-weight:600;margin-top:10px;}
input,select,textarea{
  width:100%;padding:6px;margin-top:4px;
  border:1px solid #ccc;border-radius:6px;font-size:15px;
}
button{
  margin-top:12px;padding:10px 16px;border:none;
  background:#007aff;color:#fff;font-weight:bold;
  border-radius:8px;cursor:pointer;
}
button:hover{background:#005ecb;}
#chartContainer{margin-top:35px;}
.legend{text-align:center;margin-top:10px;font-size:14px;}
.legend span{margin:0 8px;display:inline-block;}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:4px;}
<style>
/* --- Rosa tema för knappar --- */
button {
  background-color: #f7b2c4;      /* mjuk rosa */
  color: white;                   /* vit text */
  border: none;                   
  border-radius: 6px;             /* rundade hörn */
  padding: 8px 14px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
}

/* När man håller över knappen */
button:hover {
  background-color: #f48aa8;      /* lite mörkare rosa */
  transform: scale(1.03);
}

/* När man trycker ner */
button:active {
  background-color: #e86c93;
  transform: scale(0.98);
}
</style>
</style>
</head>
<body>
<div class="container">
  <h1>BBT Tracker – Ida</h1>

  <label>Datum</label>
  <input type="date" id="datum">

  <label>Tid (BBT)</label>
  <input type="time" id="tid">

  <label>Faktisk temperatur (°C)</label>
  <input type="number" id="faktisk" step="0.01" placeholder="t.ex. 36.31">

  <label>Korrigerad temperatur (°C)</label>
  <input type="number" id="korr" step="0.01" placeholder="t.ex. 36.45">
  <button onclick="calcCorr()">Räkna ut korrigerad</button>

  <label>Mensstatus</label>
  <select id="mens">
    <option>Ingen</option><option>Mens</option><option>Spotting</option>
  </select>

  <label>Sekret</label>
  <select id="sekret">
    <option>-</option><option>Krämigt</option><option>Klart</option><option>Torrt</option>
  </select>

  <label>LH-test</label>
  <select id="lh">
    <option>-</option><option>Negativt</option><option>Positivt</option>
  </select>

  <label>Anteckning (valfritt)</label>
  <textarea id="anteckning" rows="2" placeholder="Sömn, sjukdom, värk m.m."></textarea>

  <label>Ägglossningsdatum</label>
  <input type="date" id="ovulationDate">

  <button onclick="addEntry()">Spara</button>
  <button onclick="exportJSON()">Exportera JSON</button>
  <button onclick="importJSON()">Importera JSON</button>
  <button onclick="clearAllData()">Rensa all data</button>
  
  <div id="chartContainer">
    <canvas id="bbtChart"></canvas>
    <div class="legend">
      <span><span class="dot" style="background:#007aff"></span>Faktisk</span>
      <span><span class="dot" style="background:#e74c3c"></span>Korrigerad</span>
      <span><span class="dot" style="background:#6fd3ff"></span>Klart sekret</span>
      <span><span class="dot" style="background:#ffb3b3"></span>Mensdag</span>
      <span><span class="dot" style="background:#999"></span>Prognos</span>
    </div>
  </div>
</div>

<script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== Hjälpare ===== */
const $ = id => document.getElementById(id);

/* ===== Lagring ===== */
function loadData(){
  try { return JSON.parse(localStorage.getItem('bbtData')||'[]'); }
  catch { return []; }
}
function saveData(rows){
  localStorage.setItem('bbtData', JSON.stringify(rows));
}

let bbtData = loadData();

/* ===== UI: lägg till post ===== */
function addEntry(){
  const entry = {
    datum: $('datum').value,
    tid: $('tid').value,
    faktisk: parseFloat($('faktisk').value),
    korr: parseFloat($('korr').value),
    mens: $('mens').value,
    sekret: $('sekret').value,
    lh: $('lh').value,
    anteckning: $('anteckning').value?.trim() || ''
  };

  if (!entry.datum || !entry.tid || isNaN(entry.faktisk)) {
    alert('Fyll i minst Datum, Tid och Faktisk temperatur.'); return;
  }
  // Om korr saknas: räkna fram från tid/faktisk (0,05 °C/30 min från 04:00)
  if (isNaN(entry.korr)) {
    const [h,m] = entry.tid.split(':').map(Number);
    const mins = (h*60+m) - (4*60);
    const steps = Math.abs(mins)/30;
    entry.korr = +(entry.faktisk + (mins<0 ? steps*0.05 : -steps*0.05)).toFixed(2);
    $('korr').value = entry.korr.toFixed(2);
  }

  // Uppdatera post per datum (ersätt om samma datum redan finns)
  const i = bbtData.findIndex(r => r.datum === entry.datum);
  if (i >= 0) bbtData[i] = entry; else bbtData.push(entry);

  // Sortera stigande på datum
  bbtData.sort((a,b)=> a.datum.localeCompare(b.datum));

  saveData(bbtData);
  renderChart();

  // (valfritt) töm fält efter spar
  // $('faktisk').value=''; $('korr').value='';
  // $('anteckning').value='';
}

/* ===== Export / Import ===== */
function exportJSON(){
  const blob = new Blob([JSON.stringify(bbtData,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bbtData.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
function importJSON(){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json';
  input.onchange = e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const data = JSON.parse(r.result);
        if (!Array.isArray(data)) throw new Error('Fel format');
        bbtData = data;
        saveData(bbtData);
        renderChart();
      } catch (err) { alert('Kunde inte importera: ' + err.message); }
    };
    r.readAsText(f);
  };
  input.click();
}

/* ===== Auto-korrigering (knappen) ===== */
function calcCorr(){
  const time = $('tid').value;
  const temp = parseFloat($('faktisk').value);
  if(!time || isNaN(temp)){ alert('Fyll i tid och temperatur.'); return; }
  const [h,m] = time.split(':').map(Number);
  const mins = (h*60+m) - (4*60);
  const steps = Math.abs(mins)/30;
  const corr = temp + (mins<0 ? steps*0.05 : -steps*0.05);
  $('korr').value = corr.toFixed(2);
}

/* ===== DPO ===== */
function getOvulationDate(){
  const v = $('ovulationDate')?.value;
  return v ? new Date(v) : null;
}
function calculateDPO(data, ov){
  if (!ov) return data.map(()=>null);
  return data.map(r=>{
    const d = new Date(r.datum);
    const diff = Math.round((d - ov)/(1000*60*60*24));
    return diff >= 0 ? diff : null;
  });
}

/* ===== Chart ===== */
let chart;
function renderChart(){
  const ctx = document.getElementById('bbtChart').getContext('2d');
  if (chart) chart.destroy();

  const labels = bbtData.map(d=>d.datum);
  const faktisk = bbtData.map(d=>isFinite(d.faktisk)?d.faktisk:null);
  const korr = bbtData.map(d=>isFinite(d.korr)?d.korr:null);

  const ov = getOvulationDate();
  const dpoLabels = calculateDPO(bbtData, ov);

  const mensMask = bbtData.map(d=>d.mens==='Mens'||d.mens==='Spotting');
  const sekretIdx = bbtData.map((d,i)=> d.sekret==='Klart' ? i : null).filter(i=>i!==null);

  // Prognos (diskret): trend + snitt på senaste 3 korr
  let forecast = null;
  const last3 = korr.filter(x=>x!=null).slice(-3);
  if (last3.length >= 2) {
    const avg = last3.reduce((a,b)=>a+b,0)/last3.length;
    const slope = last3[last3.length-1] - last3[0]; // enkel trend
    const adjust = Math.max(-0.05, Math.min(0.05, slope/last3.length)); // mjuk justering
    forecast = +(avg + adjust).toFixed(2);
  }

  const mensBG = {
    id:'mensBG',
    beforeDatasetsDraw(c){
      const {ctx, chartArea:{left,right,top,bottom}, scales:{x}} = c;
      if(!labels.length) return;
      const w=(right-left)/labels.length;
      ctx.save();
      for(let i=0;i<labels.length;i++){
        if(mensMask[i]){
          const xc = x.getPixelForValue(i);
          ctx.fillStyle = '#ffe6e680';
          ctx.fillRect(xc-w/2, top, w, bottom-top);
        }
      }
      ctx.restore();
    }
  };

  chart = new Chart(ctx, {
    type:'line',
    data:{
      labels:[...labels, forecast!==null ? 'Prognos' : ''],
      datasets:[
        {label:'Faktisk', data:[...faktisk, null], borderColor:'#007aff', backgroundColor:'#007aff', tension:0.3, fill:false, pointStyle:'circle'},
        {label:'Korrigerad', data:[...korr, null], borderColor:'#e74c3c', backgroundColor:'#e74c3c', borderDash:[4,4], tension:0.3, fill:false, pointStyle:'triangle'},
        {label:'Klart sekret', data:sekretIdx.map(i=>({x:i,y:35.85})), showLine:false, pointRadius:5, pointBackgroundColor:'#6fd3ff'},
        {label:'Prognos', data:[...Array(labels.length).fill(null), forecast], borderColor:'#999', borderDash:[2,2], pointRadius:4, pointBackgroundColor:'#999'}
      ]
    },
    options:{
      layout:{padding:{left:30,right:10,top:10,bottom:10}},
      plugins:{legend:{position:'bottom',labels:{font:{size:12}}}},
      scales:{
        y:{min:35.8,max:37.2,title:{display:true,text:'Temperatur (°C)',color:'#333',font:{size:13,weight:'600'}},
           grid:{color:'#eeeeee',lineWidth:0.8}, border:{display:true,color:'#999',width:1}, ticks:{stepSize:0.1,color:'#444'}},
        x:{ticks:{autoSkip:false,maxRotation:45,minRotation:45,color:'#444'}, grid:{color:'#f5f5f5'}, border:{display:true,color:'#999',width:1}}
      },
      plugins:[mensBG,{
        id:'dpoLabels',
        afterDatasetsDraw(chart){
          const {ctx} = chart;
          ctx.save();
          ctx.font = '10px sans-serif';
          ctx.fillStyle = '#999';
          chart.getDatasetMeta(0).data.forEach((pt,i)=>{
            const dpo = dpoLabels[i];
            if(dpo!==null && pt && isFinite(pt.x) && isFinite(pt.y)){
              ctx.beginPath();
              ctx.arc(pt.x, pt.y-12, 10, 0, 2*Math.PI);
              ctx.fillStyle='#f4f4f4';
              ctx.fill();
              ctx.fillStyle='#555';
              ctx.textAlign='center';
              ctx.fillText(String(dpo), pt.x, pt.y-9);
            }
          });
          ctx.restore();
        }
      }]
    }
  });
}

/* ===== Event-bindningar ===== */
window.addEventListener('load', renderChart);
function clearAllData() {
  if (confirm("Är du säker på att du vill ta bort alla sparade temperaturer?")) {
    localStorage.removeItem('bbtData');
    bbtData = [];
    renderChart();
    alert("All data har rensats. Grafen är nu tom.");
  }
}
</script>
</body>
</html>
