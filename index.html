<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBT & LH</title>
  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
 <style>
 :root {
  /* üåà Pastellregnb√•ge ‚Äì Idas f√§rgtema */
  --pink:       #f4b6c2;
  --apricot:    #f7c8a0;
  --yellow:     #fff4b0;
  --mint:       #baf2bb;
  --blue:       #a8d8ff;
  --lavender:   #e0c3fc;
  --pearl:      #f5f5fa;

  /* Extra nyanser & standardf√§rger */
  --pink-hover: #e599ab;
  --lavender-dark: #c7aef9;
  --blue-dark: #6baaf0;
  --text: #333;
  --line: #eee;
}

  * { box-sizing: border-box; }
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    color: var(--text);
    background: #fff;
  }
  h1 { text-align: center; margin: 1rem 0; }

  /* ===== Tabs ===== */
  .tabs {
    display: flex;
    justify-content: center;
    gap: 0.4rem;
    border-bottom: 2px solid #ddd;
    padding-bottom: 0.4rem;
  }
  .tab {
    padding: 0.7rem 1.2rem;
    border: none;
    border-radius: 8px 8px 0 0;
    background: #f4f4f4;
    font-weight: 600;
    cursor: pointer;
  }
  .tab.active {
    background: #fff;
    border-bottom: 2px solid #fff;
    color: #e06b8f;
  }

  .tab-content {
    display: none;
    max-width: 820px;
    margin: 1rem auto;
    padding: 1rem;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: #fff;
  }
  .tab-content.active { display: block; }

  /* ===== Form ===== */
  .form-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 0.6rem;
  }
  .form-row label {
    width: 160px;
    font-weight: 600;
  }
  .form-row input,
  .form-row select,
  .form-row textarea {
    flex: 1;
    padding: 0.45rem 0.6rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 0.95rem;
  }
  textarea { resize: vertical; min-height: 56px; }

  .inline-symbols {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 0.4rem 0 0.6rem;
    flex-wrap: wrap;
  }
  .inline-symbols .symbol {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 1.1rem;
  }

  /* ===== Buttons ===== */
  .button {
    background: var(--pink);
    color: #222;
    border: none;
    border-radius: 8px;
    padding: 0.55rem 1.1rem;
    font-weight: 700;
    cursor: pointer;
  }
  .button:hover { background: var(--pink-hover); }
  .button.danger:hover { background: var(--pink-hover); }

  /* ===== Kompakt och snygg tabell ===== */
  .table-wrap {
    overflow-x: auto;
    margin-top: 1rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 0.9rem;
  }
  th, td {
    padding: 0.5rem 0.4rem;
    border: 1px solid #ddd;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
    vertical-align: middle;
  }
  thead th {
    background: #fdf5f7;
    color: #444;
    font-weight: 700;
  }
  tbody tr:nth-child(even) { background-color: #f9f9f9; }

  /* Rosa bakgrund f√∂r mens */
  tbody tr.mens-row {
    background-color: #ffeaf0 !important;
  }

  /* Datum och tid */
  th:nth-child(1), td:nth-child(1) { width: 85px; }
  th:nth-child(2), td:nth-child(2) { width: 70px; }

  /* Temperaturkolumner */
  th:nth-child(3), td:nth-child(3),
  th:nth-child(4), td:nth-child(4) { width: 70px; }

  /* Sekret */
  th:nth-child(5), td:nth-child(5) { width: 85px; }

  /* H√§ndelser (üíûüåºü©∏) */
  th:nth-child(6), td:nth-child(6) {
    width: 90px;
    font-size: 1.1rem;
    letter-spacing: 2px;
  }

  /* Anteckning */
  th:nth-child(7), td:nth-child(7) {
    width: 150px;
    text-align: left;
  }

  /* Knappar */
  th:nth-child(8), td:nth-child(8) {
    width: 70px;
    text-align: center;
  }
  .table-btn {
    border: none;
    background: var(--pink);
    border-radius: 6px;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
  }
  .table-btn:hover { background: var(--pink-hover); }

  /* ===== Chart ===== */
  #chartContainer {
    width: 100%;
    max-width: 1200px;
    height: 520px;
    margin: auto;
    overflow: hidden;
    position: relative;
  }
  #bbtChart {
    display: block;
    width: 100% !important;
    height: 100% !important;
  }
  .chart-toolbar { display: flex; justify-content: center; margin-top: 0.75rem; }

  /* ===== LH-flik ===== */
  .lh-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.6rem;
    flex-wrap: wrap;
  }
  .lh-symbols-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    align-items: center;
  }
  .lh-symbol-checkbox {
    display: inline-block;
    text-align: center;
    font-size: 1.25rem;
    line-height: 1.15;
  }
  .lh-symbol-checkbox small {
    display: block;
    color: #777;
    font-size: 0.75rem;
    margin-top: 0.1rem;
  }
  .lh-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.6rem;
    padding: 0.45rem 0;
    border-bottom: 1px solid #eee;
  }
  .lh-img {
    width: 100%;
    max-height: 110px;
    object-fit: contain;
    border-radius: 8px;
    background: #fff;
  }
  .lh-info { flex: 1; font-size: 0.92rem; }
  .lh-fm-em {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-left: 1.4rem;
  }
  .lh-preview {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin: 0.4rem 0;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 0.4rem;
  }
  .lh-preview img {
    width: 74px;
    height: 56px;
    object-fit: cover;
    border-radius: 6px;
  }
  .lh-preview small {
    color: #444;
    line-height: 1.2;
    font-size: 0.82rem;
  }

  /* ===== Small helpers ===== */
  .muted { color: #666; font-size: 0.9rem; }

  /* ===== Mobilanpassning ===== */
  @media (max-width: 600px) {
    th, td {
      font-size: 0.8rem;
      padding: 0.35rem 0.25rem;
    }
    td:nth-child(7) {
      max-width: 90px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  [data-field="events"], [data-field="lh"] {
    font-size: 1.2rem;
    letter-spacing: 2px;
  }

  tbody tr.mens-row {
    background-color: #ffe8ee !important;
  }

  /* === Symbolrad (h√§ndelser) === */
  .symbols-row {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 1.2rem;
    margin: 1rem 0 0.8rem;
    flex-wrap: wrap;
  }

  .symbol {
    text-align: center;
    font-size: 1.6rem;
    line-height: 1.1;
  }

  .symbol input[type="checkbox"] {
    display: block;
    margin: 0.25rem auto 0;
    transform: scale(1.3);
  }

  /* Knappar i tabellen */
  td button {
    margin: 0 2px;
    border-radius: 6px;
    background: #f4b6c2;
    border: none;
    color: #222;
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
  }
  td button:hover {
    background: #e599ab;
  }

  /* ===== Symbolrad med h√§ndelser ===== */
  .symbols-row {
    display: flex;
    justify-content: center;
    gap: 14px;
    align-items: flex-start;
    margin: 0.5rem 0 0.25rem;
  }

  .symbol-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 36px;
  }

  .symbol-stack .sym {
    font-size: 1.6rem;
    line-height: 1;
  }

  .symbol-stack input {
    margin-top: 0.25rem;
  }

  /* ===== Tabellrubriker och layout ===== */
  #dataTable th {
    background-color: #ffe5ec;
    color: #333;
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
    padding: 0.4rem 0.3rem;
    white-space: nowrap;
  }

  #dataTable td {
    text-align: center;
    padding: 0.35rem 0.3rem;
    vertical-align: middle;
    font-size: 0.85rem;
  }

  #dataTable th:nth-child(1),
  #dataTable td:nth-child(1) { width: 90px; }
  #dataTable th:nth-child(2),
  #dataTable td:nth-child(2) { width: 65px; }
  #dataTable th:nth-child(3),
  #dataTable th:nth-child(4),
  #dataTable td:nth-child(3),
  #dataTable td:nth-child(4) { width: 55px; }
  #dataTable th:nth-child(5),
  #dataTable td:nth-child(5) { width: 120px; }
  #dataTable th:nth-child(6),
  #dataTable td:nth-child(6) { width: 140px; }
  #dataTable th:nth-child(7),
  #dataTable td:nth-child(7) { width: 100px; }

  /* Gul bakgrund f√∂r √§gglossningsdagar */
  tbody tr.ovulation-row {
    background-color: #fff9d9 !important;
  }
</style>
</head>
<body>
  <h1>BBT & LH</h1>

  <div class="tabs">
    <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
    <button class="tab" data-tab="graf">üìà Graf</button>
    <button class="tab" data-tab="lh">üß™ LH-test</button>
  </div>

  <!-- Inmatning & Tabell -->
  <div id="inmatning" class="tab-content active">
    <div class="form-row">
      <label for="date">Datum:</label>
      <input type="date" id="date">
    </div>
    <div class="form-row">
      <label for="time">Tid (BBT):</label>
      <input type="time" id="time">
    </div>
    <div class="form-row">
      <label for="actual">Faktisk temp (¬∞C):</label>
      <input type="number" step="0.01" id="actual" placeholder="t.ex. 36.42">
    </div>
    <div class="form-row">
      <label for="corrected">Korrigerad temp (¬∞C):</label>
      <input type="number" step="0.01" id="corrected" placeholder="Ber√§knas automatiskt">
    </div>

    <!-- H√§ndelser ‚Äì symboler p√• en rad med kryss under -->
    <div class="symbols-row">
      <div class="symbol-stack">
        <div class="sym">ü©∏</div>
        <input type="checkbox" id="symMens" />
      </div>
      <div class="symbol-stack">
        <div class="sym">üíû</div>
        <input type="checkbox" id="symSex" />
      </div>
      <div class="symbol-stack">
        <div class="sym">üåº</div>
        <input type="checkbox" id="symOv" />
      </div>
      <div class="symbol-stack">
        <div class="sym">üíß</div>
        <input type="checkbox" id="symMucus" />
      </div>
      <div class="symbol-stack">
        <div class="sym">‚ûï</div>
        <input type="checkbox" id="symLHpos" />
      </div>
      <div class="symbol-stack">
        <div class="sym">‚ûñ</div>
        <input type="checkbox" id="symLHneg" />
      </div>
    </div>

    <div class="form-row" style="align-items:flex-start">
      <label for="note" style="margin-top:.2rem">Anteckning:</label>
      <textarea id="note" rows="2" placeholder="Valfritt"></textarea>
    </div>

    <div class="top-buttons">
      <button class="button" id="saveBtn">Spara</button>
      <button class="button" id="exportBtn">Exportera data</button>
      <button class="button" id="importBtn">Importera data</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>

    <div class="table-wrap">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Tid</th>
            <th>F ¬∞C</th>
            <th>K ¬∞C</th>
            <th>H√§ndelser</th>
            <th>Anteckning</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="text-align:center; margin-top:1rem;">
      <button class="button danger" id="clearBtn">Rensa all data</button>
    </div>
  </div>

  <!-- Graf -->
  <div id="graf" class="tab-content">
    <div id="chartContainer">
      <canvas id="bbtChart"></canvas>
    </div>
    <div class="chart-toolbar">
      <button class="button" id="exportChartBtn">Exportera graf</button>
    </div>
  </div>

  <!-- LH-test -->
  <div id="lh" class="tab-content">
    <div class="lh-toolbar">
      <div style="display:flex; gap:.5rem; align-items:center">
        <button class="button" id="lhPickBtn">V√§lj bild</button>
        <input type="file" id="lhFile" accept="image/*" style="display:none">
      </div>
      <input type="date" id="lhDate">
    </div>

    <div class="lh-symbols-row" style="margin:.4rem 0 .3rem">
      <label class="lh-symbol-checkbox" title="N√§stan positiv">ü©∑<small>N</small><br><input type="checkbox" class="lhSym" value="ü©∑"></label>
      <label class="lh-symbol-checkbox" title="LH-topp">‚ù§Ô∏è<small>T</small><br><input type="checkbox" class="lhSym" value="‚ù§Ô∏è"></label>
      <label class="lh-symbol-checkbox" title="H√∂g">üíú<small>H</small><br><input type="checkbox" class="lhSym" value="üíú"></label>
      <label class="lh-symbol-checkbox" title="L√•g">üíô<small>L</small><br><input type="checkbox" class="lhSym" value="üíô"></label>
      <label class="lh-symbol-checkbox" title="Negativ">üíö<small>‚Äì</small><br><input type="checkbox" class="lhSym" value="üíö"></label>
      <label class="lh-symbol-checkbox" title="Oklart">üíõ<small>?</small><br><input type="checkbox" class="lhSym" value="üíõ"></label>

      <!-- FM/EM -->
      <span class="lh-fm-em">
        <label class="lh-symbol-checkbox" title="FM (f√∂rmiddag)">‚òÄÔ∏è<small>FM</small><br><input type="checkbox" id="lhFm"></label>
        <label class="lh-symbol-checkbox" title="EM (eftermiddag/kv√§ll)">üåô<small>EM</small><br><input type="checkbox" id="lhEm"></label>
      </span>
    </div>

    <!-- Liten, icke-st√∂rande f√∂rhandsvisning -->
    <div id="lhPreview" class="lh-preview" style="display:none;">
      <img id="lhPreviewImg" alt="F√∂rhandsvisning">
      <small id="lhPreviewInfo" class="muted"></small>
    </div>

    <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
      <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
      <button class="button" id="lhSaveBtn">Spara</button>
    </div>

    <div id="lhList"></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ===== Tabs ===== */
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.tab;
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(id).classList.add('active');
        if(id==='graf') renderChart();
        if(id==='lh') renderLHList();
      });
    });

    /* ===== Elements ===== */
    const el = {
      date: document.getElementById('date'),
      time: document.getElementById('time'),
      actual: document.getElementById('actual'),
      corrected: document.getElementById('corrected'),
      note: document.getElementById('note'),

      symMens:  document.getElementById('symMens'),
      symSex:   document.getElementById('symSex'),
      symOv:    document.getElementById('symOv'),
      symMucus: document.getElementById('symMucus'),
      symLHpos: document.getElementById('symLHpos'),
      symLHneg: document.getElementById('symLHneg'),

      saveBtn: document.getElementById('saveBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      clearBtn: document.getElementById('clearBtn'),

      dataTableBody: document.querySelector('#dataTable tbody'),
      chartCanvas: document.getElementById('bbtChart'),
      exportChartBtn: document.getElementById('exportChartBtn'),

      lhPickBtn: document.getElementById('lhPickBtn'),
      lhFile: document.getElementById('lhFile'),
      lhDate: document.getElementById('lhDate'),
      lhNote: document.getElementById('lhNote'),
      lhSaveBtn: document.getElementById('lhSaveBtn'),
      lhList: document.getElementById('lhList'),
      lhFm: document.getElementById('lhFm'),
      lhEm: document.getElementById('lhEm'),
      lhPreview: document.getElementById('lhPreview'),
      lhPreviewImg: document.getElementById('lhPreviewImg'),
      lhPreviewInfo: document.getElementById('lhPreviewInfo'),
      lhSymChecks: () => Array.from(document.querySelectorAll('.lhSym:checked'))
    };

    /* ===== State ===== */
    let dataEntries = JSON.parse(localStorage.getItem('bbtData') || '[]');

    // Ny LH-datastruktur: objekt med datum -> lista av poster
    (function migrateLH(){
      const newKey = 'lhDataByDate';
      const oldArr = JSON.parse(localStorage.getItem('lhData') || 'null');
      let obj = JSON.parse(localStorage.getItem(newKey) || 'null');

      if(!obj){
        obj = {};
      }
      if(Array.isArray(oldArr)){
        oldArr.forEach(e=>{
          const d = e.date || 'ok√§nt-datum';
          if(!obj[d]) obj[d] = [];
          obj[d].push({ dataUrl: e.dataUrl, symbols: e.symbols||[], note: e.note||'', tod: null, ts: Date.now() });
        });
        localStorage.removeItem('lhData');
      }
      localStorage.setItem(newKey, JSON.stringify(obj));
    })();

    /* ===== LH positiv/negativ ‚Äì endast ett alternativ √•t g√•ngen ===== */
    el.symLHpos.addEventListener('change', () => {
      if (el.symLHpos.checked) el.symLHneg.checked = false;
    });
    el.symLHneg.addEventListener('change', () => {
      if (el.symLHneg.checked) el.symLHpos.checked = false;
    });

    let lhByDate = JSON.parse(localStorage.getItem('lhDataByDate') || '{}');
    let chart;

    /* ===== Helpers ===== */
    const minutesFrom0400 = (t) => {
      if (!t) return 0;
      const [h, m] = t.split(':').map(Number);
      return (h * 60 + m) - 240;
    };
    function computeCorrectedFrom(a, timeStr) {
      if (Number.isNaN(a)) return null;
      const mins = minutesFrom0400(timeStr || '04:00');
      const corr = a - 0.05 * (mins / 30); // minus efter 04:00, plus f√∂re
      return Number(corr.toFixed(2));
    }
    function computeCorrectedFormInputs() {
      const a = parseFloat(el.actual.value);
      if (Number.isNaN(a)) return;
      const corr = computeCorrectedFrom(a, el.time.value);
      if (corr !== null) el.corrected.value = corr.toFixed(2);
    }

    /* ===== Spara & tabell med nya symboler ===== */
    function saveEntry() {
      const e = {
        date: el.date.value,
        time: el.time.value,
        actual: el.actual.value ? Number(el.actual.value) : null,
        corrected: el.corrected.value ? Number(el.corrected.value) : null,

        mens: el.symMens.checked || false,
        sex: el.symSex.checked || false,
        ovulation: el.symOv.checked || false,
        mucus: el.symMucus.checked || false,
        lhPos: el.symLHpos.checked || false,
        lhNeg: el.symLHneg.checked || false,

        note: el.note.value || ""
      };

      if (!e.date) return alert("V√§lj datum f√∂rst.");

      const i = dataEntries.findIndex(x => x.date === e.date);
      if (i >= 0) dataEntries[i] = e;
      else dataEntries.push(e);

      localStorage.setItem("bbtData", JSON.stringify(dataEntries));

      el.date.value = "";
      el.time.value = "";
      el.actual.value = "";
      el.corrected.value = "";
      el.note.value = "";

      el.symMens.checked = false;
      el.symSex.checked = false;
      el.symOv.checked = false;
      el.symMucus.checked = false;
      el.symLHpos.checked = false;
      el.symLHneg.checked = false;

      renderTable();
      alert("‚úÖ Data sparad!");
    }

    /* ===== Tabellrendering ===== */
    function renderTable() {
      el.dataTableBody.innerHTML = "";
      dataEntries.sort((a, b) => a.date.localeCompare(b.date));

      dataEntries.forEach((e, idx) => {
        const tr = document.createElement("tr");

        if (e.mens) tr.style.backgroundColor = "#ffe8ee";
        if (e.ovulation) tr.classList.add("ovulation-row");
        if (e.mens && e.ovulation) tr.classList.remove("ovulation-row");

        let events = "";
        if (e.mens) events += "ü©∏ ";
        if (e.sex) events += "üíû ";
        if (e.ovulation) events += "üåº ";
        if (e.mucus) events += "üíß ";
        if (e.lhPos) events += "‚ûï ";
        if (e.lhNeg) events += "‚ûñ ";

        tr.innerHTML = `
          <td>${e.date || ""}</td>
          <td>${e.time || ""}</td>
          <td>${e.actual ?? ""}</td>
          <td>${e.corrected ?? ""}</td>
          <td>${events.trim() || "‚Äì"}</td>
          <td>${e.note || ""}</td>
          <td>
            <button class="table-btn small-edit" title="Redigera">‚úèÔ∏è</button>
            <button class="table-btn small-del" title="Radera">üóëÔ∏è</button>
          </td>
        `;

        const delBtn = tr.querySelector(".small-del");
        if (delBtn) {
          delBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();

            let summary = "";
            if (e.mens) summary += "ü©∏ ";
            if (e.sex) summary += "üíû ";
            if (e.ovulation) summary += "üåº ";
            if (e.mucus) summary += "üíß ";
            if (e.lhPos) summary += "‚ûï ";
            if (e.lhNeg) summary += "‚ûñ ";
            summary = summary.trim() || "‚Äì";

            const confirmText = `Vill du ta bort posten den ${e.date}?\n\nH√§ndelser: ${summary}`;
            if (confirm(confirmText)) {
              dataEntries.splice(idx, 1);
              localStorage.setItem("bbtData", JSON.stringify(dataEntries));
              renderTable();
            }
          });
        }

        tr.querySelector(".small-edit").addEventListener("click", () => {
          el.date.value = e.date;
          el.time.value = e.time;
          el.actual.value = e.actual || "";
          el.corrected.value = e.corrected || "";
          el.note.value = e.note || "";

          el.symMens.checked = e.mens || false;
          el.symSex.checked = e.sex || false;
          el.symOv.checked = e.ovulation || false;
          el.symMucus.checked = e.mucus || false;
          el.symLHpos.checked = e.lhPos || false;
          el.symLHneg.checked = e.lhNeg || false;

          alert("Posten laddades f√∂r redigering.");
        });

        el.dataTableBody.appendChild(tr);
      });
    }

    function clearData(){
      if(!confirm('Vill du verkligen rensa all data?')) return;
      dataEntries = [];
      lhByDate = {};
      localStorage.removeItem('bbtData');
      localStorage.removeItem('lhData');
      localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));
      if(chart) chart.destroy();
      renderTable();
      renderLHList();
    }

/* ===== Graf med bakgrundsf√§rger f√∂r faser ===== */
function renderChart() {
  console.log("‚ñ∂ renderChart startar‚Ä¶");
  try {
    if (chart) chart.destroy();

    // sortera data
    dataEntries.sort((a, b) => a.date.localeCompare(b.date));

    const labels = dataEntries.map(e => {
      if (!e.date) return "";
      const [y, m, d] = e.date.split("-");
      return `${d}-${m}`;
    });

    const actual    = dataEntries.map(e => e.actual);
    const corrected = dataEntries.map(e => e.corrected);

    // === FASER ===
    const ovIndex = dataEntries.findIndex(e => e.ovulation);
    const anns = [];

    // üå∏ Mens
    const mensIndices = dataEntries
      .map((e, i) => (e.mens ? i : null))
      .filter(i => i !== null);

    if (mensIndices.length > 0) {
      anns.push({
        type: "box",
        xMin: mensIndices[0] - 0.5,
        xMax: mensIndices[mensIndices.length - 1] + 0.5,
        backgroundColor: "rgba(244,182,194,0.55)",
        borderWidth: 0,
        drawTime: "beforeDatasetsDraw"
      });
    }

    // üåº √Ñgglossning (gul dag)
    if (ovIndex >= 0) {
      anns.push({
        type: "box",
        xMin: ovIndex - 0.5,
        xMax: ovIndex + 0.5,
        backgroundColor: "rgba(255,244,176,0.65)",
        borderWidth: 0,
        drawTime: "beforeDatasetsDraw"
      });
    }

    // üíú Lutealfas (efter √§gglossning)
    if (ovIndex >= 0 && ovIndex < dataEntries.length - 1) {
      anns.push({
        type: "box",
        xMin: ovIndex + 0.5,
        xMax: dataEntries.length - 0.5,
        backgroundColor: "rgba(224,195,252,0.6)",
        borderWidth: 0,
        drawTime: "beforeDatasetsDraw"
      });
    }

    // Vertikal linje vid √§gglossning
    if (ovIndex >= 0) {
      anns.push({
        type: "line",
        xMin: ovIndex,
        xMax: ovIndex,
        borderColor: "rgba(120,120,120,0.6)",
        borderWidth: 1,
        borderDash: [3, 3]
      });
    }
    // === MEDEL-SPANN F√ñRE √ÑGGLOSSNING (faktisk + korrigerad) ===
    let tempsActualBeforeOv = [];
    let tempsCorrectedBeforeOv = [];

    if (ovIndex > 0) {
      // bara dagar f√∂re √§gglossningsdagen
      tempsActualBeforeOv = dataEntries
        .slice(0, ovIndex)
        .map(e => e.actual)
        .filter(v => v != null);

      tempsCorrectedBeforeOv = dataEntries
        .slice(0, ovIndex)
        .map(e => e.corrected)
        .filter(v => v != null);
    } else {
      // ingen markerad √§gglossning ‚Üí anv√§nd alla dagar
      tempsActualBeforeOv = dataEntries
        .map(e => e.actual)
        .filter(v => v != null);

      tempsCorrectedBeforeOv = dataEntries
        .map(e => e.corrected)
        .filter(v => v != null);
    }

    let meanActualBeforeOv = null;
    let meanCorrBeforeOv   = null;

    if (tempsActualBeforeOv.length > 0) {
      meanActualBeforeOv =
        tempsActualBeforeOv.reduce((a, b) => a + b, 0) /
        tempsActualBeforeOv.length;
    }

    if (tempsCorrectedBeforeOv.length > 0) {
      meanCorrBeforeOv =
        tempsCorrectedBeforeOv.reduce((a, b) => a + b, 0) /
        tempsCorrectedBeforeOv.length;
    }

    // best√§m nedre och √∂vre kant f√∂r spannet (mellan F-medel och K-medel)
    let bandMin = null;
    let bandMax = null;

    if (meanActualBeforeOv != null && meanCorrBeforeOv != null) {
      bandMin = Math.min(meanActualBeforeOv, meanCorrBeforeOv);
      bandMax = Math.max(meanActualBeforeOv, meanCorrBeforeOv);
    } else if (meanActualBeforeOv != null) {
      bandMin = bandMax = meanActualBeforeOv;
    } else if (meanCorrBeforeOv != null) {
      bandMin = bandMax = meanCorrBeforeOv;
    }

    // dataset-data: en ‚Äúlinje‚Äù p√• bandets √∂vre kant √∂ver hela x-axeln
    const bandData = bandMax != null
      ? new Array(dataEntries.length).fill(bandMax)
      : [];

    chart = new Chart(el.chartCanvas, {
      type: "line",
        data: {
          labels,
          datasets: [
            // üåø MEDEL-SPANN (mellan medel F och medel K)
            {
              label: "Medelspann f√∂re √§gglossning",
              data: bandData,
              borderWidth: 0,
              pointRadius: 0,
              fill: bandMin != null ? {
                // fyll fr√•n bandets √∂vre kant ned till bandMin
                target: { value: bandMin },
                above: "rgba(195, 215, 180, 0.45)",
                below: "rgba(195, 215, 180, 0.45)"
              } : false,
              spanGaps: true
            },

            // üîµ FAKTISK TEMPERATUR
            {
              label: "Faktisk temperatur",
              data: actual,
              borderColor: "rgba(90,140,255,0.9)",
              backgroundColor: "rgba(90,140,255,0.9)",
              borderWidth: 2,
              pointRadius: 3,
              pointStyle: "circle",
              tension: 0.25,
              spanGaps: true
            },

            // üî¥ KORRIGERAD TEMPERATUR
            {
              label: "Korrigerad temperatur",
              data: corrected,
              borderColor: "rgba(240,100,120,0.85)",
              backgroundColor: "rgba(240,100,120,0.85)",
              borderDash: [4, 3],
              borderWidth: 1.5,
              pointRadius: 2.5,
              pointStyle: "triangle",
              rotation: 0,
              tension: 0.25,
              spanGaps: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { bottom: 26 } },

scales: {
  // === V√ÑNSTER Y-AXEL ===
  y: {
    position: "left",

    min: Math.floor((Math.min(...corrected.filter(v => v != null)) - 0.25) * 20) / 20,
    max: Math.ceil((Math.max(...corrected.filter(v => v != null)) + 0.15) * 20) / 20,

    ticks: {
      stepSize: 0.05,

      // Visa bara 0.10, g√∂m 0.05
      callback: function (v) {
        if (v == null) return "";
        return Math.round(v * 100) % 10 === 0 ? v.toFixed(2) : " ";
      },

      // SAFARI-S√ÑKER VERSION
      font: function (ctx) {
        if (!ctx || !ctx.tick || ctx.tick.value == null)
          return { size: 0, weight: "400" };

        const v = Number(ctx.tick.value);
        const isMajor = Math.round(v * 100) % 10 === 0;

        return {
          size: isMajor ? 12 : 0,
          weight: isMajor ? "600" : "400"
        };
      },

      color: function (ctx) {
        if (!ctx || !ctx.tick || ctx.tick.value == null)
          return "rgba(0,0,0,0)";

        const v = Number(ctx.tick.value);
        return Math.round(v * 100) % 10 === 0 ? "#000" : "rgba(0,0,0,0)";
      }
    },

    grid: {
      drawTicks: true,
      drawBorder: true,

      color: function (ctx) {
        if (!ctx || !ctx.tick || ctx.tick.value == null)
          return "rgba(0,0,0,0)";

        const v = Number(ctx.tick.value);
        const isMajor = Math.round(v * 100) % 10 === 0;

        return isMajor
          ? "rgba(0,0,0,0.15)"    // major 0.10-linje
          : "rgba(0,0,0,0.05)";  // minor 0.05-linje
      },

      lineWidth: function (ctx) {
        if (!ctx || !ctx.tick || ctx.tick.value == null) return 0.5;

        const v = Number(ctx.tick.value);
        return Math.round(v * 100) % 10 === 0 ? 1 : 0.5;
      }
    },

    title: { display: true, text: "¬∞C" }
  },

  // === H√ñGER Y-AXEL ===
  y1: {
    position: "right",

    min: Math.floor((Math.min(...corrected.filter(v => v != null)) - 0.25) * 20) / 20,
    max: Math.ceil((Math.max(...corrected.filter(v => v != null)) + 0.15) * 20) / 20,

    ticks: {
      stepSize: 0.05,

      callback: function (v) {
        if (v == null) return "";
        return Math.round(v * 100) % 10 === 0 ? v.toFixed(2) : " ";
      },

      font: function (ctx) {
        if (!ctx || !ctx.tick || ctx.tick.value == null)
          return { size: 0, weight: "400" };

        const v = Number(ctx.tick.value);
        const isMajor = Math.round(v * 100) % 10 === 0;

        return {
          size: isMajor ? 12 : 0,
          weight: isMajor ? "600" : "400"
        };
      },

      color: function (ctx) {
        if (!ctx || !ctx.tick || ctx.tick.value == null)
          return "rgba(0,0,0,0)";

        const v = Number(ctx.tick.value);
        return Math.round(v * 100) % 10 === 0 ? "#000" : "rgba(0,0,0,0)";
      }
    },

    grid: {
      drawOnChartArea: false  // ingen grid fr√•n h√∂ger
    }
  },

  // === X-AXEL ===
  x: {
    ticks: {
      color: "#000",
      autoSkip: true,
      maxTicksLimit: 10,
      maxRotation: 0
    }
  }
},

        plugins: {
          legend: { position: "bottom", labels: { color: "#000" } },
          annotation: {
            drawTime: "beforeDatasetsDraw",
            annotations: anns
          }
        },

        animation: false
      },

      // SYMBOLER OVANF√ñR X-AXELN
      plugins: [
        {
          id: "customSymbols",
          afterDraw(chart) {
            const {
              ctx,
              chartArea: { bottom },
              scales: { x }
            } = chart;
            const y = bottom - 15;

            dataEntries.forEach((e, i) => {
              const xPos = x.getPixelForValue(i);
              const symbols = [];
              if (e.sex) symbols.push("üíû");
              if (e.ovulation) symbols.push("üåº");
              if (e.mucus) symbols.push("üíß");

              if (symbols.length) {
                ctx.save();
                ctx.font =
                  "18px Apple Color Emoji, Segoe UI Emoji";
                ctx.textAlign = "center";
                symbols.forEach((sym, j) => {
                  ctx.fillText(sym, xPos, y - j * 18);
                });
                ctx.restore();
              }
            });
          }
        }
      ]
    });
  } catch (err) {
    console.error("‚ùå Fel i renderChart:", err);
    alert("Grafen kunde inte ritas:\n" + err.message);
  }
}

    /* ===== Export / Import ===== */
    el.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({ bbtData:dataEntries, lhDataByDate:lhByDate }, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'BBT_Ida_data.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    el.importBtn.addEventListener('click', ()=>el.importFile.click());
    el.importFile.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const o = JSON.parse(r.result);
          if(o.bbtData) dataEntries = o.bbtData;
          if(o.lhDataByDate) lhByDate  = o.lhDataByDate;
          else if(o.lhData) {
            lhByDate = {};
            if(Array.isArray(o.lhData)) {
              o.lhData.forEach(e=>{
                const d=e.date||'ok√§nt-datum';
                if(!lhByDate[d]) lhByDate[d]=[];
                lhByDate[d].push({dataUrl:e.dataUrl, symbols:e.symbols||[], note:e.note||'', tod:null, ts:Date.now()});
              });
            }
          }
          localStorage.setItem('bbtData', JSON.stringify(dataEntries));
          localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));
          renderTable(); renderLHList();
          if(document.querySelector('.tab.active')?.dataset.tab==='graf') renderChart();
          alert('Data importerad!');
        }catch{
          alert('Ogiltig fil.');
        }
      };
      r.readAsText(file);
      e.target.value='';
    });

    el.clearBtn.addEventListener('click', clearData);
    el.exportChartBtn?.addEventListener('click', ()=>{
      const link = document.createElement('a');
      link.download = 'BBT_graf.png';
      link.href = el.chartCanvas.toDataURL('image/png');
      link.click();
    });

    /* ===== LH: f√∂rhandsvisning + sparning ===== */
    function updateLHPreview(){
      const file = el.lhFile.files && el.lhFile.files[0];
      if(!file){ el.lhPreview.style.display='none'; return; }
      const rd = new FileReader();
      rd.onload = (ev)=>{
        el.lhPreviewImg.src = ev.target.result;
        const syms = el.lhSymChecks().map(x=>x.value).join(' ') || '‚Äì';
        const tod = el.lhFm.checked ? '‚òÄÔ∏è FM' : (el.lhEm.checked ? 'üåô EM' : '‚Äî');
        const d = el.lhDate.value || '(Datum ej valt)';
        const n = el.lhNote.value ? `"${el.lhNote.value}"` : '';
        el.lhPreviewInfo.textContent = `${d}  ‚Ä¢  ${syms}  ‚Ä¢  ${tod}  ${n?('‚Ä¢ '+n):''}`;
        el.lhPreview.style.display = 'flex';
      };
      rd.readAsDataURL(file);
    }
    el.lhPickBtn.addEventListener('click', ()=> el.lhFile.click());
    el.lhFile.addEventListener('change', updateLHPreview);
    [el.lhDate, el.lhNote].forEach(x=>['input','change'].forEach(evt=>x.addEventListener(evt, updateLHPreview)));
    document.querySelectorAll('.lhSym').forEach(cb=>cb.addEventListener('change', updateLHPreview));
    el.lhFm.addEventListener('change', ()=>{ if(el.lhFm.checked) el.lhEm.checked=false; updateLHPreview(); });
    el.lhEm.addEventListener('change', ()=>{ if(el.lhEm.checked) el.lhFm.checked=false; updateLHPreview(); });

    function renderLHList(){
      el.lhList.innerHTML='';
      const dates = Object.keys(lhByDate).sort();
      dates.forEach(date=>{
        (lhByDate[date]||[]).forEach((item, idx)=>{
          const row = document.createElement('div');
          row.className = 'lh-row';
          row.innerHTML = `
            <div style="flex:0 0 38%"><img class="lh-img" src="${item.dataUrl}" alt="LH-bild" data-date="${date}" data-idx="${idx}"></div>
            <div class="lh-info">
              <div style="font-weight:700">${date}</div>
              <div style="font-size:1.15rem; margin:.15rem 0;">${(item.symbols||[]).join(' ')}</div>
              <div class="muted">${item.tod ? item.tod : '‚Äî'}</div>
              <div style="font-size:.9rem; color:#555">${item.note||''}</div>
            </div>
            <div><button class="button danger" data-del="${date}::${idx}">Ta bort</button></div>
          `;
          row.querySelector('img').addEventListener('click', (ev)=>openGallery(date, parseInt(ev.target.dataset.idx,10)));
          row.querySelector('[data-del]').addEventListener('click', (ev)=>{
            const [d,iStr] = ev.target.getAttribute('data-del').split('::');
            const i = parseInt(iStr,10);
            if(Array.isArray(lhByDate[d])) {
              lhByDate[d].splice(i,1);
              if(lhByDate[d].length===0) delete lhByDate[d];
              localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));
              renderLHList();
            }
          });
          el.lhList.appendChild(row);
        });
      });
    }

    function allLHFlat(){
      const out=[];
      Object.keys(lhByDate).sort().forEach(date=>{
        (lhByDate[date]||[]).forEach(item=>out.push({date, ...item}));
      });
      return out;
    }
    function openGallery(date, idxInDate){
      const flat = allLHFlat();
      if(!flat.length) return;

      let flatIndex = 0, count=0;
      Object.keys(lhByDate).sort().some(d=>{
        const arr = lhByDate[d]||[];
        if(d===date){ flatIndex = count + idxInDate; return true; }
        count += arr.length; return false;
      });

      const o = document.createElement('div');
      o.style = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999';
      const img = document.createElement('img');
      img.style = 'max-width:92%;max-height:92%;border-radius:10px;background:#fff';
      const left = document.createElement('div');
      const right = document.createElement('div');
      left.style = right.style = 'position:absolute;top:0;width:50%;height:100%;';
      left.style.left='0'; right.style.right='0';

      function show(i){
        if(i<0) i = flat.length-1;
        if(i>=flat.length) i = 0;
        flatIndex = i;
        img.src = flat[flatIndex].dataUrl;
      }
      show(flatIndex);

      left.addEventListener('click', (e)=>{ e.stopPropagation(); show(flatIndex-1); });
      right.addEventListener('click', (e)=>{ e.stopPropagation(); show(flatIndex+1); });
      o.addEventListener('click', ()=>document.body.removeChild(o));
      o.appendChild(img); o.appendChild(left); o.appendChild(right);
      document.body.appendChild(o);

      function onKey(ev){
        if(ev.key==='ArrowLeft'){ show(flatIndex-1); }
        if(ev.key==='ArrowRight'){ show(flatIndex+1); }
        if(ev.key==='Escape'){ cleanup(); }
      }
      function cleanup(){ document.removeEventListener('keydown', onKey); if(o.parentNode) document.body.removeChild(o); }
      document.addEventListener('keydown', onKey);

      let sx=null, sy=null;
      o.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
      o.addEventListener('touchend', (e)=>{
        const t=e.changedTouches[0]; if(sx===null) return;
        const dx = t.clientX - sx, dy = t.clientY - sy;
        if(Math.abs(dx)>40 && Math.abs(dy)<60){ if(dx<0) show(flatIndex+1); else show(flatIndex-1); }
        else { cleanup(); }
        sx=sy=null;
      }, {passive:true});
    }

    // Spara LH-post
    el.lhSaveBtn.addEventListener('click', ()=>{
      const file = el.lhFile.files && el.lhFile.files[0];
      if(!file) return alert('V√§lj bild f√∂rst.');
      if(!el.lhDate.value) return alert('V√§lj datum.');
      const reader = new FileReader();
      reader.onload = (e)=>{
        const dataUrl = e.target.result;
        const symbols = el.lhSymChecks().map(x=>x.value);
        const note = el.lhNote.value || '';
        const tod = el.lhFm.checked ? '‚òÄÔ∏è FM' : (el.lhEm.checked ? 'üåô EM' : null);
        const d = el.lhDate.value;

        if(!lhByDate[d]) lhByDate[d] = [];
        lhByDate[d].push({ dataUrl, symbols, note, tod, ts: Date.now() });

        localStorage.setItem('lhDataByDate', JSON.stringify(lhByDate));

        el.lhNote.value = '';
        el.lhFile.value = '';
        el.lhFm.checked = false; el.lhEm.checked = false;
        document.querySelectorAll('.lhSym').forEach(cb=>cb.checked=false);
        el.lhPreview.style.display='none';
        renderLHList();
        alert('‚úÖ Bild sparad!');
      };
      reader.onerror = ()=> alert('Kunde inte l√§sa in bilden.');
      reader.readAsDataURL(file);
    });

    /* ===== Events ===== */
    el.actual.addEventListener('blur', computeCorrectedFormInputs);
    el.time.addEventListener('change', ()=>{ 
      if (el.actual.value) computeCorrectedFormInputs(); 
    });
    el.saveBtn.addEventListener('click', saveEntry);

    /* ===== Init ===== */
    renderTable();
    renderLHList();
  });
  </script>
</body>
</html>