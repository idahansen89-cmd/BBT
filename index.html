<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBT & LH</title>

  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>

  <style>
:root {
  --pink: #f4b6c2;
  --apricot: #f7c8a0;
  --yellow: #fff4b0;
  --mint: #baf2bb;
  --blue: #a8d8ff;
  --lavender: #e0c3fc;
  --pearl: #f5f5fa;

  --pink-hover: #e599ab;
  --text: #333;
  --line: #eee;
}

* { box-sizing: border-box; }

body {
  font-family: "Helvetica Neue", Arial, sans-serif;
  margin: 0;
  background: #fff;
  color: var(--text);
}

h1 {
  text-align: center;
  margin: 1rem 0;
}

/* ============================
          TABS
============================ */
.tabs {
  display: flex;
  justify-content: center;
  gap: 0.4rem;
  border-bottom: 2px solid #ddd;
  padding-bottom: 0.4rem;
}
.tab {
  padding: 0.7rem 1.2rem;
  border: none;
  border-radius: 8px 8px 0 0;
  background: #f4f4f4;
  font-weight: 600;
  cursor: pointer;
}
.tab.active {
  background: #fff;
  border-bottom: 2px solid #fff;
  color: #e06b8f;
}

.tab-content {
  display: none;
  max-width: 820px;
  margin: 1rem auto;
  padding: 1rem;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: #fff;
}
.tab-content.active {
  display: block;
}

/* ============================
          FORMUL√ÑR
============================ */
.form-row {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin-bottom: 0.6rem;
}
.form-row label {
  width: 160px;
  font-weight: 600;
}
.form-row input,
.form-row select,
.form-row textarea {
  flex: 1;
  padding: 0.45rem 0.6rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 0.95rem;
}
textarea { resize: vertical; min-height: 56px; }

/* ============================
        SYMBOLRAD (BBT)
============================ */
.symbols-row {
  display: flex;
  justify-content: center;
  gap: 14px;
  align-items: flex-start;
  margin: 0.5rem 0 0.25rem;
}
.symbol-stack {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 36px;
}
.symbol-stack .sym {
  font-size: 1.6rem;
  line-height: 1;
}
.symbol-stack input {
  margin-top: 0.25rem;
}

/* ============================
          KNAPPAR
============================ */
.button {
  background: var(--pink);
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 0.55rem 1.1rem;
  font-weight: 700;
  cursor: pointer;
}
.button:hover {
  background: var(--pink-hover);
}

/* ============================
        TABELL
============================ */
.table-wrap {
  overflow-x: auto;
  margin-top: 1rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 0.9rem;
}
th, td {
  padding: 0.5rem 0.4rem;
  border: 1px solid #ddd;
  white-space: nowrap;
  text-align: center;
}
thead th {
  background: #ffe5ec;
  font-weight: 700;
}
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr.mens-row { background-color: #ffe8ee !important; }
tbody tr.ovulation-row { background-color: #fff9d9 !important; }

td:nth-child(1), th:nth-child(1) { width: 85px; }
td:nth-child(2), th:nth-child(2) { width: 70px; }
td:nth-child(3), td:nth-child(4),
th:nth-child(3), th:nth-child(4) { width: 70px; }
td:nth-child(5), th:nth-child(5) { width: 85px; }
td:nth-child(6), th:nth-child(6) { width: 90px; }
td:nth-child(7), th:nth-child(7) { width: 150px; text-align: left; }

td button {
  margin: 0 2px;
  border-radius: 6px;
  background: #f4b6c2;
  border: none;
  font-size: 0.8rem;
  padding: 0.3rem 0.6rem;
}

/* ============================
        GRAFSTIL
============================ */
#chartContainer {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto;
  height: 420px;
  position: relative;
}

#bbtChart {
  display: block;
  width: 100% !important;
  height: 100% !important;
}

.chart-toolbar {
  display: flex;
  justify-content: center;
  margin-top: 0.75rem;
}

/* ============================
        INFO-BUTTON (i)
============================ */
.info-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: var(--pink);
  font-size: 1.15rem;
  font-weight: 900;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.info-btn:hover {
  background: var(--pink-hover);
}

/* ============================
      POPUP F√ñR LEGEND
============================ */
#legendPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 5000;
}
.legend-box {
  background: #fff;
  padding: 1.6rem 2rem;
  max-width: 330px;
  width: 90%;
  border-radius: 12px;
  box-shadow: 0 4px 22px rgba(0,0,0,0.22);
}
.legend-box h3 {
  margin-top: 0;
  text-align: center;
}
.legend-entry {
  margin: 0.4rem 0;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
.legend-color {
  width: 20px;
  height: 8px;
  border-radius: 4px;
}
.legend-close {
  text-align: center;
  margin-top: 1.2rem;
}
.legend-close button {
  background: var(--pink);
  border: none;
  padding: 0.5rem 1.3rem;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
}

/* ============================
        LH-FLIK (som tidigare)
============================ */
.lh-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.6rem;
  flex-wrap: wrap;
}
.lh-symbols-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.8rem;
  align-items: center;
}
.lh-symbol-checkbox {
  text-align: center;
  font-size: 1.25rem;
}
.lh-symbol-checkbox small {
  display: block;
  color: #777;
  font-size: 0.75rem;
}
.lh-preview {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin: 0.4rem 0;
  background: #fafafa;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 0.4rem;
}
.lh-img {
  width: 100%;
  max-height: 110px;
  object-fit: contain;
  border-radius: 8px;
  background: #fff;
}
.lh-row {
  display: flex;
  justify-content: space-between;
  gap: 0.6rem;
  padding: 0.45rem 0;
  border-bottom: 1px solid #eee;
}

/* ============================
        MOBIL
============================ */
@media (max-width: 600px) {
  th, td {
    font-size: 0.8rem;
    padding: 0.35rem 0.25rem;
  }
  td:nth-child(7) {
    max-width: 90px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}
  </style>
</head>

<body>
<h1>BBT & LH</h1>

<div class="tabs">
  <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
  <button class="tab" data-tab="graf">üìà Graf</button>
  <button class="tab" data-tab="lh">üß™ LH-test</button>
</div>

<!-- ============================
       INMATNING & TABELL
============================ -->
<div id="inmatning" class="tab-content active">

  <div class="form-row">
    <label for="date">Datum:</label>
    <input type="date" id="date">
  </div>

  <div class="form-row">
    <label for="time">Tid (BBT):</label>
    <input type="time" id="time">
  </div>

  <div class="form-row">
    <label for="actual">Faktisk temp (¬∞C):</label>
    <input type="number" id="actual" step="0.01">
  </div>

  <div class="form-row">
    <label for="corrected">Korrigerad temp (¬∞C):</label>
    <input type="number" id="corrected" step="0.01" placeholder="Ber√§knas automatiskt">
  </div>

  <!-- H√§ndelser ‚Äì symbolrad -->
  <div class="symbols-row">
    <div class="symbol-stack">
      <div class="sym">ü©∏</div>
      <input type="checkbox" id="symMens">
    </div>
    <div class="symbol-stack">
      <div class="sym">üíû</div>
      <input type="checkbox" id="symSex">
    </div>
    <div class="symbol-stack">
      <div class="sym">üåº</div>
      <input type="checkbox" id="symOv">
    </div>
    <div class="symbol-stack">
      <div class="sym">üíß</div>
      <input type="checkbox" id="symMucus">
    </div>
    <div class="symbol-stack">
      <div class="sym">‚ûï</div>
      <input type="checkbox" id="symLHpos">
    </div>
    <div class="symbol-stack">
      <div class="sym">‚ûñ</div>
      <input type="checkbox" id="symLHneg">
    </div>
  </div>

  <div class="form-row" style="align-items:flex-start">
    <label for="note" style="margin-top:.2rem">Anteckning:</label>
    <textarea id="note" rows="2" placeholder="Valfritt"></textarea>
  </div>

  <div class="top-buttons" style="text-align:center; margin-top:.5rem;">
    <button class="button" id="saveBtn">Spara</button>
    <button class="button" id="exportBtn">Exportera data</button>
    <button class="button" id="importBtn">Importera data</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
  </div>

  <div class="table-wrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Tid</th>
          <th>F ¬∞C</th>
          <th>K ¬∞C</th>
          <th>H√§ndelser</th>
          <th>Anteckning</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="text-align:center; margin-top:1rem;">
    <button class="button danger" id="clearBtn">Rensa all data</button>
  </div>

</div>

<!-- ============================
             GRAF
============================ -->
<div id="graf" class="tab-content">
  <div id="chartContainer">
    <button id="infoBtn" class="info-btn">i</button>
    <canvas id="bbtChart"></canvas>
  </div>
  <div class="chart-toolbar">
    <button class="button" id="exportChartBtn">Exportera graf</button>
  </div>
</div>

<!-- ============================
        LEGEND POPUP
============================ -->
<div id="legendPopup">
  <div class="legend-box">

    <h3>F√∂rklaring</h3>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(90,140,255,0.9);"></div>
      <span>Bl√• linje ‚Äì Faktisk temperatur</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(240,100,120,0.85);"></div>
      <span>R√∂d prickad linje ‚Äì Korrigerad temp</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(195,215,180,0.45); height:10px;"></div>
      <span>Gr√∂nt band ‚Äì Medellinje f√∂re √ÑL</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(244,182,194,0.55); height:10px;"></div>
      <span>Rosa ton ‚Äì Mens</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(255,244,176,0.65); height:10px;"></div>
      <span>Gul ton ‚Äì √Ñgglossningsdag</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(224,195,252,0.6); height:10px;"></div>
      <span>Lila ton ‚Äì Lutealfas</span>
    </div>

    <hr style="margin:1rem 0;">

    <strong>Symboler:</strong>
    <div class="legend-entry">üíû ‚Äì Samlag</div>
    <div class="legend-entry">üåº ‚Äì √Ñgglossning</div>
    <div class="legend-entry">üíß ‚Äì Cervixsekret</div>

    <div class="legend-close">
      <button id="legendCloseBtn">St√§ng</button>
    </div>

  </div>
</div>

<!-- ============================
              LH-FLIK
============================ -->
<div id="lh" class="tab-content">

  <div class="lh-toolbar">
    <div style="display:flex; gap:.5rem; align-items:center">
      <button class="button" id="lhPickBtn">V√§lj bild</button>
      <input type="file" id="lhFile" accept="image/*" style="display:none">
    </div>
    <input type="date" id="lhDate">
  </div>

  <div class="lh-symbols-row" style="margin:.4rem 0 .3rem">
    <label class="lh-symbol-checkbox">ü©∑<small>N</small><br><input type="checkbox" class="lhSym" value="ü©∑"></label>
    <label class="lh-symbol-checkbox">‚ù§Ô∏è<small>T</small><br><input type="checkbox" class="lhSym" value="‚ù§Ô∏è"></label>
    <label class="lh-symbol-checkbox">üíú<small>H</small><br><input type="checkbox" class="lhSym" value="üíú"></label>
    <label class="lh-symbol-checkbox">üíô<small>L</small><br><input type="checkbox" class="lhSym" value="üíô"></label>
    <label class="lh-symbol-checkbox">üíö<small>‚Äì</small><br><input type="checkbox" class="lhSym" value="üíö"></label>
    <label class="lh-symbol-checkbox">üíõ<small>?</small><br><input type="checkbox" class="lhSym" value="üíõ"></label>

    <span class="lh-fm-em">
      <label class="lh-symbol-checkbox">‚òÄÔ∏è<small>FM</small><br><input type="checkbox" id="lhFm"></label>
      <label class="lh-symbol-checkbox">üåô<small>EM</small><br><input type="checkbox" id="lhEm"></label>
    </span>
  </div>

  <div id="lhPreview" class="lh-preview" style="display:none;">
    <img id="lhPreviewImg" class="lh-img" alt="">
    <small id="lhPreviewInfo" class="muted"></small>
  </div>

  <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
    <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
    <button class="button" id="lhSaveBtn">Spara</button>
  </div>

  <div id="lhList"></div>
</div>

<!-- ============================
       SCRIPT
============================ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ===== Tabs ===== */
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.tab;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(id).classList.add("active");
      if (id === "graf") renderChart();
      if (id === "lh") renderLHList();
    });
  });

  /* ===== Elementreferenser ===== */
  const el = {
    date: document.getElementById("date"),
    time: document.getElementById("time"),
    actual: document.getElementById("actual"),
    corrected: document.getElementById("corrected"),
    note: document.getElementById("note"),

    symMens:  document.getElementById("symMens"),
    symSex:   document.getElementById("symSex"),
    symOv:    document.getElementById("symOv"),
    symMucus: document.getElementById("symMucus"),
    symLHpos: document.getElementById("symLHpos"),
    symLHneg: document.getElementById("symLHneg"),

    saveBtn: document.getElementById("saveBtn"),
    exportBtn: document.getElementById("exportBtn"),
    importBtn: document.getElementById("importBtn"),
    importFile: document.getElementById("importFile"),
    clearBtn: document.getElementById("clearBtn"),

    dataTableBody: document.querySelector("#dataTable tbody"),
    chartCanvas: document.getElementById("bbtChart"),
    exportChartBtn: document.getElementById("exportChartBtn"),

    lhPickBtn: document.getElementById("lhPickBtn"),
    lhFile: document.getElementById("lhFile"),
    lhDate: document.getElementById("lhDate"),
    lhNote: document.getElementById("lhNote"),
    lhSaveBtn: document.getElementById("lhSaveBtn"),
    lhList: document.getElementById("lhList"),
    lhFm: document.getElementById("lhFm"),
    lhEm: document.getElementById("lhEm"),
    lhPreview: document.getElementById("lhPreview"),
    lhPreviewImg: document.getElementById("lhPreviewImg"),
    lhPreviewInfo: document.getElementById("lhPreviewInfo"),
    lhSymChecks: () => Array.from(document.querySelectorAll(".lhSym:checked"))
  };

  /* ===== State ===== */
  let dataEntries = JSON.parse(localStorage.getItem("bbtData") || "[]");
  let lhByDate = JSON.parse(localStorage.getItem("lhDataByDate") || "{}");
  let chart = null;

  /* ============================
        TEMPKORRIGERING
  ============================ */
  const minutesFrom0400 = (t) => {
    if (!t) return 0;
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m - 240;
  };

  function computeCorrectedFrom(a, timeStr) {
    if (Number.isNaN(a)) return null;
    const mins = minutesFrom0400(timeStr || "04:00");
    return Number((a - 0.05 * (mins / 30)).toFixed(2));
  }

  function computeCorrectedFormInputs() {
    const a = parseFloat(el.actual.value);
    if (!isNaN(a)) {
      const c = computeCorrectedFrom(a, el.time.value);
      el.corrected.value = c != null ? c.toFixed(2) : "";
    }
  }

  /* ============================
        SPARA & TABELL
  ============================ */
  function saveEntry() {
    const e = {
      date: el.date.value,
      time: el.time.value,
      actual: el.actual.value ? Number(el.actual.value) : null,
      corrected: el.corrected.value ? Number(el.corrected.value) : null,
      mens: el.symMens.checked,
      sex: el.symSex.checked,
      ovulation: el.symOv.checked,
      mucus: el.symMucus.checked,
      lhPos: el.symLHpos.checked,
      lhNeg: el.symLHneg.checked,
      note: el.note.value || ""
    };

    if (!e.date) return alert("V√§lj datum f√∂rst.");

    const i = dataEntries.findIndex(x => x.date === e.date);
    if (i >= 0) dataEntries[i] = e;
    else dataEntries.push(e);

    localStorage.setItem("bbtData", JSON.stringify(dataEntries));
    renderTable();
    alert("‚úÖ Data sparad!");
  }

  function renderTable() {
    el.dataTableBody.innerHTML = "";
    dataEntries.sort((a,b)=>a.date.localeCompare(b.date));

    dataEntries.forEach((e, idx) => {
      const tr = document.createElement("tr");

      if (e.mens) tr.classList.add("mens-row");
      if (e.ovulation) tr.classList.add("ovulation-row");

      let events = "";
      if (e.mens) events += "ü©∏ ";
      if (e.sex) events += "üíû ";
      if (e.ovulation) events += "üåº ";
      if (e.mucus) events += "üíß ";
      if (e.lhPos) events += "‚ûï ";
      if (e.lhNeg) events += "‚ûñ ";

      tr.innerHTML = `
        <td>${e.date}</td>
        <td>${e.time || ""}</td>
        <td>${e.actual ?? ""}</td>
        <td>${e.corrected ?? ""}</td>
        <td>${events.trim() || "‚Äì"}</td>
        <td>${e.note}</td>
        <td><button class="table-btn" data-edit="${idx}">‚úèÔ∏è</button></td>
      `;

      tr.querySelector("[data-edit]").addEventListener("click", () => {
        el.date.value = e.date;
        el.time.value = e.time || "";
        el.actual.value = e.actual ?? "";
        el.corrected.value = e.corrected ?? "";
        el.note.value = e.note || "";

        el.symMens.checked = e.mens;
        el.symSex.checked = e.sex;
        el.symOv.checked = e.ovulation;
        el.symMucus.checked = e.mucus;
        el.symLHpos.checked = e.lhPos;
        el.symLHneg.checked = e.lhNeg;
      });

      el.dataTableBody.appendChild(tr);
    });
  }

  function clearData() {
    if (!confirm("Vill du verkligen rensa all data?")) return;
    dataEntries = [];
    lhByDate = {};
    localStorage.removeItem("bbtData");
    localStorage.removeItem("lhDataByDate");
    if (chart) chart.destroy();
    renderTable();
    renderLHList();
  }

  /* ============================
      M√ÖNADS-PLUG-IN (JAN, FEB‚Ä¶)
  ============================ */
  const MonthLabelPlugin = {
    id: "monthLabelPlugin",
    afterDraw(chart) {
      const {ctx, chartArea, scales} = chart;
      const xAxis = scales.xTop;
      if (!xAxis) return;

      const months = chart.$months;
      const labels = chart.data.labels;
      if (!months || !labels || !labels.length) return;

      const names = {
        "01":"jan","02":"feb","03":"mar","04":"apr","05":"maj","06":"jun",
        "07":"jul","08":"aug","09":"sep","10":"okt","11":"nov","12":"dec"
      };

      let prev = null;
      months.forEach((m, i) => {
        if (!m || m === prev) return;
        prev = m;

        const x = xAxis.getPixelForValue(i);
        const y = chartArea.top - 24;
        const text = names[m] || m;

        ctx.save();
        ctx.font = "12px Helvetica";
        const w = ctx.measureText(text).width + 16;
        const h = 18;
        const r = 6;

        ctx.fillStyle = "rgba(168,216,255,0.6)";
        ctx.strokeStyle = "rgba(120,150,180,0.4)";
        ctx.lineWidth = 1;

        ctx.beginPath();
        ctx.moveTo(x - w/2 + r, y);
        ctx.lineTo(x + w/2 - r, y);
        ctx.quadraticCurveTo(x + w/2, y, x + w/2, y + r);
        ctx.lineTo(x + w/2, y + h - r);
        ctx.quadraticCurveTo(x + w/2, y + h, x + w/2 - r, y + h);
        ctx.lineTo(x - w/2 + r, y + h);
        ctx.quadraticCurveTo(x - w/2, y + h, x - w/2, y + h - r);
        ctx.lineTo(x - w/2, y + r);
        ctx.quadraticCurveTo(x - w/2, y, x - w/2 + r, y);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "#2b4a65";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, x, y + h/2);
        ctx.restore();
      });
    }
  };

  Chart.register(MonthLabelPlugin);

  /* ============================
        GRAF
  ============================ */
  function renderChart() {
    if (chart) chart.destroy();
    if (!dataEntries.length) return;

    dataEntries.sort((a,b)=>a.date.localeCompare(b.date));

    // Dagar (DD) + m√•nader separat
    const dayLabels = dataEntries.map(e => {
      const [y,m,d] = e.date.split("-");
      return d.padStart(2,"0");
    });
    const monthArray = dataEntries.map(e => e.date.split("-")[1]);

    const actual = dataEntries.map(e => e.actual);
    const corrected = dataEntries.map(e => e.corrected);

    const ovIndex = dataEntries.findIndex(e => e.ovulation);

    const anns = [];

    // Mensbakgrund
    const mensIdx = dataEntries.map((e,i)=>e.mens ? i : null).filter(i=>i!==null);
    if (mensIdx.length) {
      anns.push({
        type:"box",
        xMin: mensIdx[0]-0.5,
        xMax: mensIdx[mensIdx.length-1]+0.5,
        backgroundColor:"rgba(244,182,194,0.55)",
        borderWidth:0
      });
    }

    // √Ñgglossning
    if (ovIndex >= 0) {
      anns.push({
        type:"box",
        xMin: ovIndex-0.5,
        xMax: ovIndex+0.5,
        backgroundColor:"rgba(255,244,176,0.65)",
        borderWidth:0
      });
    }

    // Lutealfas
    if (ovIndex >= 0 && ovIndex < dataEntries.length-1) {
      anns.push({
        type:"box",
        xMin: ovIndex+0.5,
        xMax: dataEntries.length-0.5,
        backgroundColor:"rgba(224,195,252,0.6)",
        borderWidth:0
      });
    }

    // Medellinje (gr√∂nt band)
    const beforeOv = ovIndex>=0 ? dataEntries.slice(0,ovIndex) : dataEntries;
    const beforeCorr = beforeOv.map(e=>e.corrected).filter(v=>v!=null);

    let bandMin=null, bandMax=null;
    if (beforeCorr.length) {
      const mean = beforeCorr.reduce((a,b)=>a+b,0)/beforeCorr.length;
      bandMin = mean - 0.01;
      bandMax = mean + 0.01;
    }
    const bandData = bandMax != null ? new Array(dataEntries.length).fill(bandMax) : [];

    chart = new Chart(el.chartCanvas, {
      type:"line",
      data:{
        labels: dayLabels,
        datasets:[
          {
            label:"Medelband",
            data: bandData,
            borderWidth:0,
            pointRadius:0,
            fill: bandMin!=null ? {
              target:{value:bandMin},
              above:"rgba(195,215,180,0.45)",
              below:"rgba(195,215,180,0.45)"
            } : false,
            spanGaps:true
          },
          {
            label:"Faktisk",
            data: actual,
            borderColor:"rgba(90,140,255,0.9)",
            backgroundColor:"rgba(90,140,255,0.9)",
            borderWidth:2,
            pointStyle:"circle",
            pointRadius:3,
            tension:0.25,
            spanGaps:true
          },
          {
            label:"Korrigerad",
            data: corrected,
            borderColor:"rgba(240,100,120,0.85)",
            backgroundColor:"rgba(240,100,120,0.85)",
            borderDash:[4,3],
            borderWidth:1.6,
            pointStyle:"triangle",
            pointRadius:3,
            tension:0.25,
            spanGaps:true
          }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{top:35, bottom:25} },
        scales:{
          y:{
            suggestedMin: Math.min(...corrected.filter(v=>v!=null)) - 0.2,
            suggestedMax: Math.max(...corrected.filter(v=>v!=null)) + 0.15,
            ticks:{
              stepSize:0.05,
              callback:v => v.toFixed(2)
            },
            grid:{
              color:"rgba(0,0,0,0.12)",
              lineWidth:1
            }
          },
          xTop:{
            type:"category",
            position:"top",
            labels: dayLabels,
            ticks:{
              autoSkip:false,
              maxRotation:0,
              font:{size:13}
            },
            grid:{ display:false }
          },
          x:{
            type:"category",
            position:"bottom",
            labels: dayLabels,
            ticks:{
              autoSkip:false,
              maxRotation:0,
              font:{size:13},
              callback:(value, index) => {
                const cd = (index+1).toString().padStart(2,"0");
                return index === 0 ? `CD ‚Üí ${cd}` : cd;
              }
            },
            grid:{ display:false }
          }
        },
        plugins:{
          legend:{ display:false },
          annotation:{ annotations:anns }
        }
      }
    });

    // mata in m√•nader till plug-in
    chart.$months = monthArray;
  }

  /* ============================
        LH-FUNKTIONER (kort)
  ============================ */
  function updateLHPreview(){
    const file = el.lhFile.files && el.lhFile.files[0];
    if(!file){ el.lhPreview.style.display='none'; return; }
    const rd = new FileReader();
    rd.onload = (ev)=>{
      el.lhPreviewImg.src = ev.target.result;
      const syms = el.lhSymChecks().map(x=>x.value).join(" ") || "‚Äì";
      const tod = el.lhFm.checked ? "‚òÄÔ∏è FM" : (el.lhEm.checked ? "üåô EM" : "‚Äî");
      const d = el.lhDate.value || "(Datum ej valt)";
      const n = el.lhNote.value ? `"${el.lhNote.value}"` : "";
      el.lhPreviewInfo.textContent = `${d}  ‚Ä¢  ${syms}  ‚Ä¢  ${tod}  ${n?("‚Ä¢ "+n):""}`;
      el.lhPreview.style.display = "flex";
    };
    rd.readAsDataURL(file);
  }

  function renderLHList(){
    el.lhList.innerHTML = "";
    const dates = Object.keys(lhByDate).sort();
    dates.forEach(date=>{
      (lhByDate[date]||[]).forEach((item, idx)=>{
        const row = document.createElement("div");
        row.className = "lh-row";
        row.innerHTML = `
          <div style="flex:0 0 38%"><img class="lh-img" src="${item.dataUrl}" alt="LH-bild"></div>
          <div class="lh-info">
            <div style="font-weight:700">${date}</div>
            <div style="font-size:1.15rem; margin:.15rem 0;">${(item.symbols||[]).join(" ")}</div>
            <div class="muted">${item.tod ? item.tod : "‚Äî"}</div>
            <div style="font-size:.9rem; color:#555">${item.note||""}</div>
          </div>
        `;
        el.lhList.appendChild(row);
      });
    });
  }

  /* ============================
          EVENTS
  ============================ */
  el.actual.addEventListener("blur", computeCorrectedFormInputs);
  el.time.addEventListener("change", computeCorrectedFormInputs);
  el.saveBtn.addEventListener("click", saveEntry);
  el.clearBtn.addEventListener("click", clearData);

  el.exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify({bbtData:dataEntries, lhDataByDate:lhByDate}, null, 2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "BBT_Ida_data.json";
    a.click();
  });

  el.importBtn.addEventListener("click", ()=>el.importFile.click());
  el.importFile.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const o = JSON.parse(r.result);
        if(o.bbtData) dataEntries = o.bbtData;
        if(o.lhDataByDate) lhByDate = o.lhDataByDate;
        localStorage.setItem("bbtData", JSON.stringify(dataEntries));
        localStorage.setItem("lhDataByDate", JSON.stringify(lhByDate));
        renderTable();
        renderLHList();
        alert("Data importerad!");
      }catch{
        alert("Ogiltig fil.");
      }
    };
    r.readAsText(file);
  });

  el.exportChartBtn.addEventListener("click", ()=>{
    const link = document.createElement("a");
    link.href = el.chartCanvas.toDataURL("image/png");
    link.download = "BBT_graf.png";
    link.click();
  });

  // LH-preview och sparning
  el.lhPickBtn.addEventListener("click", ()=> el.lhFile.click());
  el.lhFile.addEventListener("change", updateLHPreview);
  [el.lhDate, el.lhNote].forEach(x=>['input','change'].forEach(evt=>x.addEventListener(evt, updateLHPreview)));
  document.querySelectorAll(".lhSym").forEach(cb=>cb.addEventListener("change", updateLHPreview));
  el.lhFm.addEventListener("change", ()=>{ if(el.lhFm.checked) el.lhEm.checked=false; updateLHPreview(); });
  el.lhEm.addEventListener("change", ()=>{ if(el.lhEm.checked) el.lhFm.checked=false; updateLHPreview(); });

  el.lhSaveBtn.addEventListener("click", ()=>{
    const file = el.lhFile.files && el.lhFile.files[0];
    if(!file) return alert("V√§lj bild f√∂rst.");
    if(!el.lhDate.value) return alert("V√§lj datum.");
    const reader = new FileReader();
    reader.onload = (e)=>{
      const dataUrl = e.target.result;
      const symbols = el.lhSymChecks().map(x=>x.value);
      const note = el.lhNote.value || "";
      const tod = el.lhFm.checked ? "‚òÄÔ∏è FM" : (el.lhEm.checked ? "üåô EM" : null);
      const d = el.lhDate.value;
      if(!lhByDate[d]) lhByDate[d] = [];
      lhByDate[d].push({ dataUrl, symbols, note, tod, ts: Date.now() });
      localStorage.setItem("lhDataByDate", JSON.stringify(lhByDate));

      el.lhNote.value = "";
      el.lhFile.value = "";
      el.lhFm.checked = false; el.lhEm.checked = false;
      document.querySelectorAll(".lhSym").forEach(cb=>cb.checked=false);
      el.lhPreview.style.display="none";
      renderLHList();
      alert("‚úÖ Bild sparad!");
    };
    reader.readAsDataURL(file);
  });

  // Legend-popup
  const legendPopup = document.getElementById("legendPopup");
  document.getElementById("infoBtn").addEventListener("click", ()=> legendPopup.style.display="flex");
  document.getElementById("legendCloseBtn").addEventListener("click", ()=> legendPopup.style.display="none");
  legendPopup.addEventListener("click", e=>{
    if(e.target===legendPopup) legendPopup.style.display="none";
  });

  /* INIT */
  renderTable();
  renderLHList();
});
</script>

</body>
</html>