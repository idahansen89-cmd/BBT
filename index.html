<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBT & LH</title>

  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>

  <style>
:root {
  --pink: #f4b6c2;
  --apricot: #f7c8a0;
  --yellow: #fff4b0;
  --mint: #baf2bb;
  --blue: #a8d8ff;
  --lavender: #e0c3fc;
  --pearl: #f5f5fa;

  --pink-hover: #e599ab;
  --text: #333;
  --line: #eee;
}

* { box-sizing: border-box; }

body {
  font-family: "Helvetica Neue", Arial, sans-serif;
  margin: 0;
  background: #fff;
  color: var(--text);
}

h1 {
  text-align: center;
  margin: 1rem 0;
}

/* ============================
          TABS
============================ */
.tabs {
  display: flex;
  justify-content: center;
  gap: 0.4rem;
  border-bottom: 2px solid #ddd;
  padding-bottom: 0.4rem;
}
.tab {
  padding: 0.7rem 1.2rem;
  border: none;
  border-radius: 8px 8px 0 0;
  background: #f4f4f4;
  font-weight: 600;
  cursor: pointer;
}
.tab.active {
  background: #fff;
  border-bottom: 2px solid #fff;
  color: #e06b8f;
}

.tab-content {
  display: none;
  max-width: 820px;
  margin: 1rem auto;
  padding: 1rem;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: #fff;
}
.tab-content.active {
  display: block;
}

/* ============================
          FORMULÃ„R
============================ */
.form-row {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin-bottom: 0.6rem;
}
.form-row label {
  width: 160px;
  font-weight: 600;
}
.form-row input,
.form-row select,
.form-row textarea {
  flex: 1;
  padding: 0.45rem 0.6rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 0.95rem;
}
textarea { resize: vertical; min-height: 56px; }

/* ============================
        SYMBOLRAD (BBT)
============================ */
.symbols-row {
  display: flex;
  justify-content: center;
  gap: 14px;
  align-items: flex-start;
  margin: 0.5rem 0 0.25rem;
}
.symbol-stack {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 36px;
}
.symbol-stack .sym {
  font-size: 1.6rem;
  line-height: 1;
}
.symbol-stack input {
  margin-top: 0.25rem;
}

/* ============================
          KNAPPAR
============================ */
.button {
  background: var(--pink);
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 0.55rem 1.1rem;
  font-weight: 700;
  cursor: pointer;
}
.button:hover {
  background: var(--pink-hover);
}

/* ============================
        TABELL
============================ */
.table-wrap {
  overflow-x: auto;
  margin-top: 1rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 0.9rem;
}
th, td {
  padding: 0.5rem 0.4rem;
  border: 1px solid #ddd;
  white-space: nowrap;
  text-align: center;
}
thead th {
  background: #ffe5ec;
  font-weight: 700;
}
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr.mens-row { background-color: #ffe8ee !important; }
tbody tr.ovulation-row { background-color: #fff9d9 !important; }

td:nth-child(1), th:nth-child(1) { width: 85px; }
td:nth-child(2), th:nth-child(2) { width: 70px; }
td:nth-child(3), td:nth-child(4),
th:nth-child(3), th:nth-child(4) { width: 70px; }
td:nth-child(5), th:nth-child(5) { width: 85px; }
td:nth-child(6), th:nth-child(6) { width: 90px; }
td:nth-child(7), th:nth-child(7) { width: 150px; text-align: left; }

td button {
  margin: 0 2px;
  border-radius: 6px;
  background: #f4b6c2;
  border: none;
  font-size: 0.8rem;
  padding: 0.3rem 0.6rem;
}

/* ============================
        GRAFSTIL
============================ */
#chartContainer {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto;
  height: 420px;
  position: relative;
}

#bbtChart {
  display: block;
  width: 100% !important;
  height: 100% !important;
}

.chart-toolbar {
  display: flex;
  justify-content: center;
  margin-top: 0.75rem;
}

/* Extra tydligt rutnÃ¤t */
.chart-grid-line {
  color: rgba(0,0,0,0.12);
  stroke-width: 1px;
}
/* ============================
        INFO-BUTTON (i)
============================ */
/* --- Info-knapp (i) med samma stil som exportknappen --- */
.info-btn {
  position: absolute;
  top: -10px;
  right: -10px;

  width: 32px;
  height: 32px;

  background: var(--pink);
  color: #222;
  border: none;
  border-radius: 8px;

  font-size: 1.15rem;
  font-weight: 900;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;

  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  transition: 0.15s;
}
.info-btn:hover {
  background: var(--pink-hover);
}

/* ============================
      POPUP FÃ–R LEGEND
============================ */
#legendPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 5000;
}
.legend-box {
  background: #fff;
  padding: 1.6rem 2rem;
  max-width: 330px;
  width: 90%;
  border-radius: 12px;
  box-shadow: 0 4px 22px rgba(0,0,0,0.22);
}
.legend-box h3 {
  margin-top: 0;
  text-align: center;
}
.legend-entry {
  margin: 0.4rem 0;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
.legend-color {
  width: 20px;
  height: 8px;
  border-radius: 4px;
}
.legend-close {
  text-align: center;
  margin-top: 1.2rem;
}
.legend-close button {
  background: var(--pink);
  color: #222;
  border: none;
  padding: 0.5rem 1.3rem;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
}
.legend-close button:hover {
  background: var(--pink-hover);
}
  </style>
</head>

<body>
<h1>BBT & LH</h1>

<div class="tabs">
  <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
  <button class="tab" data-tab="graf">ğŸ“ˆ Graf</button>
  <button class="tab" data-tab="lh">ğŸ§ª LH-test</button>
</div>

<!-- ============================
       INMATNING & TABELL
============================ -->
<div id="inmatning" class="tab-content active">

  <div class="form-row">
    <label for="date">Datum:</label>
    <input type="date" id="date">
  </div>

  <div class="form-row">
    <label for="time">Tid (BBT):</label>
    <input type="time" id="time">
  </div>

  <div class="form-row">
    <label for="actual">Faktisk temp (Â°C):</label>
    <input type="number" id="actual" step="0.01">
  </div>

  <div class="form-row">
    <label for="corrected">Korrigerad temp (Â°C):</label>
    <input type="number" id="corrected" step="0.01" placeholder="BerÃ¤knas automatiskt">
  </div>
    <!-- HÃ¤ndelser â€“ symbolrad -->
  <div class="symbols-row">
    <div class="symbol-stack">
      <div class="sym">ğŸ©¸</div>
      <input type="checkbox" id="symMens">
    </div>
    <div class="symbol-stack">
      <div class="sym">ğŸ’</div>
      <input type="checkbox" id="symSex">
    </div>
    <div class="symbol-stack">
      <div class="sym">ğŸŒ¼</div>
      <input type="checkbox" id="symOv">
    </div>
    <div class="symbol-stack">
      <div class="sym">ğŸ’§</div>
      <input type="checkbox" id="symMucus">
    </div>
    <div class="symbol-stack">
      <div class="sym">â•</div>
      <input type="checkbox" id="symLHpos">
    </div>
    <div class="symbol-stack">
      <div class="sym">â–</div>
      <input type="checkbox" id="symLHneg">
    </div>
  </div>

  <div class="form-row" style="align-items:flex-start">
    <label for="note" style="margin-top:.2rem">Anteckning:</label>
    <textarea id="note" rows="2" placeholder="Valfritt"></textarea>
  </div>

  <div class="top-buttons" style="text-align:center; margin-top:.5rem;">
    <button class="button" id="saveBtn">Spara</button>
    <button class="button" id="exportBtn">Exportera data</button>
    <button class="button" id="importBtn">Importera data</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
  </div>

  <div class="table-wrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Tid</th>
          <th>F Â°C</th>
          <th>K Â°C</th>
          <th>HÃ¤ndelser</th>
          <th>Anteckning</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="text-align:center; margin-top:1rem;">
    <button class="button danger" id="clearBtn">Rensa all data</button>
  </div>

</div>

<!-- ============================
             GRAF
============================ -->
<div id="graf" class="tab-content">
  <div id="chartContainer">

    <!-- Ny liten info-knapp -->
    <button id="infoBtn" class="info-btn">i</button>

    <canvas id="bbtChart"></canvas>
  </div>

  <div class="chart-toolbar">
    <button class="button" id="exportChartBtn">Exportera graf</button>
  </div>
</div>

<!-- ============================
        LEGEND POPUP
============================ -->
<div id="legendPopup">
  <div class="legend-box">

    <h3>FÃ¶rklaring</h3>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(90,140,255,0.9);"></div>
      <span>BlÃ¥ linje â€“ Faktisk temperatur</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(240,100,120,0.85);"></div>
      <span>RÃ¶d prickad linje â€“ Korrigerad temp</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(195,215,180,0.45); height:10px;"></div>
      <span>GrÃ¶nt band â€“ Medellinje fÃ¶re Ã„L</span>
    </div>

    <hr style="margin:1rem 0;">

    <strong>Symboler:</strong>
    <div class="legend-entry">ğŸ’ â€“ Samlag</div>
    <div class="legend-entry">ğŸŒ¼ â€“ Ã„gglossning</div>
    <div class="legend-entry">ğŸ’§ â€“ Cervixsekret</div>
    <div class="legend-entry">â• â€“ LH positiv</div>
    <div class="legend-entry">â– â€“ LH negativ</div>

    <div class="legend-close">
      <button id="legendCloseBtn">StÃ¤ng</button>
    </div>

  </div>
</div>

<!-- ============================
              LH-FLIK
============================ -->
<div id="lh" class="tab-content">

  <div class="lh-toolbar">
    <div style="display:flex; gap:.5rem; align-items:center">
      <button class="button" id="lhPickBtn">VÃ¤lj bild</button>
      <input type="file" id="lhFile" accept="image/*" style="display:none">
    </div>

    <input type="date" id="lhDate">
  </div>

  <div class="lh-symbols-row" style="margin:.4rem 0 .3rem">
    <label class="lh-symbol-checkbox">ğŸ©·<small>N</small><br><input type="checkbox" class="lhSym" value="ğŸ©·"></label>
    <label class="lh-symbol-checkbox">â¤ï¸<small>T</small><br><input type="checkbox" class="lhSym" value="â¤ï¸"></label>
    <label class="lh-symbol-checkbox">ğŸ’œ<small>H</small><br><input type="checkbox" class="lhSym" value="ğŸ’œ"></label>
    <label class="lh-symbol-checkbox">ğŸ’™<small>L</small><br><input type="checkbox" class="lhSym" value="ğŸ’™"></label>
    <label class="lh-symbol-checkbox">ğŸ’š<small>â€“</small><br><input type="checkbox" class="lhSym" value="ğŸ’š"></label>
    <label class="lh-symbol-checkbox">ğŸ’›<small>?</small><br><input type="checkbox" class="lhSym" value="ğŸ’›"></label>

    <span class="lh-fm-em">
      <label class="lh-symbol-checkbox">â˜€ï¸<small>FM</small><br><input type="checkbox" id="lhFm"></label>
      <label class="lh-symbol-checkbox">ğŸŒ™<small>EM</small><br><input type="checkbox" id="lhEm"></label>
    </span>
  </div>

  <div id="lhPreview" class="lh-preview" style="display:none;">
    <img id="lhPreviewImg" class="lh-img" alt="">
    <small id="lhPreviewInfo" class="muted"></small>
  </div>

  <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
    <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
    <button class="button" id="lhSaveBtn">Spara</button>
  </div>

  <div id="lhList"></div>

</div>


<!-- ============================
       SCRIPT STARTAR HÃ„R
============================ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
/* ============================
      TABS (flikvÃ¤xling)
============================ */
document.querySelectorAll(".tab").forEach(btn => {
  btn.addEventListener("click", () => {
    const id = btn.dataset.tab;

    // inaktivera alla flikar
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

    // aktivera vald flik
    btn.classList.add("active");
    document.getElementById(id).classList.add("active");

    // ladda graf eller LH-lista vid behov
    if (id === "graf") renderChart();
    if (id === "lh") renderLHList();
  });
});
  /* ============================
        ELEMENT-REFERENSER (el)
     (superviktigt â€“ detta saknades)
  ============================ */
  const el = {
    date: document.getElementById('date'),
    time: document.getElementById('time'),
    actual: document.getElementById('actual'),
    corrected: document.getElementById('corrected'),
    note: document.getElementById('note'),

    symMens: document.getElementById('symMens'),
    symSex: document.getElementById('symSex'),
    symOv: document.getElementById('symOv'),
    symMucus: document.getElementById('symMucus'),
    symLHpos: document.getElementById('symLHpos'),
    symLHneg: document.getElementById('symLHneg'),

    saveBtn: document.getElementById('saveBtn'),
    exportBtn: document.getElementById('exportBtn'),
    importBtn: document.getElementById('importBtn'),
    importFile: document.getElementById('importFile'),
    clearBtn: document.getElementById('clearBtn'),

    dataTableBody: document.querySelector('#dataTable tbody'),
    chartCanvas: document.getElementById('bbtChart'),
    exportChartBtn: document.getElementById('exportChartBtn'),

    lhPickBtn: document.getElementById('lhPickBtn'),
    lhFile: document.getElementById('lhFile'),
    lhDate: document.getElementById('lhDate'),
    lhNote: document.getElementById('lhNote'),
    lhSaveBtn: document.getElementById('lhSaveBtn'),
    lhList: document.getElementById('lhList'),
    lhFm: document.getElementById('lhFm'),
    lhEm: document.getElementById('lhEm'),
    lhPreview: document.getElementById('lhPreview'),
    lhPreviewImg: document.getElementById('lhPreviewImg'),
    lhPreviewInfo: document.getElementById('lhPreviewInfo'),
    lhSymChecks: () => Array.from(document.querySelectorAll('.lhSym:checked'))
  };

  /* ============================
        STATE & DATA
  ============================ */
  let dataEntries = JSON.parse(localStorage.getItem("bbtData") || "[]");
  let lhByDate = JSON.parse(localStorage.getItem("lhDataByDate") || "{}");
  let chart = null;

  /* ============================
      TEMPKORRIGERING
  ============================ */
  const minutesFrom0400 = (t) => {
    if (!t) return 0;
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m - 240;
  };

  function computeCorrectedFrom(a, timeStr) {
    if (Number.isNaN(a)) return null;
    const mins = minutesFrom0400(timeStr || "04:00");
    return Number((a - 0.05 * (mins / 30)).toFixed(2));
  }

  function computeCorrectedFormInputs() {
    const a = parseFloat(el.actual.value);
    if (!isNaN(a)) {
      const c = computeCorrectedFrom(a, el.time.value);
      el.corrected.value = c?.toFixed(2) ?? "";
    }
  }

  /* ============================
        TABELL + SPARA ENTRY
  ============================ */
  function saveEntry() {
    const e = {
      date: el.date.value,
      time: el.time.value,
      actual: el.actual.value ? Number(el.actual.value) : null,
      corrected: el.corrected.value ? Number(el.corrected.value) : null,
      mens: el.symMens.checked,
      sex: el.symSex.checked,
      ovulation: el.symOv.checked,
      mucus: el.symMucus.checked,
      lhPos: el.symLHpos.checked,
      lhNeg: el.symLHneg.checked,
      note: el.note.value || ""
    };

    if (!e.date) return alert("VÃ¤lj datum fÃ¶rst.");

    const i = dataEntries.findIndex(x => x.date === e.date);
    if (i >= 0) dataEntries[i] = e;
    else dataEntries.push(e);

    localStorage.setItem("bbtData", JSON.stringify(dataEntries));
    renderTable();
    alert("âœ”ï¸ Sparat!");
  }

  function renderTable() {
    el.dataTableBody.innerHTML = "";
    dataEntries.sort((a,b)=>a.date.localeCompare(b.date));
    dataEntries.forEach((e, idx) => {
      const tr = document.createElement("tr");

      if (e.mens) tr.style.backgroundColor = "#ffe8ee";
      if (e.ovulation) tr.classList.add("ovulation-row");

      let events = "";
      if (e.mens) events += "ğŸ©¸ ";
      if (e.sex) events += "ğŸ’ ";
      if (e.ovulation) events += "ğŸŒ¼ ";
      if (e.mucus) events += "ğŸ’§ ";
      if (e.lhPos) events += "â• ";
      if (e.lhNeg) events += "â– ";

      tr.innerHTML = `
        <td>${e.date}</td>
        <td>${e.time || ""}</td>
        <td>${e.actual ?? ""}</td>
        <td>${e.corrected ?? ""}</td>
        <td>${events.trim() || "â€“"}</td>
        <td>${e.note}</td>
        <td><button onclick="editRow(${idx})">âœï¸</button></td>
      `;

      el.dataTableBody.appendChild(tr);
    });
  }

  window.editRow = function(i){
    const e = dataEntries[i];
    el.date.value = e.date;
    el.time.value = e.time;
    el.actual.value = e.actual;
    el.corrected.value = e.corrected;
    el.note.value = e.note;

    el.symMens.checked = e.mens;
    el.symSex.checked = e.sex;
    el.symOv.checked = e.ovulation;
    el.symMucus.checked = e.mucus;
    el.symLHpos.checked = e.lhPos;
    el.symLHneg.checked = e.lhNeg;
  };

// === MintblÃ¥ mÃ¥nadslappar ===
const MonthLabelPlugin = {
  id: "monthLabelPlugin",
  afterDraw(chart) {
    const { ctx, chartArea, scales } = chart;
    const xAxis = scales.xTop;
    if (!xAxis) return;

    const labels = chart.data.labels;
    if (!labels?.length) return;

    const monthNames = {
      "01": "Jan", "02": "Feb", "03": "Mar", "04": "Apr",
      "05": "Maj", "06": "Jun", "07": "Jul", "08": "Aug",
      "09": "Sep", "10": "Okt", "11": "Nov", "12": "Dec"
    };

    let prevMonth = null;

    labels.forEach((label, i) => {
      const [day, month] = label.split("-");
      if (!month) return;
      if (month !== prevMonth) {
        prevMonth = month;

        const x = xAxis.getPixelForValue(i);
        const y = chartArea.top - 36;

        const text = monthNames[month] || month;
        ctx.font = "13px Helvetica";
        const w = ctx.measureText(text).width + 18;

        const h = 20;
        const r = 6;

        ctx.fillStyle = "rgba(168,216,255,0.40)";
        ctx.strokeStyle = "rgba(120,150,180,0.35)";
        ctx.lineWidth = 1;

        ctx.beginPath();
        ctx.moveTo(x - w/2 + r, y);
        ctx.lineTo(x + w/2 - r, y);
        ctx.quadraticCurveTo(x + w/2, y, x + w/2, y + r);
        ctx.lineTo(x + w/2, y + h - r);
        ctx.quadraticCurveTo(x + w/2, y + h, x + w/2 - r, y + h);
        ctx.lineTo(x - w/2 + r, y + h);
        ctx.quadraticCurveTo(x - w/2, y + h, x - w/2, y + h - r);
        ctx.lineTo(x - w/2, y + r);
        ctx.quadraticCurveTo(x - w/2, y, x - w/2 + r, y);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "#2b4a65";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, x, y + h/2);
      }
    });
  }
};

Chart.register(MonthLabelPlugin);

function renderChart() {
  if (chart) chart.destroy();
  if (!dataEntries.length) return;

  dataEntries.sort((a, b) => a.date.localeCompare(b.date));

  // Datum (DD-MM)
  const dateLabels = dataEntries.map(e => {
    const [y, m, d] = e.date.split("-");
    return `${d.padStart(2, "0")}-${m}`;
  });

  // CD
  const cdLabels = dataEntries.map((_, i) =>
    (i + 1).toString().padStart(2, "0")
  );

  const actual = dataEntries.map(e => e.actual);
  const corrected = dataEntries.map(e => e.corrected);

  const ovIndex = dataEntries.findIndex(e => e.ovulation);
  const anns = [];

  // Mens
  const mensIdx = dataEntries
    .map((e, i) => e.mens ? i : null)
    .filter(i => i !== null);

  if (mensIdx.length) {
    anns.push({
      type: "box",
      xMin: mensIdx[0] - 0.5,
      xMax: mensIdx[mensIdx.length - 1] + 0.5,
      backgroundColor: "rgba(244,182,194,0.55)",
      borderWidth: 0,
      drawTime: "beforeDatasetsDraw"
    });
  }

  // Ã„gglossning
  if (ovIndex >= 0) {
    anns.push({
      type: "box",
      xMin: ovIndex - 0.5,
      xMax: ovIndex + 0.5,
      backgroundColor: "rgba(255,244,176,0.65)",
      borderWidth: 0,
      drawTime: "beforeDatasetsDraw"
    });
  }

  // Lutealfas
  if (ovIndex >= 0 && ovIndex < dataEntries.length - 1) {
    anns.push({
      type: "box",
      xMin: ovIndex + 0.5,
      xMax: dataEntries.length - 0.5,
      backgroundColor: "rgba(224,195,252,0.6)",
      borderWidth: 0,
      drawTime: "beforeDatasetsDraw"
    });
  }

  // Medellinje
  const beforeOv = ovIndex >= 0 ? dataEntries.slice(0, ovIndex) : dataEntries;
  const beforeCorr = beforeOv.map(e => e.corrected).filter(v => v != null);

  let bandMin = null, bandMax = null;

  if (beforeCorr.length) {
    const mean = beforeCorr.reduce((a, b) => a + b, 0) / beforeCorr.length;
    bandMin = mean - 0.01;
    bandMax = mean + 0.01;
  }

  const bandData = bandMax ? new Array(dataEntries.length).fill(bandMax) : [];

  chart = new Chart(el.chartCanvas, {
    type: "line",
    data: {
      labels: dateLabels,
      datasets: [
        {
          label: "Medelband",
          data: bandData,
          borderWidth: 0,
          pointRadius: 0,
          fill: bandMin != null ? {
            target: { value: bandMin },
            above: "rgba(195,215,180,0.45)",
            below: "rgba(195,215,180,0.45)"
          } : false,
          spanGaps: true
        },
        {
          label: "Faktisk",
          data: actual,
          borderColor: "rgba(90,140,255,0.9)",
          backgroundColor: "rgba(90,140,255,0.9)",
          borderWidth: 2,
          pointRadius: 3,
          pointStyle: "circle",
          tension: 0.25,
          spanGaps: true
        },
        {
          label: "Korrigerad",
          data: corrected,
          borderColor: "rgba(240,100,120,0.85)",
          backgroundColor: "rgba(240,100,120,0.85)",
          borderDash: [4, 3],
          borderWidth: 1.6,
          pointRadius: 3,
          pointStyle: "triangle",
          tension: 0.25,
          spanGaps: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,

      layout: {
        padding: { top: 60, bottom: 35 }  // plats fÃ¶r mÃ¥nadslappar
      },

      scales: {
y: {
  min: Math.min(...corrected.filter(v=>v!=null)) - 0.2,
  max: Math.max(...corrected.filter(v=>v!=null)) + 0.15,
  ticks: {
    stepSize: 0.05,
    callback: v => v.toFixed(2)
  },
  grid: {
    color: "rgba(0,0,0,0.12)",
    lineWidth: 1
  },
  title: {
    display: true,
    text: "Â°C"
  }
},

         xTop: {
          type: "category",
          position: "top",
          labels: dateLabels,
          ticks: {
            autoSkip: false,
            maxRotation: 0,
            callback: (value, i) => {
              const [day, month] = dateLabels[i].split("-");
              return day; // visar endast dag (dd)
            },
            font: { size: 13 }
          },
          grid: { display: false }
        },

         x: {
          type: "category",
          position: "bottom",
          labels: cdLabels,
          ticks: {
            autoSkip: false,
            maxRotation: 0,
            font: { size: 13 },
            callback: (value, index) => {
      // SÃ„TT "CD â†’" framfÃ¶r fÃ¶rsta siffran endast
              return index === 0 
                ? `CD â†’  ${cdLabels[index]}` 
                : cdLabels[index];
            }
          },
          grid: { display: false }
        },

      plugins: {
        legend: { display: false },
        annotation: { annotations: anns }
      }
    }
  });
}

  /* ============================
        LH-FLÃ–DE (kort version)
  ============================ */
  function renderLHList() {
    el.lhList.innerHTML = "";
    Object.keys(lhByDate).sort().forEach(d=>{
      lhByDate[d].forEach(item=>{
        const row = document.createElement("div");
        row.className = "lh-preview";
        row.innerHTML = `<img src="${item.dataUrl}" class="lh-img">`;
        el.lhList.appendChild(row);
      });
    });
  }

  /* ============================
        EVENT-LISTENERS
  ============================ */
  el.actual.addEventListener("blur", computeCorrectedFormInputs);
  el.time.addEventListener("change", computeCorrectedFormInputs);

  // Spara
  el.saveBtn.addEventListener("click", saveEntry);

  // Export data
  el.exportBtn.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify({bbtData:dataEntries, lhDataByDate:lhByDate}, null, 2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "BBT_Ida_data.json";
    a.click();
  });

  // Import data
  el.importBtn.addEventListener("click", ()=> el.importFile.click());

  // Export graf
  el.exportChartBtn.addEventListener("click", ()=>{
    const link = document.createElement("a");
    link.href = el.chartCanvas.toDataURL("image/png");
    link.download = "BBT_graf.png";
    link.click();
  });

  // Legend-popup
  const legendPopup = document.getElementById("legendPopup");
  document.getElementById("infoBtn").addEventListener("click", ()=> legendPopup.style.display="flex");
  document.getElementById("legendCloseBtn").addEventListener("click", ()=> legendPopup.style.display="none");
  legendPopup.addEventListener("click", e=>{
    if(e.target===legendPopup) legendPopup.style.display="none";
  });

  /* ============================
                INIT
  ============================ */
  renderTable();
  renderLHList();
});
</script>

</body>
</html>