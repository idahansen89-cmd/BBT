<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBT & LH</title>
  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <style>
    :root{
      --pink:#f4b6c2;
      --pink-hover:#e599ab;
      --text:#333;
      --line:#eee;
      --mens-bg:#ffe6ec;
      --luteal-bg:#f2e6ff;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Helvetica Neue", Arial, sans-serif;
      background:#fff; color:var(--text); margin:0; padding:0;
    }
    h1{ text-align:center; margin:1rem 0; }

    /* Tabs */
    .tabs{ display:flex; justify-content:center; gap:.4rem; border-bottom:2px solid #ddd; padding-bottom:.4rem; }
    .tab{
      padding:.7rem 1.2rem; border:none; border-radius:8px 8px 0 0; background:#f4f4f4;
      font-weight:600; cursor:pointer;
    }
    .tab.active{ background:#fff; border-bottom:2px solid #fff; color:#e06b8f; }

    .tab-content{
      display:none; max-width:820px; margin:1rem auto; padding:1rem;
      border:1px solid var(--line); border-radius:12px; background:#fff;
    }
    .tab-content.active{ display:block; }

    /* Form layout */
    .form-row{ display:flex; align-items:center; gap:.6rem; margin-bottom:.6rem; }
    .form-row label{ width:160px; font-weight:600; }
    .form-row input, .form-row select, .form-row textarea{
      flex:1; padding:.45rem .6rem; border:1px solid #ccc; border-radius:8px; font-size:.95rem;
    }
    textarea{ resize:vertical; min-height:56px; }

    .inline-symbols{ display:flex; align-items:center; gap:1rem; margin:.4rem 0 .6rem; }
    .inline-symbols .symbol{ display:inline-flex; align-items:center; gap:.4rem; font-size:1.15rem; }

    /* Buttons */
    .button{
      background:var(--pink); color:#222; border:none; border-radius:8px;
      padding:.55rem 1.1rem; font-weight:700; cursor:pointer;
    }
    .button:hover{ background:var(--pink-hover); }
    .button.danger{ background:var(--pink); }
    .button.danger:hover{ background:var(--pink-hover); }

    /* Table */
    .table-wrap{ overflow-x:auto; margin-top:1rem; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:.55rem; border:1px solid #ddd; text-align:center; }
    tr.mens-row{ background:#ffe5ec; }

    .top-buttons{ display:flex; gap:.6rem; flex-wrap:wrap; margin-top:.3rem; margin-bottom:.4rem; }

    /* Chart */
    .chart-toolbar{ display:flex; justify-content:center; margin-top:.75rem; }

    /* LH tab */
    .lh-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:.6rem; flex-wrap:wrap; }
    .lh-symbols-row{ display:flex; flex-wrap:wrap; gap:.8rem; }
    .lh-symbol-checkbox{ display:inline-block; text-align:center; font-size:1.3rem; line-height:1.2; }
    .lh-symbol-checkbox small{ display:block; color:#777; font-size:.75rem; margin-top:.15rem; }
    .lh-row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:.6rem;
      padding:.5rem 0; border-bottom:1px solid #eee;
    }
    .lh-img{
      width:100%;
      max-height:120px; /* smalare rader */
      object-fit:contain;
      border-radius:8px;
      background:#fff;
    }
    .lh-info{ flex:1; }
    #chartContainer {
  display: block;
  border: none;
}
canvas#bbtChart {
  display: block;
  width: 100% !important;
  height: 100% !important;
}
  </style>
</head>
<body>
  <h1>BBT & LH</h1>

  <div class="tabs">
    <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
    <button class="tab" data-tab="graf">ğŸ“ˆ Graf</button>
    <button class="tab" data-tab="lh">ğŸ§ª LH-test</button>
  </div>

  <!-- Inmatning & Tabell -->
  <div id="inmatning" class="tab-content active">
    <div class="form-row">
      <label for="date">Datum:</label>
      <input type="date" id="date">
    </div>
    <div class="form-row">
      <label for="time">Tid (BBT):</label>
      <input type="time" id="time">
    </div>
    <div class="form-row">
      <label for="actual">Faktisk temp (Â°C):</label>
      <input type="number" step="0.01" id="actual" placeholder="t.ex. 36.42">
    </div>
    <div class="form-row">
      <label for="corrected">Korrigerad temp (Â°C):</label>
      <input type="number" step="0.01" id="corrected" placeholder="BerÃ¤knas automatiskt">
    </div>
    <div class="form-row">
      <label for="mens">Mensstatus:</label>
      <select id="mens">
        <option>â€“</option>
        <option>Mens</option>
      </select>
    </div>
    <div class="form-row">
      <label for="mucus">Sekret:</label>
      <select id="mucus">
        <option>â€“</option>
        <option>Klart</option>
        <option>Ã„ggviteliknande</option>
        <option>KrÃ¤mig</option>
      </select>
    </div>
    <div class="form-row">
      <label for="lhSel">LH-test:</label>
      <select id="lhSel">
        <option>â€“</option>
        <option>Positivt</option>
        <option>Negativt</option>
      </select>
    </div>

    <div class="inline-symbols">
      <span class="symbol" title="Samlag">ğŸ’ <input type="checkbox" id="sex"></span>
      <span class="symbol" title="BekrÃ¤ftad Ã¤gglossning">ğŸŒ¼ <input type="checkbox" id="ovulation"></span>
    </div>

    <div class="form-row" style="align-items:flex-start">
      <label for="note" style="margin-top:.2rem">Anteckning:</label>
      <textarea id="note" rows="2" placeholder="Valfritt"></textarea>
    </div>

    <div class="top-buttons">
      <button class="button" id="saveBtn">Spara</button>
      <button class="button" id="exportBtn">Exportera data</button>
      <button class="button" id="importBtn">Importera data</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>

    <div class="table-wrap">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Datum</th><th>Tid</th><th>Faktisk</th><th>Korr</th>
            <th>Mens</th><th>Sekret</th><th>LH</th><th>ğŸ’</th><th>ğŸŒ¼</th><th>Anteckning</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="text-align:center; margin-top:1rem;">
      <button class="button danger" id="clearBtn">Rensa all data</button>
    </div>
  </div>

  <!-- Graf -->
<div id="graf" class="tab-content">
  <div id="chartContainer" style="width:100%;max-width:1200px;height:520px;margin:auto;overflow:hidden;position:relative;">
    <canvas id="bbtChart" width="1200" height="520"></canvas>
  </div>
  <div class="chart-toolbar">
    <button class="button" id="exportChartBtn">Exportera graf</button>
  </div>
</div>

  <!-- LH-test -->
  <div id="lh" class="tab-content">
    <div class="lh-toolbar">
      <div style="display:flex; gap:.5rem; align-items:center">
        <button class="button" id="lhPickBtn">VÃ¤lj bild</button>
        <input type="file" id="lhFile" accept="image/*" style="display:none">
      </div>
      <input type="date" id="lhDate">
    </div>

    <div class="lh-symbols-row" style="margin:.6rem 0">
      <label class="lh-symbol-checkbox" title="NÃ¤stan positiv">ğŸ©·<small>N</small><br><input type="checkbox" class="lhSym" value="ğŸ©·"></label>
      <label class="lh-symbol-checkbox" title="LH-topp">â¤ï¸<small>T</small><br><input type="checkbox" class="lhSym" value="â¤ï¸"></label>
      <label class="lh-symbol-checkbox" title="HÃ¶g">ğŸ’œ<small>H</small><br><input type="checkbox" class="lhSym" value="ğŸ’œ"></label>
      <label class="lh-symbol-checkbox" title="LÃ¥g">ğŸ’™<small>L</small><br><input type="checkbox" class="lhSym" value="ğŸ’™"></label>
      <label class="lh-symbol-checkbox" title="Negativ">ğŸ’š<small>â€“</small><br><input type="checkbox" class="lhSym" value="ğŸ’š"></label>
      <label class="lh-symbol-checkbox" title="Oklart">ğŸ’›<small>?</small><br><input type="checkbox" class="lhSym" value="ğŸ’›"></label>
    </div>

    <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
      <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
      <button class="button" id="lhSaveBtn">Spara</button>
    </div>

    <div id="lhList"></div>
  </div>

  <script>
    alert("âœ… Scriptet startar korrekt!");
  document.addEventListener('DOMContentLoaded', () => {
    /* ===== Tabs ===== */
   document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(id).classList.add('active');
    if(id==='graf') renderChart();
    if(id==='lh') renderLHList();
  });
});

    /* ===== Elements ===== */
    const el = {
      date: document.getElementById('date'),
      time: document.getElementById('time'),
      actual: document.getElementById('actual'),
      corrected: document.getElementById('corrected'),
      mens: document.getElementById('mens'),
      mucus: document.getElementById('mucus'),
      lhSel: document.getElementById('lhSel'),
      sex: document.getElementById('sex'),
      ovulation: document.getElementById('ovulation'),
      note: document.getElementById('note'),

      saveBtn: document.getElementById('saveBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      clearBtn: document.getElementById('clearBtn'),

      dataTableBody: document.querySelector('#dataTable tbody'),
      chartCanvas: document.getElementById('bbtChart'),
      exportChartBtn: document.getElementById('exportChartBtn'),

      lhPickBtn: document.getElementById('lhPickBtn'),
      lhFile: document.getElementById('lhFile'),
      lhDate: document.getElementById('lhDate'),
      lhNote: document.getElementById('lhNote'),
      lhSaveBtn: document.getElementById('lhSaveBtn'),
      lhList: document.getElementById('lhList'),
      lhSymChecks: () => Array.from(document.querySelectorAll('.lhSym:checked'))
    };

    /* ===== State ===== */
    let dataEntries = JSON.parse(localStorage.getItem('bbtData') || '[]');
    let lhEntries   = JSON.parse(localStorage.getItem('lhData')  || '[]');
    let chart;

    /* ===== Helpers ===== */
const minutesFrom0400 = (t) => {
  if (!t) return 0;
  const [h, m] = t.split(':').map(Number);
  return (h * 60 + m) - 240; // skillnad i minuter frÃ¥n kl. 04:00
};

function computeCorrectedFrom(a, timeStr) {
  if (Number.isNaN(a)) return null;
  const mins = minutesFrom0400(timeStr || '04:00');
  // RÃ¤tt korrigering: minus efter 04:00, plus fÃ¶re 04:00
  const corr = a - 0.05 * (mins / 30);
  return Number(corr.toFixed(2));
}

function computeCorrectedFormInputs() {
  const a = parseFloat(el.actual.value);
  if (Number.isNaN(a)) return;
  const corr = computeCorrectedFrom(a, el.time.value);
  if (corr !== null) el.corrected.value = corr.toFixed(2);
}

    function saveEntry(){
      const e = {
        date: el.date.value,
        time: el.time.value,
        actual: el.actual.value ? Number(el.actual.value) : null,
        corrected: el.corrected.value ? Number(el.corrected.value) : null,
        mens: el.mens.value,
        mucus: el.mucus.value,
        lh: el.lhSel.value,
        sex: el.sex.checked,
        ovulation: el.ovulation.checked,
        note: el.note.value
      };
      if(!e.date) return alert('VÃ¤lj datum.');
      const i = dataEntries.findIndex(x=>x.date===e.date);
      if(i>=0) dataEntries[i]=e; else dataEntries.push(e);
      localStorage.setItem('bbtData', JSON.stringify(dataEntries));
      renderTable();
    }

    function renderTable(){
      el.dataTableBody.innerHTML = '';
      dataEntries.sort((a,b)=>a.date.localeCompare(b.date));

      dataEntries.forEach((e, idx)=>{
        const tr = document.createElement('tr');
        if(e.mens==='Mens') tr.classList.add('mens-row');
        // bygg celler
        tr.innerHTML = `
          <td data-field="date">${e.date||''}</td>
          <td data-field="time" contenteditable="true">${e.time||''}</td>
          <td data-field="actual" contenteditable="true">${e.actual??''}</td>
          <td data-field="corrected">${e.corrected??''}</td>
          <td data-field="mens" contenteditable="true">${e.mens||'â€“'}</td>
          <td data-field="mucus" contenteditable="true">${e.mucus||'â€“'}</td>
          <td data-field="lh" contenteditable="true">${e.lh||'â€“'}</td>
          <td data-field="sex" contenteditable="true">${e.sex?'ğŸ’':''}</td>
          <td data-field="ovulation" contenteditable="true">${e.ovulation?'ğŸŒ¼':''}</td>
          <td data-field="note" contenteditable="true">${e.note||''}</td>
        `;
        // lyssnare fÃ¶r varje redigerbar cell
        tr.querySelectorAll('[contenteditable="true"]').forEach(td=>{
          td.addEventListener('keydown', (ev)=>{
            if(ev.key==='Enter'){ ev.preventDefault(); td.blur(); }
          });
          td.addEventListener('blur', ()=>{
            const field = td.getAttribute('data-field');
            let val = td.textContent.trim();
            const row = dataEntries[idx];

            // normalisera specialfÃ¤lt
            if(field==='actual'){
              const num = parseFloat(val.replace(',', '.'));
              row.actual = Number.isNaN(num) ? null : Number(num.toFixed(2));
              // rÃ¤kna om korrigerad utifrÃ¥n eventuellt uppdaterad tid
              row.corrected = (row.actual!==null) ? computeCorrectedFrom(row.actual, row.time) : null;
              // uppdatera korr-cellen i tabellen
              tr.querySelector('td[data-field="corrected"]').textContent = (row.corrected??'');
            } else if(field==='time'){
              row.time = val;
              // omrÃ¤kna korrigerad om actual finns
              if(typeof row.actual==='number'){
                row.corrected = computeCorrectedFrom(row.actual, row.time);
                tr.querySelector('td[data-field="corrected"]').textContent = (row.corrected??'');
              }
            } else if(field==='mens'){
              row.mens = (val===''||val==='-') ? 'â€“' : val;
              if(row.mens==='Mens') tr.classList.add('mens-row'); else tr.classList.remove('mens-row');
            } else if(field==='mucus'){
              row.mucus = (val===''||val==='-') ? 'â€“' : val;
            } else if(field==='lh'){
              row.lh = (val===''||val==='-') ? 'â€“' : val;
            } else if(field==='sex'){
              // toggla pÃ¥ enkel text: tomt -> ğŸ’, annars tomt
              row.sex = (val==='ğŸ’');
              td.textContent = row.sex ? 'ğŸ’' : '';
            } else if(field==='ovulation'){
              row.ovulation = (val==='ğŸŒ¼');
              td.textContent = row.ovulation ? 'ğŸŒ¼' : '';
            } else if(field==='note'){
              row.note = val;
            }

            // spara + uppdatera graf
            localStorage.setItem('bbtData', JSON.stringify(dataEntries));
            // uppdatera graf om graf-fliken Ã¤r aktiv
            if(document.querySelector('.tab.active')?.dataset.tab==='graf'){
              renderChart();
            }
          });
        });

        el.dataTableBody.appendChild(tr);
      });
    }

    function clearData(){
      if(!confirm('Vill du verkligen rensa all data?')) return;
      dataEntries = [];
      lhEntries = [];
      localStorage.clear();
      if(chart) chart.destroy();
      renderTable();
      renderLHList();
    }

/* ===== Graf (mobilanpassad, stabil hÃ¶jd) ===== */
function renderChart(){
  if(chart) chart.destroy();

  // sortera data
  dataEntries.sort((a,b)=>a.date.localeCompare(b.date));

  // Etiketter i format DD-MM
  const labels = dataEntries.map(e=>{
    if(!e.date) return "";
    const [y,m,d] = e.date.split("-");
    return `${d}-${m}`;
  });

  const actual    = dataEntries.map(e=>e.actual);
  const corrected = dataEntries.map(e=>e.corrected);

  // Medel fÃ¶re Ã¤gglossning (CD1 â†’ ovulation)
  const ovIndex = dataEntries.findIndex(e=>e.ovulation);
  const preVals = (ovIndex>0 ? actual.slice(0, ovIndex) : actual).filter(v=>typeof v==='number');
  const avg = preVals.length ? preVals.reduce((a,b)=>a+b,0)/preVals.length : null;

  // Bakgrundsmarkeringar
  const anns = [];
  const firstNonMens = dataEntries.findIndex(e=>e.mens!=='Mens');
  const mensEndX = (firstNonMens===-1) ? labels.length-0.5 : firstNonMens-0.5;
  if(firstNonMens!==0)
    anns.push({type:'box', xMin:0, xMax:mensEndX, backgroundColor:'rgba(255,230,236,.5)', borderWidth:0});
  if(ovIndex>-1)
    anns.push({type:'box', xMin:ovIndex+0.5, xMax:labels.length-0.5, backgroundColor:'rgba(242,230,255,.5)', borderWidth:0});

  // Symboler lÃ¤ngs x-axeln
  const symbols = dataEntries.map(e=>{
    const s=[];
    if(e.sex) s.push('ğŸ’');
    if(e.ovulation) s.push('ğŸŒ¼');
    if(e.mucus==='Ã„ggviteliknande') s.push('ğŸ’§');
    return s;
  });

  // Skapa grafen (responsiv men fast hÃ¶jd)
  chart = new Chart(el.chartCanvas, {
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'Faktisk temperatur',
          data:actual, borderColor:'#3b82f6', backgroundColor:'#3b82f6',
          pointRadius:3, tension:0.28, spanGaps:true
        },
        { label:'Korrigerad temperatur',
          data:corrected, borderColor:'#ef4444', backgroundColor:'#ef4444',
          borderDash:[4,4], pointRadius:2, tension:0.28, spanGaps:true
        },
        ...(avg ? [{
          label:'Medel fÃ¶re Ã¤gglossning',
          data:Array(labels.length).fill(avg),
          borderColor:'#888', borderDash:[6,4], pointRadius:0
        }] : [])
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      aspectRatio:2.2, // gÃ¶r grafen bredare Ã¤n hÃ¶g
      scales:{
        y:{ 
          min:34.9, max:38.6,
          ticks:{ stepSize:0.1, color:'#000' },
          title:{ display:true, text:'Temperatur (Â°C)' } 
        },
        x:{ 
          ticks:{ 
            color:'#000', autoSkip:true, maxTicksLimit:10, maxRotation:0 
          } 
        }
      },
      plugins:{
        legend:{ position:'bottom', labels:{ color:'#000' } },
        annotation:{ annotations:anns }
      },
      animation:false
    },
    plugins:[{
      id:'symbols',
      afterDatasetsDraw(c){
        const ctx=c.ctx;
        ctx.font='10px sans-serif';
        ctx.textAlign='center';
        const meta=c.getDatasetMeta(0);
        c.data.labels.forEach((_,i)=>{
          const p=meta.data[i]; if(!p) return;
          const x=p.x, y=c.scales.y.bottom-18;
          if(symbols[i]?.length)
            symbols[i].forEach((sm,j)=>ctx.fillText(sm,x,y-j*13));
        });
      }
    }]
  });
}
    /* ===== Export / Import data ===== */
    el.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({bbtData:dataEntries, lhData:lhEntries}, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'BBT_Ida_data.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    el.importBtn.addEventListener('click', ()=>el.importFile.click());
    el.importFile.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const o = JSON.parse(r.result);
          if(o.bbtData) dataEntries = o.bbtData;
          if(o.lhData)  lhEntries  = o.lhData;
          localStorage.setItem('bbtData', JSON.stringify(dataEntries));
          localStorage.setItem('lhData',  JSON.stringify(lhEntries));
          renderTable(); renderLHList();
          if(document.querySelector('.tab.active')?.dataset.tab==='graf') renderChart();
          alert('Data importerad!');
        }catch{
          alert('Ogiltig fil.');
        }
      };
      r.readAsText(file);
      e.target.value='';
    });

    el.clearBtn.addEventListener('click', clearData);

    /* ===== LH-lista & fullskÃ¤rm med blÃ¤ddring ===== */
    const blobToDataURL = b => new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=rej;
      r.readAsDataURL(b);
    });

    function renderLHList(){
      el.lhList.innerHTML = '';
      lhEntries.sort((a,b)=>a.date.localeCompare(b.date));
      lhEntries.forEach((e,i)=>{
        const row = document.createElement('div');
        row.className = 'lh-row';
        row.innerHTML = `
          <div style="flex:0 0 38%">
            <img class="lh-img" src="${e.dataUrl}" alt="LH-bild" data-idx="${i}">
          </div>
          <div class="lh-info">
            <div style="font-weight:700">${e.date||''}</div>
            <div style="font-size:1.15rem; margin:.15rem 0;">${(e.symbols||[]).join(' ')}</div>
            <div style="font-size:.9rem; color:#555">${e.note||''}</div>
          </div>
          <div>
            <button class="button danger" data-del="${i}">Ta bort</button>
          </div>
        `;
        // fullskÃ¤rm
        row.querySelector('img').addEventListener('click', (ev)=>openGallery(parseInt(ev.target.dataset.idx,10)));
        // radera
        row.querySelector('[data-del]').addEventListener('click', ()=>{
          lhEntries.splice(i,1);
          localStorage.setItem('lhData', JSON.stringify(lhEntries));
          renderLHList();
        });
        el.lhList.appendChild(row);
      });
    }

    // FullskÃ¤rm + blÃ¤ddring
    let galleryIndex = 0;
    function openGallery(startIdx){
      if(!lhEntries.length) return;
      galleryIndex = startIdx;

      const o = document.createElement('div');
      o.style = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999';
      const img = document.createElement('img');
      img.style = 'max-width:92%;max-height:92%;border-radius:10px;background:#fff';
      const left = document.createElement('div');
      const right = document.createElement('div');
      left.style = right.style = 'position:absolute;top:0;width:50%;height:100%;';
      left.style.left='0'; right.style.right='0';

      function show(i){
        if(i<0) i = lhEntries.length-1;
        if(i>=lhEntries.length) i = 0;
        galleryIndex = i;
        img.src = lhEntries[galleryIndex].dataUrl;
      }
      show(galleryIndex);

      // klickzoner
      left.addEventListener('click', (e)=>{ e.stopPropagation(); show(galleryIndex-1); });
      right.addEventListener('click', (e)=>{ e.stopPropagation(); show(galleryIndex+1); });
      // stÃ¤ng pÃ¥ klick utanfÃ¶r
      o.addEventListener('click', ()=>document.body.removeChild(o));
      o.appendChild(img); o.appendChild(left); o.appendChild(right);
      document.body.appendChild(o);

      // piltangenter
      function onKey(ev){
        if(ev.key==='ArrowLeft'){ show(galleryIndex-1); }
        if(ev.key==='ArrowRight'){ show(galleryIndex+1); }
        if(ev.key==='Escape'){ cleanup(); }
      }
      function cleanup(){
        document.removeEventListener('keydown', onKey);
        if(o.parentNode) document.body.removeChild(o);
      }
      document.addEventListener('keydown', onKey);

      // svep (touch)
      let sx=null, sy=null;
      o.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
      o.addEventListener('touchend', (e)=>{
        const t=e.changedTouches[0]; if(sx===null) return;
        const dx = t.clientX - sx, dy = t.clientY - sy;
        if(Math.abs(dx)>40 && Math.abs(dy)<60){
          if(dx<0) show(galleryIndex+1); else show(galleryIndex-1);
        } else {
          cleanup();
        }
        sx=sy=null;
      }, {passive:true});
    }

    /* ===== Events ===== */
    el.actual.addEventListener('blur', computeCorrectedFormInputs);
    el.time.addEventListener('change', ()=>{ if(el.actual.value) computeCorrectedFormInputs(); });
    el.saveBtn.addEventListener('click', saveEntry);

    // --- LH: vÃ¤lj bild ---
    el.lhPickBtn.addEventListener('click', () => {
      // sÃ¤kert klick fÃ¶r iPhone/Safari
      el.lhFile.dispatchEvent(new MouseEvent('click', { bubbles: true }));
    });

    // --- LH: skapa / uppdatera fÃ¶rhandsvisning ---
    function updateLHPreview(imageDataURL = null) {
      // ta bort eventuell tidigare fÃ¶rhandsvisning
      let wrap = document.getElementById('lhPreviewWrap');
      if (wrap) wrap.remove();

      // om ingen bilddata finns Ã¤n, hÃ¤mta frÃ¥n input
      const file = el.lhFile.files && el.lhFile.files[0];
      if (!file && !imageDataURL) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const dataUrl = imageDataURL || ev.target.result;

        wrap = document.createElement('div');
        wrap.id = 'lhPreviewWrap';
        wrap.style = 'text-align:center;margin:.6rem auto;border:1px solid #ddd;border-radius:10px;padding:.5rem;max-width:230px;background:#fafafa;';

        const img = document.createElement('img');
        img.src = dataUrl;
        img.style = 'display:block;max-width:200px;max-height:140px;margin:auto;border-radius:8px;';

        const info = document.createElement('div');
        info.id = 'lhPreviewInfo';
        info.style = 'font-size:.85rem;color:#444;margin-top:.3rem;';

        wrap.appendChild(img);
        wrap.appendChild(info);
        el.lhSaveBtn.parentNode.insertBefore(wrap, el.lhSaveBtn);

        refreshPreviewInfo();
      };

      if (file) reader.readAsDataURL(file);
      else if (imageDataURL) reader.onload(); // om data redan finns
    }

    // --- uppdatera texten under bilden (datum, symboler, anteckning) ---
    function refreshPreviewInfo() {
      const info = document.getElementById('lhPreviewInfo');
      if (!info) return;
      const date = el.lhDate.value ? el.lhDate.value : '(Datum ej valt)';
      const syms = el.lhSymChecks().map(x => x.value).join(' ') || 'â€“';
      const note = el.lhNote.value ? `"${el.lhNote.value}"` : '';
      info.innerHTML = `
        <div><strong>${date}</strong></div>
        <div style="font-size:1.2rem;margin:.2rem 0;">${syms}</div>
        <div>${note}</div>
      `;
    }

    // --- visa fÃ¶rhandsvisning nÃ¤r bild vÃ¤ljs ---
    el.lhFile.addEventListener('change', () => updateLHPreview());

    // --- automatiskt uppdatera info i fÃ¶rhandsvisningen ---
    ['change', 'input'].forEach(evt => {
      el.lhDate.addEventListener(evt, refreshPreviewInfo);
      el.lhNote.addEventListener(evt, refreshPreviewInfo);
    });
    document.querySelectorAll('.lhSym').forEach(cb => cb.addEventListener('change', refreshPreviewInfo));

    // --- LH: spara bild + metadata ---
    el.lhSaveBtn.addEventListener('click', () => {
      const file = el.lhFile.files && el.lhFile.files[0];
      if (!file) { alert('VÃ¤lj bild fÃ¶rst.'); return; }
      if (!el.lhDate.value) { alert('VÃ¤lj datum.'); return; }

      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        const symbols = el.lhSymChecks().map(x => x.value);
        const note = el.lhNote.value || '';

        lhEntries.push({
          date: el.lhDate.value,
          symbols,
          note,
          dataUrl
        });

        localStorage.setItem('lhData', JSON.stringify(lhEntries));
        renderLHList();

        // nollstÃ¤ll formulÃ¤ret + ta bort fÃ¶rhandsvisning
        el.lhNote.value = '';
        el.lhFile.value = '';
        const prev = document.getElementById('lhPreviewWrap');
        if (prev) prev.remove();
        document.querySelectorAll('.lhSym').forEach(cb => cb.checked = false);

        alert('âœ… Bild sparad!');
      };

      reader.onerror = (err) => {
        console.error(err);
        alert('Kunde inte lÃ¤sa in bilden.');
      };

      reader.readAsDataURL(file);
    });

    /* ===== Init ===== */
    renderTable();
    renderLHList();
  });
</script>
</body>
</html>
