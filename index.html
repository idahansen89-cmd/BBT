<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBT & LH</title>

  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>

  <style>
:root {
  --pink: #f4b6c2;
  --apricot: #f7c8a0;
  --yellow: #fff4b0;
  --mint: #baf2bb;
  --blue: #a8d8ff;
  --lavender: #e0c3fc;
  --pearl: #f5f5fa;

  --pink-hover: #e599ab;
  --text: #333;
  --line: #eee;
}

* { box-sizing: border-box; }

body {
  font-family: "Helvetica Neue", Arial, sans-serif;
  margin: 0;
  background: #fff;
  color: var(--text);
}

h1 {
  text-align: center;
  margin: 1rem 0;
}

/* ============================
          TABS
============================ */
.tabs {
  display: flex;
  justify-content: center;
  gap: 0.4rem;
  border-bottom: 2px solid #ddd;
  padding-bottom: 0.4rem;
}
.tab {
  padding: 0.7rem 1.2rem;
  border: none;
  border-radius: 8px 8px 0 0;
  background: #f4f4f4;
  font-weight: 600;
  cursor: pointer;
}
.tab.active {
  background: #fff;
  border-bottom: 2px solid #fff;
  color: #e06b8f;
}

.tab-content {
  display: none;
  max-width: 820px;
  margin: 1rem auto;
  padding: 1rem;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: #fff;
}
.tab-content.active {
  display: block;
}

/* ============================
          FORMUL√ÑR
============================ */
.form-row {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin-bottom: 0.6rem;
}
.form-row label {
  width: 160px;
  font-weight: 600;
}
.form-row input,
.form-row select,
.form-row textarea {
  flex: 1;
  padding: 0.45rem 0.6rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 0.95rem;
}
textarea { resize: vertical; min-height: 56px; }

/* ============================
        SYMBOLRAD (BBT)
============================ */
.symbols-row {
  display: flex;
  justify-content: center;
  gap: 14px;
  align-items: flex-start;
  margin: 0.5rem 0 0.25rem;
}
.symbol-stack {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 36px;
}
.symbol-stack .sym {
  font-size: 1.6rem;
  line-height: 1;
}
.symbol-stack input {
  margin-top: 0.25rem;
}

/* ============================
          KNAPPAR
============================ */
.button {
  background: var(--pink);
  color: #1f3b5b;          /* sammansatt med i-knappen */
  border: none;
  border-radius: 8px;
  padding: 0.55rem 1.1rem;
  font-weight: 700;
  cursor: pointer;
}
.button:hover {
  background: var(--pink-hover);
}

/* ============================
        TABELL
============================ */
.table-wrap {
  overflow-x: auto;
  margin-top: 1rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 0.9rem;
}
th, td {
  padding: 0.5rem 0.4rem;
  border: 1px solid #ddd;
  white-space: nowrap;
  text-align: center;
}
thead th {
  background: #ffe5ec;
  font-weight: 700;
}
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr.mens-row { background-color: #ffe8ee !important; }
tbody tr.ovulation-row { background-color: #fff9d9 !important; }

td:nth-child(1), th:nth-child(1) { width: 85px; }
td:nth-child(2), th:nth-child(2) { width: 70px; }
td:nth-child(3), td:nth-child(4),
th:nth-child(3), th:nth-child(4) { width: 70px; }
td:nth-child(5), th:nth-child(5) { width: 85px; }
td:nth-child(6), th:nth-child(6) { width: 90px; }
td:nth-child(7), th:nth-child(7) { width: 150px; text-align: left; }

td button {
  margin: 0 2px;
  border-radius: 6px;
  background: #f4b6c2;
  border: none;
  font-size: 0.8rem;
  padding: 0.3rem 0.6rem;
}

/* ============================
        GRAFSTIL
============================ */
#chartContainer {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto;
  height: 420px;
  position: relative;
}

#bbtChart {
  display: block;
  width: 100% !important;
  height: 100% !important;
}

.chart-toolbar {
  display: flex;
  justify-content: center;
  margin-top: 0.75rem;
}

/* ============================
        INFO-BUTTON (i)
============================ */
.info-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: var(--pink);
  font-size: 1.15rem;
  font-weight: 900;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  color: #1f3b5b;          /* bl√• text */
}
.info-btn:hover {
  background: var(--pink-hover);
}

/* ============================
      POPUP F√ñR LEGEND
============================ */
#legendPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 5000;
}
.legend-box {
  background: #fff;
  padding: 1.6rem 2rem;
  max-width: 330px;
  width: 90%;
  border-radius: 12px;
  box-shadow: 0 4px 22px rgba(0,0,0,0.22);
}
.legend-box h3 {
  margin-top: 0;
  text-align: center;
}
.legend-entry {
  margin: 0.4rem 0;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
.legend-color {
  width: 20px;
  height: 8px;
  border-radius: 4px;
}
.legend-close {
  text-align: center;
  margin-top: 1.2rem;
}
.legend-close button {
  background: var(--pink);
  border: none;
  padding: 0.5rem 1.3rem;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  color: #1f3b5b;
}

/* ============================
          LH-FLIK
============================ */
.lh-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.6rem;
  flex-wrap: wrap;
}
.lh-symbols-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.8rem;
  align-items: center;
}
.lh-symbol-checkbox {
  text-align: center;
  font-size: 1.25rem;
}
.lh-symbol-checkbox small {
  display: block;
  color: #777;
  font-size: 0.75rem;
}
.lh-preview {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin: 0.4rem 0;
  background: #fafafa;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 0.4rem;
}
.lh-img {
  width: 100%;
  max-height: 110px;
  object-fit: contain;
  border-radius: 8px;
  background: #fff;
}
.lh-row {
  display: flex;
  justify-content: space-between;
  gap: 0.6rem;
  padding: 0.45rem 0;
  border-bottom: 1px solid #eee;
}

/* ============================
          MOBIL
============================ */
@media (max-width: 600px) {
  th, td {
    font-size: 0.8rem;
    padding: 0.35rem 0.25rem;
  }
  td:nth-child(7) {
    max-width: 90px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}
  </style>
</head>

<body>
<h1>BBT & LH</h1>

<div class="tabs">
  <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
  <button class="tab" data-tab="graf">üìà Graf</button>
  <button class="tab" data-tab="lh">üß™ LH-test</button>
</div>

<!-- ============================
       INMATNING & TABELL
============================ -->
<div id="inmatning" class="tab-content active">

  <div class="form-row">
    <label for="date">Datum:</label>
    <input type="date" id="date">
  </div>

  <div class="form-row">
    <label for="time">Tid (BBT):</label>
    <input type="time" id="time">
  </div>

  <div class="form-row">
    <label for="actual">Faktisk temp (¬∞C):</label>
    <input type="number" id="actual" step="0.01">
  </div>

  <div class="form-row">
    <label for="corrected">Korrigerad temp (¬∞C):</label>
    <input type="number" id="corrected" step="0.01" placeholder="Ber√§knas automatiskt">
  </div>

  <!-- H√§ndelser ‚Äì symbolrad -->
  <div class="symbols-row">
    <div class="symbol-stack">
      <div class="sym">ü©∏</div>
      <input type="checkbox" id="symMens">
    </div>
    <div class="symbol-stack">
      <div class="sym">üíû</div>
      <input type="checkbox" id="symSex">
    </div>
    <div class="symbol-stack">
      <div class="sym">üåº</div>
      <input type="checkbox" id="symOv">
    </div>
    <div class="symbol-stack">
      <div class="sym">üíß</div>
      <input type="checkbox" id="symMucus">
    </div>
    <div class="symbol-stack">
      <div class="sym">‚ûï</div>
      <input type="checkbox" id="symLHpos">
    </div>
    <div class="symbol-stack">
      <div class="sym">‚ûñ</div>
      <input type="checkbox" id="symLHneg">
    </div>
  </div>

  <div class="form-row" style="align-items:flex-start">
    <label for="note" style="margin-top:.2rem">Anteckning:</label>
    <textarea id="note" rows="2" placeholder="Valfritt"></textarea>
  </div>

  <div class="top-buttons" style="text-align:center; margin-top:.5rem;">
    <button class="button" id="saveBtn">Spara</button>
    <button class="button" id="exportBtn">Exportera data</button>
    <button class="button" id="importBtn">Importera data</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
  </div>

  <div class="table-wrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Tid</th>
          <th>F ¬∞C</th>
          <th>K ¬∞C</th>
          <th>H√§ndelser</th>
          <th>Anteckning</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="text-align:center; margin-top:1rem;">
    <button class="button danger" id="clearBtn">Rensa all data</button>
  </div>

</div>

<!-- ============================
             GRAF
============================ -->
<div id="graf" class="tab-content">
  <div id="chartContainer">
    <!-- Info-knapp -->
    <button id="infoBtn" class="info-btn">i</button>
    <canvas id="bbtChart"></canvas>
  </div>

  <div class="chart-toolbar">
    <button class="button" id="exportChartBtn">Exportera graf</button>
  </div>
</div>

<!-- ============================
        LEGEND POPUP
============================ -->
<div id="legendPopup">
  <div class="legend-box">

    <h3>F√∂rklaring</h3>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(90,140,255,0.9);"></div>
      <span>Bl√• linje ‚Äì Faktisk temperatur</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(240,100,120,0.85);"></div>
      <span>R√∂d prickad linje ‚Äì Korrigerad temperatur</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(195,215,180,0.45); height:10px;"></div>
      <span>Gr√∂nt band ‚Äì Medellinje f√∂re √§gglossning</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(255,244,176,0.65); height:10px;"></div>
      <span>Gult f√§lt ‚Äì √Ñgglossningsdag</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(224,195,252,0.6); height:10px;"></div>
      <span>Lila f√§lt ‚Äì Lutealfas</span>
    </div>

    <hr style="margin:1rem 0;">

    <strong>Symboler:</strong>
    <div class="legend-entry">üíû ‚Äì Samlag</div>
    <div class="legend-entry">üåº ‚Äì √Ñgglossning</div>
    <div class="legend-entry">üíß ‚Äì Cervixsekret</div>

    <div class="legend-close">
      <button id="legendCloseBtn">St√§ng</button>
    </div>

  </div>
</div>
<!-- ============================
              LH-FLIK
============================ -->
<div id="lh" class="tab-content">

  <div class="lh-toolbar">
    <div style="display:flex; gap:.5rem; align-items:center">
      <button class="button" id="lhPickBtn">V√§lj bild</button>
      <input type="file" id="lhFile" accept="image/*" style="display:none">
    </div>

    <input type="date" id="lhDate">
  </div>

  <div class="lh-symbols-row" style="margin:.4rem 0 .3rem">
    <label class="lh-symbol-checkbox" title="N√§stan positiv">ü©∑<small>N</small><br><input type="checkbox" class="lhSym" value="ü©∑"></label>
    <label class="lh-symbol-checkbox" title="LH-topp">‚ù§Ô∏è<small>T</small><br><input type="checkbox" class="lhSym" value="‚ù§Ô∏è"></label>
    <label class="lh-symbol-checkbox" title="H√∂g">üíú<small>H</small><br><input type="checkbox" class="lhSym" value="üíú"></label>
    <label class="lh-symbol-checkbox" title="L√•g">üíô<small>L</small><br><input type="checkbox" class="lhSym" value="üíô"></label>
    <label class="lh-symbol-checkbox" title="Negativ">üíö<small>‚Äì</small><br><input type="checkbox" class="lhSym" value="üíö"></label>
    <label class="lh-symbol-checkbox" title="Oklart">üíõ<small>?</small><br><input type="checkbox" class="lhSym" value="üíõ"></label>

    <span class="lh-fm-em">
      <label class="lh-symbol-checkbox" title="FM (f√∂rmiddag)">‚òÄÔ∏è<small>FM</small><br><input type="checkbox" id="lhFm"></label>
      <label class="lh-symbol-checkbox" title="EM (eftermiddag/kv√§ll)">üåô<small>EM</small><br><input type="checkbox" id="lhEm"></label>
    </span>
  </div>

  <div id="lhPreview" class="lh-preview" style="display:none;">
    <img id="lhPreviewImg" class="lh-img" alt="">
    <small id="lhPreviewInfo" class="muted"></small>
  </div>

  <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
    <textarea id="lhNote" placeholder="Anteckning (valfritt)" style="flex:1"></textarea>
    <button class="button" id="lhSaveBtn">Spara</button>
  </div>

  <div id="lhList"></div>

</div>


<!-- ============================
       SCRIPT STARTAR H√ÑR
============================ -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ============================
        ELEMENTREFERENSER
  ============================ */
  const el = {
    date: document.getElementById("date"),
    time: document.getElementById("time"),
    actual: document.getElementById("actual"),
    corrected: document.getElementById("corrected"),
    note: document.getElementById("note"),

    symMens:  document.getElementById("symMens"),
    symSex:   document.getElementById("symSex"),
    symOv:    document.getElementById("symOv"),
    symMucus: document.getElementById("symMucus"),
    symLHpos: document.getElementById("symLHpos"),
    symLHneg: document.getElementById("symLHneg"),

    saveBtn: document.getElementById("saveBtn"),
    exportBtn: document.getElementById("exportBtn"),
    importBtn: document.getElementById("importBtn"),
    importFile: document.getElementById("importFile"),
    clearBtn: document.getElementById("clearBtn"),

    dataTableBody: document.querySelector("#dataTable tbody"),
    chartCanvas: document.getElementById("bbtChart"),
    exportChartBtn: document.getElementById("exportChartBtn"),

    lhPickBtn: document.getElementById("lhPickBtn"),
    lhFile: document.getElementById("lhFile"),
    lhDate: document.getElementById("lhDate"),
    lhNote: document.getElementById("lhNote"),
    lhSaveBtn: document.getElementById("lhSaveBtn"),
    lhList: document.getElementById("lhList"),
    lhFm: document.getElementById("lhFm"),
    lhEm: document.getElementById("lhEm"),
    lhPreview: document.getElementById("lhPreview"),
    lhPreviewImg: document.getElementById("lhPreviewImg"),
    lhPreviewInfo: document.getElementById("lhPreviewInfo"),
    lhSymChecks: () => Array.from(document.querySelectorAll(".lhSym:checked"))
  };

  /* ============================
        STATE & LOCALSTORAGE
  ============================ */
  let dataEntries = JSON.parse(localStorage.getItem("bbtData") || "[]");

  // LH-migrering till objekt per datum
  (function migrateLH(){
    const newKey = "lhDataByDate";
    const oldArr = JSON.parse(localStorage.getItem("lhData") || "null");
    let obj = JSON.parse(localStorage.getItem(newKey) || "null") || {};

    if (Array.isArray(oldArr)) {
      oldArr.forEach(e => {
        const d = e.date || "ok√§nt-datum";
        if (!obj[d]) obj[d] = [];
        obj[d].push({
          dataUrl: e.dataUrl,
          symbols: e.symbols || [],
          note: e.note || "",
          tod: null,
          ts: Date.now()
        });
      });
      localStorage.removeItem("lhData");
    }
    localStorage.setItem(newKey, JSON.stringify(obj));
  })();

  let lhByDate = JSON.parse(localStorage.getItem("lhDataByDate") || "{}");
  let chart;

  /* ============================
      TEMPKORRIGERING
  ============================ */
  const minutesFrom0400 = (t) => {
    if (!t) return 0;
    const [h, m] = t.split(":").map(Number);
    return h * 60 + m - 240;
  };

  function computeCorrectedFrom(a, timeStr) {
    if (Number.isNaN(a)) return null;
    const mins = minutesFrom0400(timeStr || "04:00");
    return Number((a - 0.05 * (mins / 30)).toFixed(2));
  }

  function computeCorrectedFormInputs() {
    const a = parseFloat(el.actual.value);
    if (!isNaN(a)) {
      const c = computeCorrectedFrom(a, el.time.value);
      el.corrected.value = (c !== null && c !== undefined) ? c.toFixed(2) : "";
    }
  }

  /* ============================
        SPARA ENTRY + TABELL
  ============================ */
  function saveEntry() {
    const e = {
      date: el.date.value,
      time: el.time.value,
      actual: el.actual.value ? Number(el.actual.value) : null,
      corrected: el.corrected.value ? Number(el.corrected.value) : null,
      mens: el.symMens.checked || false,
      sex: el.symSex.checked || false,
      ovulation: el.symOv.checked || false,
      mucus: el.symMucus.checked || false,
      lhPos: el.symLHpos.checked || false,
      lhNeg: el.symLHneg.checked || false,
      note: el.note.value || ""
    };

    if (!e.date) return alert("V√§lj datum f√∂rst.");

    const i = dataEntries.findIndex(x => x.date === e.date);
    if (i >= 0) dataEntries[i] = e;
    else dataEntries.push(e);

    localStorage.setItem("bbtData", JSON.stringify(dataEntries));

    el.date.value = "";
    el.time.value = "";
    el.actual.value = "";
    el.corrected.value = "";
    el.note.value = "";
    el.symMens.checked = false;
    el.symSex.checked = false;
    el.symOv.checked = false;
    el.symMucus.checked = false;
    el.symLHpos.checked = false;
    el.symLHneg.checked = false;

    renderTable();
    alert("‚úÖ Data sparad!");
  }

  function renderTable() {
    el.dataTableBody.innerHTML = "";
    dataEntries.sort((a, b) => a.date.localeCompare(b.date));

    dataEntries.forEach((e, idx) => {
      const tr = document.createElement("tr");

      if (e.mens) tr.style.backgroundColor = "#ffe8ee";
      if (e.ovulation) tr.classList.add("ovulation-row");
      if (e.mens && e.ovulation) tr.classList.remove("ovulation-row");

      let events = "";
      if (e.mens) events += "ü©∏ ";
      if (e.sex) events += "üíû ";
      if (e.ovulation) events += "üåº ";
      if (e.mucus) events += "üíß ";
      if (e.lhPos) events += "‚ûï ";
      if (e.lhNeg) events += "‚ûñ ";

      tr.innerHTML = `
        <td>${e.date || ""}</td>
        <td>${e.time || ""}</td>
        <td>${e.actual ?? ""}</td>
        <td>${e.corrected ?? ""}</td>
        <td>${events.trim() || "‚Äì"}</td>
        <td>${e.note || ""}</td>
        <td>
          <button class="table-btn small-edit" title="Redigera">‚úèÔ∏è</button>
          <button class="table-btn small-del" title="Radera">üóëÔ∏è</button>
        </td>
      `;

      const delBtn = tr.querySelector(".small-del");
      if (delBtn) {
        delBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();

          let summary = "";
          if (e.mens) summary += "ü©∏ ";
          if (e.sex) summary += "üíû ";
          if (e.ovulation) summary += "üåº ";
          if (e.mucus) summary += "üíß ";
          if (e.lhPos) summary += "‚ûï ";
          if (e.lhNeg) summary += "‚ûñ ";
          summary = summary.trim() || "‚Äì";

          const confirmText = `Vill du ta bort posten den ${e.date}?\n\nH√§ndelser: ${summary}`;
          if (confirm(confirmText)) {
            dataEntries.splice(idx, 1);
            localStorage.setItem("bbtData", JSON.stringify(dataEntries));
            renderTable();
          }
        });
      }

      tr.querySelector(".small-edit").addEventListener("click", () => {
        el.date.value = e.date;
        el.time.value = e.time;
        el.actual.value = e.actual || "";
        el.corrected.value = e.corrected || "";
        el.note.value = e.note || "";

        el.symMens.checked = e.mens || false;
        el.symSex.checked = e.sex || false;
        el.symOv.checked = e.ovulation || false;
        el.symMucus.checked = e.mucus || false;
        el.symLHpos.checked = e.lhPos || false;
        el.symLHneg.checked = e.lhNeg || false;

        alert("Posten laddades f√∂r redigering.");
      });

      el.dataTableBody.appendChild(tr);
    });
  }

  function clearData(){
    if(!confirm("Vill du verkligen rensa all data?")) return;
    dataEntries = [];
    lhByDate = {};
    localStorage.removeItem("bbtData");
    localStorage.removeItem("lhData");
    localStorage.setItem("lhDataByDate", JSON.stringify(lhByDate));
    if(chart) chart.destroy();
    renderTable();
    renderLHList();
  }
    /* ============================
        GRAF ‚Äì DATUM + CD
  ============================ */

 // Plugin: bl√• m√•nads-etiketter ("Okt", "Nov" ...) ovanf√∂r datumraden
const MonthLabelPlugin = {
  id: "monthLabelPlugin",
  afterDraw(chart, args, opts) {
    const { ctx, chartArea, scales } = chart;
    const xAxis = scales.xTop;
    if (!xAxis) return;

    const labels = chart.data.labels;
    const months = opts?.months || [];   // vi skickar in denna fr√•n renderChart
    if (!labels || !labels.length) return;

    const monthNames = [
      "Jan","Feb","Mar","Apr","Maj","Jun",
      "Jul","Aug","Sep","Okt","Nov","Dec"
    ];

    let prevMonth = null;

    labels.forEach((_, i) => {
      const mNum = months[i];
      if (!mNum) return;

      // hoppa om samma m√•nad som f√∂rra etiketten
      if (mNum === prevMonth) return;
      prevMonth = mNum;

      const monthIndex = parseInt(mNum, 10) - 1;
      const text = monthNames[monthIndex] || mNum;

      const x = xAxis.getPixelForValue(i);
      const y = chartArea.top - 70;  // h√∂jd ovanf√∂r datumraden

      ctx.save();
      ctx.font = "13px Helvetica";
      const w = ctx.measureText(text).width + 18;
      const h = 22;
      const r = 7;

      // Ljusbl√• rundad ruta
      ctx.fillStyle = "rgba(168,216,255,0.9)";
      ctx.strokeStyle = "rgba(120,150,180,0.5)";
      ctx.lineWidth = 1.2;

      ctx.beginPath();
      ctx.moveTo(x - w/2 + r, y);
      ctx.lineTo(x + w/2 - r, y);
      ctx.quadraticCurveTo(x + w/2, y, x + w/2, y + r);
      ctx.lineTo(x + w/2, y + h - r);
      ctx.quadraticCurveTo(x + w/2, y + h, x + w/2 - r, y + h);
      ctx.lineTo(x - w/2 + r, y + h);
      ctx.quadraticCurveTo(x - w/2, y + h, x - w/2, y + h - r);
      ctx.lineTo(x - w/2, y + r);
      ctx.quadraticCurveTo(x - w/2, y, x - w/2 + r, y);
      ctx.fill();
      ctx.stroke();

      // Texten "Okt", "Nov", ...
      ctx.fillStyle = "#2b4a65";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, x, y + h / 2);
      ctx.restore();
    });
  }
};

  // Plugin: CD-etikett i bl√• ruta f√∂re siffrorna l√§ngst ned
  const CdLabelPlugin = {
    id: "cdLabelPlugin",
    afterDraw(chart) {
      const {ctx, chartArea, scales} = chart;
      const xScale = scales.x;
      if (!xScale) return;

      const firstX = xScale.getPixelForValue(0);
      const y = chartArea.bottom + 10;   // samma radomr√•de som CD-siffrorna

      const text = "CD";
      ctx.save();
      ctx.font = "13px Helvetica";
      const w = ctx.measureText(text).width + 16;
      const h = 16;
      const r = 6;
      const x = firstX - w - 6;          // precis framf√∂r f√∂rsta siffran

      ctx.fillStyle = "rgba(150, 235, 220, 0.75)";      // Pastell turkos
ctx.strokeStyle = "rgba(90, 160, 150, 0.40)";     // Diskret kantlinje
      ctx.lineWidth = 1.2;

      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = "#2b4a65";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, x + w/2, y + h/2);
      ctx.restore();
    }
  };

  Chart.register(MonthLabelPlugin, CdLabelPlugin);

  function renderChart() {
    try {
      if (chart) chart.destroy();
      if (!dataEntries.length) return;

      dataEntries.sort((a, b) => a.date.localeCompare(b.date));

// Datumlabels: tv√• rader med bara "dd" (varannan rad)
// Datumlabels: bara "dd" (riktig radbrytning g√∂rs i ticks.callback)
const dateLabels = dataEntries.map(e => {
  if (!e.date) return "";
  const [y, m, d] = e.date.split("-");
  return d.padStart(2, "0");
});

// M√•nadslista (mm) till m√•nads-pluginen
const monthNumbers = dataEntries.map(e => {
  if (!e.date) return null;
  const [y, m] = e.date.split("-");
  return m;  // "10", "11", osv
});

      // CD-labels: "01", "02", ...
      const cdLabels = dataEntries.map((_, i) =>
        String(i + 1).padStart(2, "0")
      );

      const actual = dataEntries.map(e => e.actual);
      const corrected = dataEntries.map(e => e.corrected);

      const ovIndex = dataEntries.findIndex(e => e.ovulation);
      const anns = [];

      // Mensbakgrund
      const mensIndices = dataEntries
        .map((e, i) => (e.mens ? i : null))
        .filter(i => i !== null);

      if (mensIndices.length > 0) {
        anns.push({
          type: "box",
          xMin: mensIndices[0] - 0.5,
          xMax: mensIndices[mensIndices.length - 1] + 0.5,
          backgroundColor: "rgba(244,182,194,0.55)",
          borderWidth: 0,
          drawTime: "beforeDatasetsDraw"
        });
      }

      // √Ñgglossningsdag (gult)
      if (ovIndex >= 0) {
        anns.push({
          type: "box",
          xMin: ovIndex - 0.5,
          xMax: ovIndex + 0.5,
          backgroundColor: "rgba(255,244,176,0.65)",
          borderWidth: 0,
          drawTime: "beforeDatasetsDraw"
        });
      }

      // Lutealfas (lila)
      if (ovIndex >= 0 && ovIndex < dataEntries.length - 1) {
        anns.push({
          type: "box",
          xMin: ovIndex + 0.5,
          xMax: dataEntries.length - 0.5,
          backgroundColor: "rgba(224,195,252,0.6)",
          borderWidth: 0,
          drawTime: "beforeDatasetsDraw"
        });
      }

      // Medellinje (gr√∂nt band) med korrigerad temp f√∂re √ÑL
      const beforeOvCorrected = (ovIndex >= 0 ? dataEntries.slice(0, ovIndex) : dataEntries)
        .map(e => e.corrected)
        .filter(v => v != null);

      let bandMin = null, bandMax = null;
      if (beforeOvCorrected.length) {
        const mean = beforeOvCorrected.reduce((a,b)=>a+b,0) / beforeOvCorrected.length;
        bandMin = mean - 0.01;
        bandMax = mean + 0.01;
      }

      const bandData = bandMax != null
        ? new Array(dataEntries.length).fill(bandMax)
        : [];

      chart = new Chart(el.chartCanvas, {
        type: "line",
        data: {
          labels: dateLabels,      // anv√§nds av xTop + m√•nadsplugin
          datasets: [
            {
              label: "Medelspann f√∂re √§gglossning",
              data: bandData,
              borderWidth: 0,
              pointRadius: 0,
              fill: bandMin != null ? {
                target: { value: bandMin },
                above: "rgba(195, 215, 180, 0.45)",
                below: "rgba(195, 215, 180, 0.45)"
              } : false,
              spanGaps: true
            },
            {
              label: "Faktisk temperatur",
              data: actual,
              borderColor: "rgba(90,140,255,0.9)",
              backgroundColor: "rgba(90,140,255,0.9)",
              borderWidth: 2,
              pointRadius: 3,
              pointStyle: "circle",
              tension: 0.25,
              spanGaps: true
            },
            {
              label: "Korrigerad temperatur",
              data: corrected,
              borderColor: "rgba(240,100,120,0.85)",
              backgroundColor: "rgba(240,100,120,0.85)",
              borderDash: [4, 3],
              borderWidth: 1.6,
              pointRadius: 3,
              pointStyle: "triangle",
              tension: 0.25,
              spanGaps: true
            }
          ]
        },

        options: {
          responsive: true,
          maintainAspectRatio: false,

          layout: {
            padding: { top: 40, bottom: 40, left: 20, right: 20 }
          },

          scales: {
            y: {
              type: "linear",
              position: "left",
              min: Math.floor((Math.min(...corrected.filter(v => v != null)) - 0.25) * 20) / 20,
              max: Math.ceil((Math.max(...corrected.filter(v => v != null)) + 0.15) * 20) / 20,
              ticks: {
                stepSize: 0.05,
                callback(v) { return Number(v).toFixed(2); }
              },
              grid: {
                drawTicks: true,
                drawBorder: true,
                color: "rgba(0,0,0,0.12)",
                lineWidth: 1
              },
              title: {
                display: false,
                text: "¬∞C"
              }
            },

xTop: {
  type: "category",
  position: "top",
  labels: dateLabels,
ticks: {
  font: { size: 13 },
  maxRotation: 0,
  minRotation: 0,
  autoSkip: false,
  padding: 6,
  callback: function (value, index) {

    // H√§mta textetiketten korrekt:
    const label = this.chart.data.labels[index];

    // j√§mna index ‚Üí dd p√• rad 1
    if (index % 2 === 0) {
      return [label, ""];
    }
    // udda index ‚Üí dd p√• rad 2
    else {
      return ["", label];
    }
  }
},
  offset: true,
  grid: { display: false }
},

            x: {
              type: "category",
              position: "bottom",
              labels: cdLabels,
              ticks: {
                autoSkip: false,
                maxRotation: 0,
                minRotation: 0,
                font: { size: 12 },
                padding: 4,
                callback: function (value, index) {
                  const label = this.getLabelForValue(value);

                  // j√§mna index ‚Üí CD p√• rad 1
                  if (index % 2 === 0) {
                    return [label, ""];
                  }
                  // udda index ‚Üí CD p√• rad 2
                  else {
                  return ["", label];
                  }
                }
              },
              title: {
                display: false
              },
              grid: { display: false }
            }
          },

plugins: {
  legend: { display: false },
  annotation: {
    drawTime: "beforeDatasetsDraw",
    annotations: anns
  },
  monthLabelPlugin: {
    months: monthNumbers
  }
},
animation: false
}
});

    } catch (err) {
      console.error("‚ùå Fel i renderChart:", err);
      alert("Grafen kunde inte ritas:\n" + err.message);
    }
  }

  /* ============================
          EXPORT / IMPORT
  ============================ */
  el.exportBtn.addEventListener("click", () => {
    const blob = new Blob(
      [JSON.stringify({ bbtData: dataEntries, lhDataByDate: lhByDate }, null, 2)],
      { type: "application/json" }
    );
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "BBT_Ida_data.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  el.importBtn.addEventListener("click", () => el.importFile.click());
  el.importFile.addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const o = JSON.parse(r.result);
        if (o.bbtData) dataEntries = o.bbtData;
        if (o.lhDataByDate) lhByDate  = o.lhDataByDate;
        else if (o.lhData) {
          lhByDate = {};
          if (Array.isArray(o.lhData)) {
            o.lhData.forEach(e => {
              const d = e.date || "ok√§nt-datum";
              if (!lhByDate[d]) lhByDate[d] = [];
              lhByDate[d].push({
                dataUrl: e.dataUrl,
                symbols: e.symbols || [],
                note: e.note || "",
                tod: null,
                ts: Date.now()
              });
            });
          }
        }
        localStorage.setItem("bbtData", JSON.stringify(dataEntries));
        localStorage.setItem("lhDataByDate", JSON.stringify(lhByDate));
        renderTable();
        renderLHList();
        if (document.querySelector(".tab.active")?.dataset.tab === "graf") renderChart();
        alert("Data importerad!");
      } catch {
        alert("Ogiltig fil.");
      }
    };
    r.readAsText(file);
    e.target.value = "";
  });

  el.clearBtn.addEventListener("click", clearData);

  el.exportChartBtn?.addEventListener("click", () => {
    const link = document.createElement("a");
    link.download = "BBT_graf.png";
    link.href = el.chartCanvas.toDataURL("image/png");
    link.click();
  });

  /* ============================
      LH: f√∂rhandsvisning + lista
  ============================ */
  function updateLHPreview(){
    const file = el.lhFile.files && el.lhFile.files[0];
    if (!file){ el.lhPreview.style.display = "none"; return; }
    const rd = new FileReader();
    rd.onload = (ev)=>{
      el.lhPreviewImg.src = ev.target.result;
      const syms = el.lhSymChecks().map(x=>x.value).join(" ") || "‚Äì";
      const tod = el.lhFm.checked ? "‚òÄÔ∏è FM" : (el.lhEm.checked ? "üåô EM" : "‚Äî");
      const d = el.lhDate.value || "(Datum ej valt)";
      const n = el.lhNote.value ? `"${el.lhNote.value}"` : "";
      el.lhPreviewInfo.textContent = `${d}  ‚Ä¢  ${syms}  ‚Ä¢  ${tod}  ${n ? ("‚Ä¢ "+n) : ""}`;
      el.lhPreview.style.display = "flex";
    };
    rd.readAsDataURL(file);
  }

  el.lhPickBtn.addEventListener("click", ()=> el.lhFile.click());
  el.lhFile.addEventListener("change", updateLHPreview);
  [el.lhDate, el.lhNote].forEach(x=>["input","change"].forEach(evt=>x.addEventListener(evt, updateLHPreview)));
  document.querySelectorAll(".lhSym").forEach(cb=>cb.addEventListener("change", updateLHPreview));
  el.lhFm.addEventListener("change", ()=>{ if(el.lhFm.checked) el.lhEm.checked=false; updateLHPreview(); });
  el.lhEm.addEventListener("change", ()=>{ if(el.lhEm.checked) el.lhFm.checked=false; updateLHPreview(); });

  function renderLHList(){
    el.lhList.innerHTML = "";
    const dates = Object.keys(lhByDate).sort();
    dates.forEach(date=>{
      (lhByDate[date]||[]).forEach((item, idx)=>{
        const row = document.createElement("div");
        row.className = "lh-row";
        row.innerHTML = `
          <div style="flex:0 0 38%">
            <img class="lh-img" src="${item.dataUrl}" alt="LH-bild" data-date="${date}" data-idx="${idx}">
          </div>
          <div class="lh-info">
            <div style="font-weight:700">${date}</div>
            <div style="font-size:1.15rem; margin:.15rem 0;">${(item.symbols||[]).join(" ")}</div>
            <div class="muted">${item.tod ? item.tod : "‚Äî"}</div>
            <div style="font-size:.9rem; color:#555">${item.note||""}</div>
          </div>
          <div><button class="button danger" data-del="${date}::${idx}">Ta bort</button></div>
        `;
        row.querySelector("img").addEventListener("click", (ev)=>openGallery(date, parseInt(ev.target.dataset.idx,10)));
        row.querySelector("[data-del]").addEventListener("click", (ev)=>{
          const [d,iStr] = ev.target.getAttribute("data-del").split("::");
          const i = parseInt(iStr,10);
          if(Array.isArray(lhByDate[d])) {
            lhByDate[d].splice(i,1);
            if(lhByDate[d].length===0) delete lhByDate[d];
            localStorage.setItem("lhDataByDate", JSON.stringify(lhByDate));
            renderLHList();
          }
        });
        el.lhList.appendChild(row);
      });
    });
  }

  function allLHFlat(){
    const out=[];
    Object.keys(lhByDate).sort().forEach(date=>{
      (lhByDate[date]||[]).forEach(item=>out.push({date, ...item}));
    });
    return out;
  }

  function openGallery(date, idxInDate){
    const flat = allLHFlat();
    if(!flat.length) return;

    let flatIndex = 0, count=0;
    Object.keys(lhByDate).sort().some(d=>{
      const arr = lhByDate[d]||[];
      if(d===date){ flatIndex = count + idxInDate; return true; }
      count += arr.length; return false;
    });

    const o = document.createElement("div");
    o.style = "position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999";
    const img = document.createElement("img");
    img.style = "max-width:92%;max-height:92%;border-radius:10px;background:#fff";
    const left = document.createElement("div");
    const right = document.createElement("div");
    left.style = right.style = "position:absolute;top:0;width:50%;height:100%;";
    left.style.left="0"; right.style.right="0";

    function show(i){
      if(i<0) i = flat.length-1;
      if(i>=flat.length) i = 0;
      flatIndex = i;
      img.src = flat[flatIndex].dataUrl;
    }
    show(flatIndex);

    left.addEventListener("click", (e)=>{ e.stopPropagation(); show(flatIndex-1); });
    right.addEventListener("click", (e)=>{ e.stopPropagation(); show(flatIndex+1); });
    o.addEventListener("click", ()=>document.body.removeChild(o));
    o.appendChild(img); o.appendChild(left); o.appendChild(right);
    document.body.appendChild(o);

    function onKey(ev){
      if(ev.key==="ArrowLeft"){ show(flatIndex-1); }
      if(ev.key==="ArrowRight"){ show(flatIndex+1); }
      if(ev.key==="Escape"){ cleanup(); }
    }
    function cleanup(){ document.removeEventListener("keydown", onKey); if(o.parentNode) document.body.removeChild(o); }
    document.addEventListener("keydown", onKey);

    let sx=null, sy=null;
    o.addEventListener("touchstart", (e)=>{ const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
    o.addEventListener("touchend", (e)=>{
      const t=e.changedTouches[0]; if(sx===null) return;
      const dx = t.clientX - sx, dy = t.clientY - sy;
      if(Math.abs(dx)>40 && Math.abs(dy)<60){ if(dx<0) show(flatIndex+1); else show(flatIndex-1); }
      else { cleanup(); }
      sx=sy=null;
    }, {passive:true});
  }

  /* ============================
        INFO-KNAPP / LEGEND
  ============================ */
  const legendPopup = document.getElementById("legendPopup");
  document.getElementById("infoBtn").addEventListener("click", () => {
    legendPopup.style.display = "flex";
  });
  document.getElementById("legendCloseBtn").addEventListener("click", () => {
    legendPopup.style.display = "none";
  });
  legendPopup.addEventListener("click", (e) => {
    if (e.target === legendPopup) legendPopup.style.display = "none";
  });

  /* ============================
             TABS
  ============================ */
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.tab;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(id).classList.add("active");

      if (id === "graf") renderChart();
      if (id === "lh") renderLHList();
    });
  });

  /* ============================
             EVENTS
  ============================ */
  el.actual.addEventListener("blur", computeCorrectedFormInputs);
  el.time.addEventListener("change", () => {
    if (el.actual.value) computeCorrectedFormInputs();
  });
  el.saveBtn.addEventListener("click", saveEntry);

  /* ============================
             INIT
  ============================ */
  renderTable();
  renderLHList();
});
</script>

</body>
</html>
  