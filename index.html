<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBT & LH</title>
  <link rel="icon" type="image/png" href="B29437FC-696F-4754-AAAB-A6ED096BC64C.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>

<style>
:root {
  --pink: #f4b6c2;
  --apricot: #f7c8a0;
  --yellow: #fff4b0;
  --mint: #baf2bb;
  --blue: #a8d8ff;
  --lavender: #e0c3fc;
  --pearl: #f5f5fa;

  --pink-hover: #e599ab;
  --text: #333;
  --line: #eee;
}

* { box-sizing: border-box; }

body {
  font-family: "Helvetica Neue", Arial, sans-serif;
  margin: 0;
  background: #fff;
  color: var(--text);
}

h1 {
  text-align: center;
  margin: 1rem 0;
}

/* ===== TABS ===== */
.tabs {
  display: flex;
  justify-content: center;
  gap: 0.4rem;
  border-bottom: 2px solid #ddd;
  padding-bottom: 0.4rem;
}
.tab {
  padding: 0.7rem 1.2rem;
  border: none;
  border-radius: 8px 8px 0 0;
  background: #f4f4f4;
  font-weight: 600;
  cursor: pointer;
}
.tab.active {
  background: #fff;
  border-bottom: 2px solid #fff;
  color: #e06b8f;
}

.tab-content {
  display: none;
  max-width: 820px;
  margin: 1rem auto;
  padding: 1rem;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: #fff;
}
.tab-content.active {
  display: block;
}

/* ===== FORM ===== */
.form-row {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin-bottom: 0.6rem;
}
.form-row label {
  width: 160px;
  font-weight: 600;
}
.form-row input,
.form-row select,
.form-row textarea {
  flex: 1;
  padding: 0.45rem 0.6rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 0.95rem;
}
textarea {
  resize: vertical;
  min-height: 56px;
}

/* SYMBOLER */
.symbols-row {
  display: flex;
  justify-content: center;
  gap: 14px;
  align-items: flex-start;
  margin: 0.5rem 0 0.25rem;
}
.symbol-stack {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 36px;
}
.symbol-stack .sym {
  font-size: 1.6rem;
  line-height: 1;
}
.symbol-stack input {
  margin-top: 0.25rem;
}

/* BUTTONS */
.button {
  background: var(--pink);
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 0.55rem 1.1rem;
  font-weight: 700;
  cursor: pointer;
}
.button:hover {
  background: var(--pink-hover);
}

/* TABELL */
.table-wrap {
  overflow-x: auto;
  margin-top: 1rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 0.9rem;
}
th, td {
  padding: 0.5rem 0.4rem;
  border: 1px solid #ddd;
  white-space: nowrap;
  text-align: center;
  vertical-align: middle;
}
thead th {
  background: #ffe5ec;
  color: #444;
  font-weight: 700;
}
tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}
tbody tr.mens-row {
  background-color: #ffe8ee !important;
}
tbody tr.ovulation-row {
  background-color: #fff9d9 !important;
}

/* TABELL-KOLUMNER */
td:nth-child(1), th:nth-child(1) { width: 85px; }
td:nth-child(2), th:nth-child(2) { width: 70px; }
td:nth-child(3), td:nth-child(4),
th:nth-child(3), th:nth-child(4) { width: 70px; }
td:nth-child(5), th:nth-child(5) { width: 85px; }
td:nth-child(6), th:nth-child(6) { width: 90px; font-size: 1.1rem; letter-spacing: 2px; }
td:nth-child(7), th:nth-child(7) { width: 150px; text-align: left; }

/* Knappar i tabellen */
td button {
  margin: 0 2px;
  border-radius: 6px;
  background: #f4b6c2;
  border: none;
  font-size: 0.8rem;
  padding: 0.3rem 0.6rem;
  cursor: pointer;
}
td button:hover {
  background: #e599ab;
}

/* === GRAF ‚Äì STABIL OCH LUFTIG === */
#chartContainer {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto;
  height: 420px;
}

.graph-wrapper {
  margin-left: -5px;
  margin-right: -5px;
}

#bbtChart {
  display: block;
  width: 100% !important;
  height: 100% !important;
}

/* Export-knappen */
.chart-toolbar {
  display: flex;
  justify-content: center;
  margin-top: 0.75rem;
}
/* ===== LH-FLIK ===== */
.lh-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.6rem;
  flex-wrap: wrap;
}

.lh-symbols-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.8rem;
  align-items: center;
}

.lh-symbol-checkbox {
  text-align: center;
  font-size: 1.25rem;
}
.lh-symbol-checkbox small {
  display: block;
  color: #777;
  font-size: 0.75rem;
}

.lh-preview {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin: 0.4rem 0;
  background: #fafafa;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 0.4rem;
}
.lh-img {
  width: 100%;
  max-height: 110px;
  object-fit: contain;
  border-radius: 8px;
  background: #fff;
}

.lh-row {
  display: flex;
  justify-content: space-between;
  gap: 0.6rem;
  padding: 0.45rem 0;
  border-bottom: 1px solid #eee;
}

/* ===== MOBIL ===== */
@media (max-width: 600px) {
  th, td {
    font-size: 0.8rem;
    padding: 0.35rem 0.25rem;
  }
  td:nth-child(7) {
    max-width: 90px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}

/* ‚Äî‚Äî‚Äî‚Äî‚Äî INFO-KNAPP (rosa, kvadratisk) ‚Äî‚Äî‚Äî‚Äî‚Äî */
.info-btn {
  position: absolute;
  top: -10px;
  right: -10px;

  width: 36px;
  height: 36px;
  border-radius: 10px;

  background: #f4b6c2;
  color: #000;
  font-weight: 900;
  font-size: 1.3rem;
  border: none;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;

  box-shadow: 0 2px 6px rgba(0,0,0,0.22);
  transition: 0.15s ease;
}
.info-btn:hover {
  background: #e599ab;
  transform: translateY(-1px);
}

/* ‚Äî‚Äî‚Äî‚Äî‚Äî Popup (legend) ‚Äî‚Äî‚Äî‚Äî‚Äî */
#legendPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 5000;
}

.legend-box {
  background: white;
  padding: 1.6rem 2rem;
  border-radius: 14px;
  max-width: 330px;
  width: 90%;
  box-shadow: 0 4px 22px rgba(0,0,0,0.25);
  animation: fadeIn 0.2s ease;
}

.legend-box h3 {
  margin-top: 0;
  text-align: center;
  color: #333;
  font-size: 1.25rem;
}

.legend-entry {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-size: 0.95rem;
  margin: 0.4rem 0;
}

/* F√§rgrutor i legend */
.legend-color {
  width: 20px;
  height: 8px;
  border-radius: 4px;
}

.legend-close {
  text-align: center;
  margin-top: 1.2rem;
}
.legend-close button {
  background: #f4b6c2;
  padding: 0.5rem 1.3rem;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to   { opacity: 1; transform: scale(1); }
}
</style>
</head>

<body>
<h1>BBT & LH</h1>

<div class="tabs">
  <button class="tab active" data-tab="inmatning">Inmatning & Tabell</button>
  <button class="tab" data-tab="graf">üìà Graf</button>
  <button class="tab" data-tab="lh">üß™ LH-test</button>
</div>

<!-- Inmatning -->
<div id="inmatning" class="tab-content active">
<!-- Graf -->
<div id="graf" class="tab-content">
  <div id="chartContainer" style="position:relative;">

    <!-- Info-knapp i √∂vre h√∂gra h√∂rnet -->
    <button id="infoBtn" class="info-btn">i</button>

    <canvas id="bbtChart"></canvas>
  </div>

  <div class="chart-toolbar">
    <button class="button" id="exportChartBtn">Exportera graf</button>
  </div>
</div>

<!-- Popup-legend -->
<div id="legendPopup">
  <div class="legend-box">

    <h3>F√∂rklaring</h3>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(90,140,255,0.9);"></div>
      <span>Bl√• linje ‚Äì Faktisk temperatur</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(240,100,120,0.85);"></div>
      <span>R√∂d prickad linje ‚Äì Korrigerad temperatur</span>
    </div>

    <div class="legend-entry">
      <div class="legend-color" style="background:rgba(195,215,180,0.45); height:10px;"></div>
      <span>Gr√∂n ton ‚Äì Medellinje f√∂re √§gglossning</span>
    </div>

    <hr style="margin:1rem 0;">

    <strong>Symboler:</strong>

    <div class="legend-entry">üíû ‚Äì Samlag</div>
    <div class="legend-entry">üåº ‚Äì √Ñgglossning</div>
    <div class="legend-entry">üíß ‚Äì Cervixsekret</div>
    <div class="legend-entry">‚ûï ‚Äì LH positiv</div>
    <div class="legend-entry">‚ûñ ‚Äì LH negativ</div>
    <div class="legend-entry">ü©∏ ‚Äì Mens</div>

    <div class="legend-close">
      <button id="legendCloseBtn">St√§ng</button>
    </div>

  </div>
</div>

<!-- LH-flik -->
<div id="lh" class="tab-content">
  <!-- (Inneh√•llet i LH-fliken √§r of√∂r√§ndrat) -->
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ============================
        TABS
  ============================ */
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.tab;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(id).classList.add("active");

      if (id === "graf") renderChart();
      if (id === "lh") renderLHList();
    });
  });


  /* ============================
        ELEMENTREFERENSER
  ============================ */
  const el = {
    date: document.getElementById("date"),
    time: document.getElementById("time"),
    actual: document.getElementById("actual"),
    corrected: document.getElementById("corrected"),
    note: document.getElementById("note"),

    symMens:  document.getElementById("symMens"),
    symSex:   document.getElementById("symSex"),
    symOv:    document.getElementById("symOv"),
    symMucus: document.getElementById("symMucus"),
    symLHpos: document.getElementById("symLHpos"),
    symLHneg: document.getElementById("symLHneg"),

    saveBtn: document.getElementById("saveBtn"),
    exportBtn: document.getElementById("exportBtn"),
    importBtn: document.getElementById("importBtn"),
    importFile: document.getElementById("importFile"),
    clearBtn: document.getElementById("clearBtn"),

    dataTableBody: document.querySelector("#dataTable tbody"),
    chartCanvas: document.getElementById("bbtChart"),
    exportChartBtn: document.getElementById("exportChartBtn"),

    lhPickBtn: document.getElementById("lhPickBtn"),
    lhFile: document.getElementById("lhFile"),
    lhDate: document.getElementById("lhDate"),
    lhNote: document.getElementById("lhNote"),
    lhSaveBtn: document.getElementById("lhSaveBtn"),
    lhList: document.getElementById("lhList"),
    lhFm: document.getElementById("lhFm"),
    lhEm: document.getElementById("lhEm"),
    lhPreview: document.getElementById("lhPreview"),
    lhPreviewImg: document.getElementById("lhPreviewImg"),
    lhPreviewInfo: document.getElementById("lhPreviewInfo"),
    lhSymChecks: () => Array.from(document.querySelectorAll(".lhSym:checked"))
  };

  /* ============================
        STATE
  ============================ */
  let dataEntries = JSON.parse(localStorage.getItem("bbtData") || "[]");
  let lhByDate = JSON.parse(localStorage.getItem("lhDataByDate") || "{}");
  let chart = null;


  /* ============================
        TEMPKORRIGERING
  ============================ */
  const minutesFrom0400 = (t) => {
    if (!t) return 0;
    const [h, m] = t.split(":").map(Number);
    return (h * 60 + m) - 240;
  };

  function computeCorrectedFrom(a, timeStr) {
    if (Number.isNaN(a)) return null;
    const mins = minutesFrom0400(timeStr || "04:00");
    return Number((a - 0.05 * (mins / 30)).toFixed(2));
  }

  function computeCorrectedFormInputs() {
    const a = parseFloat(el.actual.value);
    if (Number.isNaN(a)) return;
    const corr = computeCorrectedFrom(a, el.time.value);
    if (corr !== null) el.corrected.value = corr.toFixed(2);
  }


  /* ============================
        SPARA ENTRY
  ============================ */
  function saveEntry() {
    const e = {
      date: el.date.value,
      time: el.time.value,
      actual: el.actual.value ? Number(el.actual.value) : null,
      corrected: el.corrected.value ? Number(el.corrected.value) : null,

      mens: el.symMens.checked,
      sex: el.symSex.checked,
      ovulation: el.symOv.checked,
      mucus: el.symMucus.checked,
      lhPos: el.symLHpos.checked,
      lhNeg: el.symLHneg.checked,

      note: el.note.value || ""
    };

    if (!e.date) return alert("V√§lj datum f√∂rst.");

    const i = dataEntries.findIndex(x => x.date === e.date);
    if (i >= 0) dataEntries[i] = e;
    else dataEntries.push(e);

    localStorage.setItem("bbtData", JSON.stringify(dataEntries));
    renderTable();

    el.date.value = "";
    el.time.value = "";
    el.actual.value = "";
    el.corrected.value = "";
    el.note.value = "";

    el.symMens.checked = false;
    el.symSex.checked = false;
    el.symOv.checked = false;
    el.symMucus.checked = false;
    el.symLHpos.checked = false;
    el.symLHneg.checked = false;

    alert("‚úÖ Data sparad!");
  }


  /* ============================
        TABELL
  ============================ */
  function renderTable() {
    el.dataTableBody.innerHTML = "";
    dataEntries.sort((a, b) => a.date.localeCompare(b.date));

    dataEntries.forEach((e, idx) => {
      const tr = document.createElement("tr");

      if (e.mens) tr.style.backgroundColor = "#ffe8ee";
      if (e.ovulation) tr.classList.add("ovulation-row");

      let events = "";
      if (e.mens) events += "ü©∏ ";
      if (e.sex) events += "üíû ";
      if (e.ovulation) events += "üåº ";
      if (e.mucus) events += "üíß ";
      if (e.lhPos) events += "‚ûï ";
      if (e.lhNeg) events += "‚ûñ ";

      tr.innerHTML = `
        <td>${e.date || ""}</td>
        <td>${e.time || ""}</td>
        <td>${e.actual ?? ""}</td>
        <td>${e.corrected ?? ""}</td>
        <td>${events.trim() || "‚Äì"}</td>
        <td>${e.note || ""}</td>
        <td>
          <button class="table-btn small-edit">‚úèÔ∏è</button>
          <button class="table-btn small-del">üóëÔ∏è</button>
        </td>
      `;

      tr.querySelector(".small-edit").addEventListener("click", () => {
        el.date.value = e.date;
        el.time.value = e.time;
        el.actual.value = e.actual || "";
        el.corrected.value = e.corrected || "";
        el.note.value = e.note || "";

        el.symMens.checked = e.mens;
        el.symSex.checked = e.sex;
        el.symOv.checked = e.ovulation;
        el.symMucus.checked = e.mucus;
        el.symLHpos.checked = e.lhPos;
        el.symLHneg.checked = e.lhNeg;

        alert("Posten laddades f√∂r redigering.");
      });

      tr.querySelector(".small-del").addEventListener("click", () => {
        if (confirm(`Ta bort posten ${e.date}?`)) {
          dataEntries.splice(idx, 1);
          localStorage.setItem("bbtData", JSON.stringify(dataEntries));
          renderTable();
        }
      });

      el.dataTableBody.appendChild(tr);
    });
  }


  /* ============================
        GRAF
  ============================ */
  function renderChart() {

    if (chart) chart.destroy();

    dataEntries.sort((a, b) => a.date.localeCompare(b.date));

    const labels = dataEntries.map(e => {
      if (!e.date) return "";
      const [y, m, d] = e.date.split("-");
      return `${d}-${m}`;
    });

    const actual = dataEntries.map(e => e.actual);
    const corrected = dataEntries.map(e => e.corrected);

    // OV-index
    const ovIndex = dataEntries.findIndex(e => e.ovulation);

    const anns = [];

    // Mens bakgrund
    const mensIndices = dataEntries
      .map((e, i) => e.mens ? i : null)
      .filter(x => x !== null);

    if (mensIndices.length > 0) {
      anns.push({
        type: "box",
        xMin: mensIndices[0] - 0.5,
        xMax: mensIndices[mensIndices.length-1] + 0.5,
        backgroundColor: "rgba(244,182,194,0.55)",
        borderWidth: 0,
        drawTime: "beforeDatasetsDraw"
      });
    }

    // √Ñgglossning
    if (ovIndex >= 0) {
      anns.push({
        type: "box",
        xMin: ovIndex - 0.5,
        xMax: ovIndex + 0.5,
        backgroundColor: "rgba(255,244,176,0.65)",
        borderWidth: 0,
        drawTime: "beforeDatasetsDraw"
      });
    }

    // Lutealfas
    if (ovIndex >= 0 && ovIndex < dataEntries.length - 1) {
      anns.push({
        type: "box",
        xMin: ovIndex + 0.5,
        xMax: dataEntries.length - 0.5,
        backgroundColor: "rgba(224,195,252,0.6)",
        borderWidth: 0,
        drawTime: "beforeDatasetsDraw"
      });
    }

    // Medellinje (gr√∂nt band)
    const beforeOv = ovIndex >= 0 ? dataEntries.slice(0, ovIndex) : dataEntries;
    const vals = beforeOv.map(v => v.corrected).filter(v => v != null);

    let bandMin = null, bandMax = null;
    if (vals.length) {
      const mean = vals.reduce((a,b)=>a+b,0) / vals.length;
      bandMin = mean - 0.01;
      bandMax = mean + 0.01;
    }

    const bandData = vals.length ? new Array(dataEntries.length).fill(bandMax) : [];

    chart = new Chart(el.chartCanvas, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Medelspann f√∂re √§gglossning",
            data: bandData,
            borderWidth: 0,
            pointRadius: 0,
            fill: bandMin != null ? {
              target: { value: bandMin },
              above: "rgba(195,215,180,0.45)",
              below: "rgba(195,215,180,0.45)"
            } : false,
            spanGaps: true
          },
          {
            label: "Faktisk temperatur",
            data: actual,
            borderColor: "rgba(90,140,255,0.9)",
            backgroundColor: "rgba(90,140,255,0.9)",
            borderWidth: 2,
            pointRadius: 3,
            pointStyle: "circle",
            tension: 0.25,
            spanGaps: true
          },
          {
            label: "Korrigerad temperatur",
            data: corrected,
            borderColor: "rgba(240,100,120,0.85)",
            backgroundColor: "rgba(240,100,120,0.85)",
            borderDash: [4,3],
            borderWidth: 1.8,
            pointRadius: 3,
            pointStyle: "triangle",
            tension: 0.25,
            spanGaps: true
          }
        ]
      },

      options: {
        responsive: true,
        maintainAspectRatio: false,

        scales: {
          y: {
            min: Math.min(...corrected.filter(v => v!=null)) - 0.2,
            max: Math.max(...corrected.filter(v => v!=null)) + 0.15,
            ticks: {
              stepSize: 0.05,
              callback: v => Number(v).toFixed(2)
            }
          }
        },

        plugins: {
          legend: { display: false },
          annotation: { annotations: anns }
        }
      }
    });
  }


  /* ============================
        EXPORTERA GRAF
  ============================ */
  el.exportChartBtn.addEventListener("click", () => {
    const link = document.createElement("a");
    link.download = "BBT_graf.png";
    link.href = el.chartCanvas.toDataURL("image/png");
    link.click();
  });


  /* ============================
        INFO-PANEL (LEGEND)
  ============================ */
  const legendPopup = document.getElementById("legendPopup");
  document.getElementById("infoBtn").addEventListener("click", () => {
    legendPopup.style.display = "flex";
  });
  document.getElementById("legendCloseBtn").addEventListener("click", () => {
    legendPopup.style.display = "none";
  });
  legendPopup.addEventListener("click", e => {
    if (e.target === legendPopup) legendPopup.style.display = "none";
  });


  /* ============================
        INIT
  ============================ */
  el.actual.addEventListener("blur", computeCorrectedFormInputs);
  el.time.addEventListener("change", computeCorrectedFormInputs);
  el.saveBtn.addEventListener("click", saveEntry);

  renderTable();
  renderLHList();

});
</script>
</body>
</html>